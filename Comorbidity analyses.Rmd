---
title: "Lumi Comorbidities"
author: "Noelle"
date: "2024-07-10"
output: html_document
---
This document contains code used for the stratified analyses for different covariates and comorbidities. 

#Pooling all cohorts together
```{r setup, echo=FALSE}
library(boot)
library(cutpointr) 
library(pROC)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(openxlsx)
library(ggpubr)
lumi <- read.xlsx("POOLED_data.xlsx") #data was pooled for these analyses

lumi$ptau217_spec90 <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95 <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95 <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi.df <- lumi
```

#Figure 2 analyses: Effects of demographic factors and comorbidities on plasma p-tau217 (Lumipulse) performance. 

##Sex
###Boxplot sex
```{r boxplot sex, echo=F}
lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = pl_ptau217, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +   scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Males", "Females"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Males", "Females"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, by = 0.5)) +
  geom_hline(yintercept = 0.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 Lumipulse") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 3.0)

ggsave("Boxplot_sex.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")
```

###Analyses sex
```{r split by sex, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = sex)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

#AUC deLong
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <- round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

#Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_gender <- data.frame(
  Gender = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_gender) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)

##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone (redundant)
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_gender_n <- data.frame(
  Gender = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_gender_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons between groups, Accuracy 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons between groups, PPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons between groups, NPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_gender_2 <- data.frame(
  Gender = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_gender_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----
merged_gender <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Gender") #merge 2 dataframes
merged_gender$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_gender$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_gender$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))

openxlsx::write.xlsx(merged_gender,file="Fig2_Gender.xlsx", rowNames =T)

pvalues_gender <- rbind(
  pvals_gender,
  pvals_gender_n,
  pvals_gender_2
)
pvalues_gender <- pvalues_gender %>% drop_na()
pvalues_gender$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_gender,file="~Fig2_Gender_Pvalues.xlsx", rowNames =T)

```

##APOE

###Boxplot APOE
```{r boxplot APOE, echo=F}

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = pl_ptau217, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +  scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Non-carriers", "Carriers"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Non-carriers", "Carriers"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, by = 0.5)) +
  geom_hline(yintercept = 0.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 Lumipulse") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 3.0)

ggsave("Boxplot_APOE.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

###Analyses APOE
```{r split by APOE, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = apoe)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

##AUC differences with DeLong----
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <-round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)


##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")


# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_apoe <- data.frame(
  APOE = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_apoe) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)

##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone (redundant)
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_apoe_n <- data.frame(
  APOE = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_apoe_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons Accuracy 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_apoe_2 <- data.frame(
  APOE = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_apoe_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----
merged_apoe <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "APOE") #merge 2 dataframes
merged_apoe$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_apoe$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_apoe$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
openxlsx::write.xlsx(merged_apoe,file="Fig2_APOE_Pooled.xlsx", rowNames =T)

pvalues_apoe <- rbind(
  pvals_apoe,
  pvals_apoe_n,
  pvals_apoe_2
)
pvalues_apoe <- pvalues_apoe %>% drop_na()
pvalues_apoe$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_apoe,file="Fig2_APOE_Pvalues.xlsx", rowNames =T)

```

##Diabetes

###Boxplot Diabetes
```{r boxplot diabetes, echo=F}
lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = pl_ptau217, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +  scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Diabetes-", "Diabetes+"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Diabetes-", "Diabetes+"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, by = 0.5)) +
  geom_hline(yintercept = 0.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 Lumipulse") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 3.0)

ggsave("Boxplot_diabetes.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```


###Analayses Diabetes
```{r split by diabetes, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = diabetes)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

#AUC deLong
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <-round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")


# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_diabetes <- data.frame(
  Diabetes = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_diabetes) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)

##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone (redundant)
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_diabetes_n <- data.frame(
  Diabetes = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_diabetes_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons Accuracy 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_diabetes_2 <- data.frame(
  Diabetes = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_diabetes_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----
merged_diabetes <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Diabetes") #merge 2 dataframes
merged_diabetes$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_diabetes$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_diabetes$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
openxlsx::write.xlsx(merged_diabetes,file="Fig2_Diabetes_Pooled.xlsx", rowNames =T)

pvalues_diabetes <- rbind(
  pvals_diabetes,
  pvals_diabetes_n,
  pvals_diabetes_2
)
pvalues_diabetes <- pvalues_diabetes %>% drop_na()
pvalues_diabetes$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_diabetes,file="Fig2_Diabetes_Pvalues.xlsx", rowNames =T)

```

##CKD

###Boxplot CKD
```{r boxplot CKD, echo=F}
lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = pl_ptau217, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +    scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("CKD-", "CKD+"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("CKD-", "CKD+"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, by = 0.5)) +
  geom_hline(yintercept = 0.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 Lumipulse") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 3.0)

ggsave("Boxplot_CKD.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")
```

###Analyses CKD
```{r split by CKD, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = CKD)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

#AUC deLong
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <-round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)


##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")


# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_ckd <- data.frame(
  CKD = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_ckd) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)

##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone (redundant)
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_ckd_n <- data.frame(
  CKD = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_ckd_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons Accuracy 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_ckd_2 <- data.frame(
  CKD = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_ckd_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----

merged_CKD <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "CKD") #merge 2 dataframes
merged_CKD$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_CKD$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_CKD$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
openxlsx::write.xlsx(merged_CKD,file="Fig2_CKD_Pooled.xlsx", rowNames =T)

pvalues_ckd <- rbind(
  pvals_ckd,
  pvals_ckd_n,
  pvals_ckd_2
)
pvalues_ckd <- pvalues_ckd %>% drop_na()
pvalues_ckd$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_ckd,file="Fig2_
                     CKD_Pvalues_new.xlsx", rowNames =T)
```



##Education

###Boxplot Education
```{r boxplot Educ, echo=F}

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = pl_ptau217, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +    scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("< 10 years", "> 10 years"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("< 10 years", "> 10 years"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, by = 0.5)) +
  geom_hline(yintercept = 0.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 Lumipulse") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 3.0)

ggsave("Boxplot_Education.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

###Analyses Education
```{r split by education, echo=F}
lumi <- lumi.df
lumi$education_median <- ifelse(lumi$education < median(lumi$education, na.rm = TRUE), 0, 1)
lumi <- lumi %>% rename(strat = education_median)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

#AUC deLong
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <-round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

# Bootstrapped comparisons between Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_education <- data.frame(
  Education = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_education) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)


##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone (redundant)
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_education_n <- data.frame(
  Education = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_education_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons Accuracy 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV 2cp
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_education_2 <- data.frame(
  Education = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_education_2) <- c("Accuracy pval", "PPV pval", "NPV pval","DeLong pval",  "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----
merged_education <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Education") #merge 2 dataframes
merged_education$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_education$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_education$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
openxlsx::write.xlsx(merged_education,file="Fig2_Education_Pooled.xlsx", rowNames =T)

pvalues_education <- rbind(
  pvals_education,
  pvals_education_n,
  pvals_education_2
)
pvalues_education <- pvalues_education %>% drop_na()
pvalues_education$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_education,file="Fig2_Education_Pvalues.xlsx", rowNames =T)

```


##Age tertiles split

###Age boxplots 

```{r boxplot age, echo=F}
library(ggsignif)
lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

stat_test <- compare_means(pl_ptau217 ~ strat,  data = lumi, group.by = "csf_status", method="t.test")

my_comparisons <- list( c("2", "1"), c("2", "0"), c("1", "0"))
my_comparisons <- list( c("<73", "73-80"), c("<73", "> 80"), c("73-80", "> 80"))

mean(lumi.1$pl_ptau217[lumi.1$csf_status == 0])
mean(lumi.1$pl_ptau217[lumi.1$csf_status == 1])

mean(lumi.2$pl_ptau217[lumi.2$csf_status == 0])
mean(lumi.2$pl_ptau217[lumi.2$csf_status == 1])

mean(lumi.3$pl_ptau217[lumi.3$csf_status == 0])
mean(lumi.3$pl_ptau217[lumi.3$csf_status == 1])

stat_test$p.adj <- round(stat_test$p.adj,3)
stat_test$p <- round(stat_test$p,3)
lumi$group <- interaction(lumi$csf_status, lumi$strat)

ggplot(lumi, aes(x = csf_status, y = pl_ptau217, group = group)) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +   scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF", "#3C5488FF"), labels = c("<73", "73-80", "> 80"), name="Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF", "#3C5488FF"), guide = "none", labels = c("<73", "73-80", "> 80")) +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, by = 0.5)) +
  geom_hline(yintercept = 0.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 Lumipulse") +
  theme_classic()+
  stat_compare_means(label = "p.signif", method = "t.test", label.y=3.5)

ggsave("Boxplot_age.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")
stat_test
```

###Age analyses
```{r split by age, echo=F}
lumi <- lumi.df
lumi$age_category <- ifelse(lumi$age >= 80, 2, ifelse(lumi$age < median(lumi$age[lumi$age < 80], na.rm = TRUE), 0, 1)) 
lumi <- lumi %>% rename(strat = age_category)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)
lumi.3 <- lumi %>% filter(strat == 2)


##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve3 <- pROC::roc(csf_status~pl_ptau217, data=lumi.3, quiet=T)
coordinates3 <- coords(roc_curve3, x="all", transpose=F)
auc3 <- ci.auc(roc_curve3)[2]

#AUC deLong
results_delong12 <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong12 <-round(results_delong12$p.value,3)

results_delong23 <- roc.test(roc_curve2, roc_curve3, method = "delong")
pval_delong23 <-round(results_delong23$p.value,3)

results_delong13 <- roc.test(roc_curve1, roc_curve3, method = "delong")
pval_delong13 <-round(results_delong13$p.value,3)


##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  d3 <- d %>% filter(strat == 2)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  #Create confusion matrix3
  v_tp3=sum(d3$csf_status==1 & d3$ptau217_spec90==1)
  v_fp3=sum(d3$csf_status==0 & d3$ptau217_spec90==1)
  v_tn3=sum(d3$csf_status==0 & d3$ptau217_spec90==0)
  v_fn3=sum(d3$csf_status==1 & d3$ptau217_spec90==0)
  
  #Sensitivity and specificity3
  sens3 <- v_tp3 / (v_tp3 + v_fn3)
  spec3 <- v_tn3 / (v_tn3 + v_fp3)
  
  #Accuracy3
  acc3=(v_tp3+v_tn3)/(v_tp3+v_tn3+v_fn3+v_fp3)
  
  #Calculate PPV and NPV (cutpointr)3
  PPV3=ppv(tp = v_tp3,fp = v_fp3,
          tn = v_tn3,fn = v_fn3)
  
  NPV3=npv(tp = v_tp3,fp = v_fp3,
          tn = v_tn3,fn = v_fn3)
  
  #Differences 1-2
  diff_acc12 <- acc - acc2
  diff_ppv12 <- PPV - PPV2
  diff_npv12 <- NPV - NPV2
  
  #Differences 2-3
  diff_acc23 <- acc2 - acc3
  diff_ppv23 <- PPV2 - PPV3
  diff_npv23 <- NPV2 - NPV3
  
  #Differences 1-3
  diff_acc13 <- acc - acc3
  diff_ppv13 <- PPV - PPV3
  diff_npv13 <- NPV - NPV3
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, sens3, spec3, acc3, PPV3, NPV3,#15
           diff_acc12, diff_ppv12, diff_npv12, diff_acc23, diff_ppv23, diff_npv23,#21
           diff_acc13, diff_ppv13, diff_npv13))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3)[3],3),
  accuracy3 = round(boot_results$t0[13], 3),
  acc_ci_lower3 = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  acc_ci_upper3 = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  PPV3 = round(boot_results$t0[14], 3),
  ppv_ci_lower3 = round(quantile(boot_results$t[,14], c(0.025, 0.975))[1],3),
  ppv_ci_upper3 = round(quantile(boot_results$t[,14], c(0.025, 0.975))[2],3),
  NPV3 = round(boot_results$t0[15], 3),
  npv_ci_lower3 = round(quantile(boot_results$t[,15], c(0.025, 0.975))[1],3),
  npv_ci_upper3 = round(quantile(boot_results$t[,15], c(0.025, 0.975))[2],3),
  
  diff_acc12 = round(boot_results$t0[16], 3),
  diff_ppv12 = round(boot_results$t0[17], 3),
  diff_npv12 = round(boot_results$t0[18], 3),
  diff_acc23 = round(boot_results$t0[19], 3),
  diff_ppv23 = round(boot_results$t0[20], 3),
  diff_npv23 = round(boot_results$t0[21], 3),
  diff_acc13 = round(boot_results$t0[22], 3),
  diff_ppv13 = round(boot_results$t0[23], 3),
  diff_npv13 = round(boot_results$t0[24], 3),

  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  intermediate_n3 = NA,
  intermediate_cilow3 = NA,
  intermediate_cihigh3 = NA,
  intermediate_n_percentage3= NA,
  intermediate_n_percentage_low3= NA,
  intermediate_n_percentage_high3= NA,
  diff_n12 = NA,
  diff_nperc12 = NA,
  diff_n23 = NA,
  diff_nperc23 = NA,
  diff_n13 = NA,
  diff_nperc13 = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

bootstrap_replicates <- boot_results$t

#Categories 1-2
## Bootstrapped comparisons Accuracy 12
boot_accdiff12 <- boot_results$t0[16]
results_underH0_accdiff12 <- bootstrap_replicates[,16] - mean(bootstrap_replicates[,16])
boot_pvalue_accdiff12 <- mean(abs(results_underH0_accdiff12) >= abs(boot_accdiff12))

## Bootstrapped comparisons PPV 12
boot_ppvdiff12 <- boot_results$t0[17]
results_underH0_ppvdiff12 <- bootstrap_replicates[,17] - mean(bootstrap_replicates[,17])
boot_pvalue_ppvdiff12 <- mean(abs(results_underH0_ppvdiff12) >= abs(boot_ppvdiff12))

## Bootstrapped comparisons NPV 12 
boot_npvdiff12 <- boot_results$t0[18]
results_underH0_npvdiff12 <- bootstrap_replicates[,18] - mean(bootstrap_replicates[,18])
boot_pvalue_npvdiff12 <- mean(abs(results_underH0_npvdiff12) >= abs(boot_npvdiff12))

#Categories 2-3

## Bootstrapped comparisons Accuracy 23
boot_accdiff23 <- boot_results$t0[19]
results_underH0_accdiff23 <- bootstrap_replicates[,19] - mean(bootstrap_replicates[,19])
boot_pvalue_accdiff23 <- mean(abs(results_underH0_accdiff23) >= abs(boot_accdiff23))

## Bootstrapped comparisons PPV 23
boot_ppvdiff23 <- boot_results$t0[20]
results_underH0_ppvdiff23 <- bootstrap_replicates[,20] - mean(bootstrap_replicates[,20])
boot_pvalue_ppvdiff23 <- mean(abs(results_underH0_ppvdiff23) >= abs(boot_ppvdiff23))

## Bootstrapped comparisons NPV 23
boot_npvdiff23 <- boot_results$t0[21]
results_underH0_npvdiff23 <- bootstrap_replicates[,21] - mean(bootstrap_replicates[,21])
boot_pvalue_npvdiff23 <- mean(abs(results_underH0_npvdiff23) >= abs(boot_npvdiff23))

#Categories 1-3

# Bootstrapped comparisons Accuracy 13
boot_accdiff13 <- boot_results$t0[22]
results_underH0_accdiff13 <- bootstrap_replicates[,22] - mean(bootstrap_replicates[,22])
boot_pvalue_accdiff13 <- mean(abs(results_underH0_accdiff13) >= abs(boot_accdiff13))

# Bootstrapped comparisons PPV 13
boot_ppvdiff13 <- boot_results$t0[23]
results_underH0_ppvdiff13 <- bootstrap_replicates[,23] - mean(bootstrap_replicates[,23])
boot_pvalue_ppvdiff13 <- mean(abs(results_underH0_ppvdiff13) >= abs(boot_ppvdiff13))

# Bootstrapped comparisons NPV 13
boot_npvdiff13 <- boot_results$t0[24]
results_underH0_npvdiff13 <- bootstrap_replicates[,24] - mean(bootstrap_replicates[,24])
boot_pvalue_npvdiff13 <- mean(abs(results_underH0_npvdiff13) >= abs(boot_npvdiff13))

pvals_age <- data.frame(
  Age_12 = c(
    round(boot_pvalue_accdiff12, 3),
    round(boot_pvalue_ppvdiff12, 3),
    round(boot_pvalue_npvdiff12, 3),
    pval_delong12,
    NA,NA, NA, NA, NA),
  Age_23 = c(
    round(boot_pvalue_accdiff23, 3),
    round(boot_pvalue_ppvdiff23, 3),
    round(boot_pvalue_npvdiff23, 3),
    pval_delong23,
    NA,NA, NA, NA, NA),
  Age_13 = c(
    round(boot_pvalue_accdiff13, 3),
    round(boot_pvalue_ppvdiff13, 3),
    round(boot_pvalue_npvdiff13, 3),
    pval_delong13,
    NA,NA, NA, NA, NA))
rownames(pvals_age) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)

##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  d3 <- d %>% filter(strat == 2)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  intermediate_n3 <- length(which(d3$greyzone ==0))
  intermediate_npercent3 <- round((length(which(d3$greyzone == 0)) / nrow(d3)) * 100, 3)
  
  diff_intermediaten12 <- intermediate_n1 - intermediate_n2
  diff_percent12 <- intermediate_npercent1 - intermediate_npercent2
  
  diff_intermediaten23 <- intermediate_n2 - intermediate_n3
  diff_percent23 <- intermediate_npercent2 - intermediate_npercent3
  
  diff_intermediaten13 <- intermediate_n1 - intermediate_n3
  diff_percent13 <- intermediate_npercent1 - intermediate_npercent3
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,intermediate_npercent3,intermediate_n3, diff_intermediaten12,diff_percent12, diff_intermediaten23,diff_percent23, diff_intermediaten13,diff_percent13))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)
greyzone_CI3 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 6)
greyzone_percentage3 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 5)

bootstrap_replicates <- boot_results_greyzone$t

# Bootstrapped comparisons between #n greyzone 12
boot_ndiff12 <- boot_results_greyzone$t0[7]
results_underH0_ndiff12 <- bootstrap_replicates[,7] - mean(bootstrap_replicates[,7])
boot_pvalue_ndiff12 <- mean(abs(results_underH0_ndiff12) >= abs(boot_ndiff12))
boot_npercdiff12 <- boot_results_greyzone$t0[8]
results_underH0_npercdiff12 <- bootstrap_replicates[,8] - mean(bootstrap_replicates[,8])
boot_pvalue_npercdiff12 <- mean(abs(results_underH0_npercdiff12) >= abs(boot_npercdiff12))

# Bootstrapped comparisons between #n greyzone 23
boot_ndiff23 <- boot_results_greyzone$t0[9]
results_underH0_ndiff23 <- bootstrap_replicates[,9] - mean(bootstrap_replicates[,9])
boot_pvalue_ndiff23 <- mean(abs(results_underH0_ndiff23) >= abs(boot_ndiff23))
boot_npercdiff23 <- boot_results_greyzone$t0[10]
results_underH0_npercdiff23 <- bootstrap_replicates[,10] - mean(bootstrap_replicates[,10])
boot_pvalue_npercdiff23 <- mean(abs(results_underH0_npercdiff23) >= abs(boot_npercdiff23))

# Bootstrapped comparisons between #n greyzone 13
boot_ndiff13 <- boot_results_greyzone$t0[11]
results_underH0_ndiff13 <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_ndiff13 <- mean(abs(results_underH0_ndiff13) >= abs(boot_ndiff13))
boot_npercdiff13 <- boot_results_greyzone$t0[12]
results_underH0_npercdiff13 <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_npercdiff13 <- mean(abs(results_underH0_npercdiff13) >= abs(boot_npercdiff13))

pvals_age_n <- data.frame(
  Age_12 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff12, 3),
    round(boot_pvalue_npercdiff12, 3), NA, NA,NA),
  Age_23 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff23, 3),
    round(boot_pvalue_npercdiff23, 3), NA, NA,NA),
  Age_13 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff13, 3),
    round(boot_pvalue_npercdiff13, 3), NA, NA,NA))
rownames(pvals_age_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3)[3],3),
  accuracy3 = round(boot_results_twocutpoints$t0[13], 3),
  acc_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  acc_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  PPV3 = round(boot_results_twocutpoints$t0[14], 3),
  ppv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,14], c(0.025, 0.975))[1],3),
  ppv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,14], c(0.025, 0.975))[2],3),
  NPV3 = round(boot_results_twocutpoints$t0[15], 3),
  npv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,15], c(0.025, 0.975))[1],3),
  npv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,15], c(0.025, 0.975))[2],3),
  
  diff_acc12 = round(boot_results_twocutpoints$t0[16], 3),
  diff_ppv12 = round(boot_results_twocutpoints$t0[17], 3),
  diff_npv12 = round(boot_results_twocutpoints$t0[18], 3),
  diff_acc23 = round(boot_results_twocutpoints$t0[19], 3),
  diff_ppv23 = round(boot_results_twocutpoints$t0[20], 3),
  diff_npv23 = round(boot_results_twocutpoints$t0[21], 3),
  diff_acc13 = round(boot_results_twocutpoints$t0[22], 3),
  diff_ppv13 = round(boot_results_twocutpoints$t0[23], 3),
  diff_npv13 = round(boot_results_twocutpoints$t0[24], 3),
  
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  
  intermediate_n3 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow3 = round(greyzone_CI3$normal[,2],3),
  intermediate_cihigh3 =round(greyzone_CI3$normal[,3],3),
  intermediate_n_percentage3= round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low3= round(greyzone_percentage3$normal[,2],3),
  intermediate_n_percentage_high3= round(greyzone_percentage3$normal[,3],3),
  diff_n12 = round(boot_results_greyzone$t0[7],3),
  diff_nperc12 =  round(boot_results_greyzone$t0[8],3),
  diff_n23 = round(boot_results_greyzone$t0[9],3),
  diff_nperc23 = round(boot_results_greyzone$t0[10],3),
  diff_n13 = round(boot_results_greyzone$t0[11],3),
  diff_nperc13 = round(boot_results_greyzone$t0[12],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

bootstrap_replicates <- boot_results_twocutpoints$t

#Comparisons categories 1-2
boot_accdiff12_2 <- boot_results_twocutpoints$t0[16]
results_underH0_accdiff12_2 <- bootstrap_replicates[,16] - mean(bootstrap_replicates[,16])
boot_pvalue_accdiff12_2 <- mean(abs(results_underH0_accdiff12_2) >= abs(boot_accdiff12_2))
boot_ppvdiff12_2 <- boot_results_twocutpoints$t0[17]
results_underH0_ppvdiff12_2 <- bootstrap_replicates[,17] - mean(bootstrap_replicates[,17])
boot_pvalue_ppvdiff12_2 <- mean(abs(results_underH0_ppvdiff12_2) >= abs(boot_ppvdiff12_2))
boot_npvdiff12_2 <- boot_results_twocutpoints$t0[18]
results_underH0_npvdiff12_2 <- bootstrap_replicates[,18] - mean(bootstrap_replicates[,18])
boot_pvalue_npvdiff12_2 <- mean(abs(results_underH0_npvdiff12_2) >= abs(boot_npvdiff12_2))

#Comparisons categories 2-3
boot_accdiff23_2 <- boot_results_twocutpoints$t0[19]
results_underH0_accdiff23_2 <- bootstrap_replicates[,19] - mean(bootstrap_replicates[,19])
boot_pvalue_accdiff23_2 <- mean(abs(results_underH0_accdiff23_2) >= abs(boot_accdiff23_2))
boot_ppvdiff23_2 <- boot_results_twocutpoints$t0[20]
results_underH0_ppvdiff23_2 <- bootstrap_replicates[,20] - mean(bootstrap_replicates[,20])
boot_pvalue_ppvdiff23_2 <- mean(abs(results_underH0_ppvdiff23_2) >= abs(boot_ppvdiff23_2))
boot_npvdiff23_2 <- boot_results_twocutpoints$t0[21]
results_underH0_npvdiff23_2 <- bootstrap_replicates[,21] - mean(bootstrap_replicates[,21])
boot_pvalue_npvdiff23_2 <- mean(abs(results_underH0_npvdiff23_2) >= abs(boot_npvdiff23_2))

#Comparisons categories 1-3
boot_accdiff13_2 <- boot_results_twocutpoints$t0[22]
results_underH0_accdiff13_2 <- bootstrap_replicates[,22] - mean(bootstrap_replicates[,22])
boot_pvalue_accdiff13_2 <- mean(abs(results_underH0_accdiff13_2) >= abs(boot_accdiff13_2))
boot_ppvdiff13_2 <- boot_results_twocutpoints$t0[23]
results_underH0_ppvdiff13_2 <- bootstrap_replicates[,23] - mean(bootstrap_replicates[,23])
boot_pvalue_ppvdiff13_2 <- mean(abs(results_underH0_ppvdiff13_2) >= abs(boot_ppvdiff13_2))
boot_npvdiff13_2 <- boot_results_twocutpoints$t0[24]
results_underH0_npvdiff13_2 <- bootstrap_replicates[,24] - mean(bootstrap_replicates[,24])
boot_pvalue_npvdiff13_2 <- mean(abs(results_underH0_npvdiff13_2) >= abs(boot_npvdiff13_2))

pvals_age_2 <- data.frame(
  Age_12 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff12_2, 3),
    round(boot_pvalue_ppvdiff12_2, 3),
    round(boot_pvalue_npvdiff12_2, 3)),
    Age_23 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff23_2, 3),
    round(boot_pvalue_ppvdiff23_2, 3),
    round(boot_pvalue_npvdiff23_2, 3)),
    Age_13 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff13_2, 3),
    round(boot_pvalue_ppvdiff13_2, 3),
    round(boot_pvalue_npvdiff13_2, 3)))
rownames(pvals_age_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----

merged_age <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Age") #merge 2 dataframes
merged_age$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)

participants_g3 <- nrow(lumi.3)
participants_g3_csf0 <- sum(lumi.3$csf_status == 0)
participants_g3_csf1 <- sum(lumi.3$csf_status == 1)

merged_age$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_age$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
merged_age$G3 <- c(paste(participants_g3_csf0, "/", participants_g3_csf1), paste(participants_g3_csf0, "/", participants_g3_csf1))

openxlsx::write.xlsx(merged_age,file="Fig2_Age_Pooled.xlsx", rowNames =T)

pvalues_age <- rbind(
  pvals_age,
  pvals_age_n,
  pvals_age_2
)
pvalues_age <- pvalues_age %>% drop_na()
pvalues_age <- rbind(pvalues_age, pval_delong12, pval_delong13, pval_delong23)
rownames(pvalues_age)[rownames(pvalues_age) == "10"] <- "pval_delong12"
rownames(pvalues_age)[rownames(pvalues_age) == "11"] <- "pval_delong13"
rownames(pvalues_age)[rownames(pvalues_age) == "12"] <- "pval_delong23"
openxlsx::write.xlsx(pvalues_age,file="Fig2_Age_Pvalues.xlsx", rowNames =T)

```





Plots used in paper

##Figure 2 Plot

```{r load figure data, echo=F}

#Load datasets first and modify to make plotting easier

##Sex
merged_gender <- read_xlsx("Fig2_Gender.xlsx")
merged_gender <- merged_gender[,2:52]
group1_gender <- cbind(merged_gender[0:2, 1:12], merged_gender[0:2, 50:51]) #males
colnames(group1_gender) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high", "G1", "G2")
group1_gender$group <- "1"
group2_gender <- cbind(merged_gender[0:2, 13:24], merged_gender[0:2, 50:51]) #females
colnames(group2_gender) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high", "G1", "G2")
group2_gender$group <- "2"
merged_gender2 <- bind_rows(group1_gender, group2_gender)
merged_gender2$Cohort <- "Sex"
merged_gender2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

##Education
merged_education <- read_xlsx("Fig2_Education.xlsx")
merged_education <- merged_education[,2:52]
group1_education <- cbind(merged_education[0:2, 1:12], merged_education[0:2, 50:51])
colnames(group1_education) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high", "G1", "G2")
group1_education$group <- "1"
group2_education <- cbind(merged_education[0:2, 13:24], merged_education[0:2, 50:51])
colnames(group2_education) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group2_education$group <- "2"
merged_education2 <- bind_rows(group1_education, group2_education)
merged_education2$Cohort <- "Education"
merged_education2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

##CKD
merged_CKD <- read_xlsx("Fig2_CKD.xlsx")
merged_CKD <- merged_CKD[,2:52]
group1_CKD <- cbind(merged_CKD[0:2, 1:12], merged_CKD[0:2, 50:51])
colnames(group1_CKD) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group1_CKD$group <- "1"
group2_CKD <- cbind(merged_CKD[0:2, 13:24], merged_CKD[0:2, 50:51])
colnames(group2_CKD) <- c( "AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group2_CKD$group <- "2"
merged_CKD2 <- bind_rows(group1_CKD, group2_CKD)
merged_CKD2$Cohort <- "CKD"
merged_CKD2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

##Diabetes
merged_diabetes <- read_xlsx("Fig2_Diabetes.xlsx")
merged_diabetes <- merged_diabetes[,2:52]
group1_diabetes <- cbind(merged_diabetes[0:2, 1:12], merged_diabetes[0:2, 50:51])
colnames(group1_diabetes) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group1_diabetes$group <- "1"
group2_diabetes <- cbind(merged_diabetes[0:2, 13:24], merged_diabetes[0:2, 50:51])
colnames(group2_diabetes) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group2_diabetes$group <- "2"
merged_diabetes2 <- bind_rows(group1_diabetes, group2_diabetes)
merged_diabetes2$Cohort <- "Diabetes"
merged_diabetes2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

##APOE
merged_apoe <- read_xlsx("Fig2_APOE.xlsx")
merged_apoe <- merged_apoe[,2:52]
group1_apoe <- cbind(merged_apoe[0:2, 1:12], merged_apoe[0:2, 50:51])
colnames(group1_apoe) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group1_apoe$group <- "1"
group2_apoe <- cbind(merged_apoe[0:2, 13:24], merged_apoe[0:2, 50:51])
colnames(group2_apoe) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group2_apoe$group <- "2"
merged_apoe2 <- bind_rows(group1_apoe, group2_apoe)
merged_apoe2$Cohort <- "APOE"
merged_apoe2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

##Age
merged_age <- read_xlsx("Fig2_Age.xlsx")
merged_age <- merged_age[,2:75]
group1_age <- cbind(merged_age[0:2, 1:12], merged_age[0:2, 72:74])
colnames(group1_age) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2","G3")
group1_age$group <- "1"

group2_age <- cbind(merged_age[0:2, 13:24], merged_age[0:2, 72:74])
colnames(group2_age) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2","G3")
group2_age$group <- "2"

group3_age <- cbind(merged_age[0:2, 25:36], merged_age[0:2, 72:74])
colnames(group3_age) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2","G3")
group3_age$group <- "3"
merged_age2 <- bind_rows(group1_age, group2_age, group3_age)
merged_age2$Cohort <- "Age"
merged_age2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint", "1 Cutpoint", "2 Cutpoint")


plotdata <- bind_rows(merged_gender2, merged_education2, merged_CKD2,merged_diabetes2, merged_age2,merged_apoe2) 
openxlsx::write.xlsx(plotdata,file="Fig2_Plotdata.xlsx", rowNames =T)

```

##1cp
```{r accuracy 1 cutpoint, echo = F}
plotdata <- plotdata[grep("1 Cutpoint", plotdata$Cutpoint), ]
plotdata$modeltype <- factor(plotdata$group, levels = c(2,1))
desired_order <- c("Age", "Diabetes", "CKD", "Education", "APOE", "Sex")
group_order <- c("3", "2", "1")

y_labels <- c("Sex", "APOE", "Education", "CKD", "Diabetes", "Age")
line_df <- data.frame(
  y = factor(y_labels, levels = y_labels),
  label = y_labels
)

##Accuracy

ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = Accuracy * 100,
                          ymin = Accuracy_ci_low * 100,
                          ymax = Accuracy_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = Accuracy_ci_high * 100,ymin = Accuracy_ci_low * 100),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = Accuracy * 100,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(70,115),breaks = seq(70,115, by=10),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Accuracy*100, Accuracy_ci_low*100, Accuracy_ci_high*100), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 106, size = 3, color="black") +
  labs(title = element_blank(),x = element_blank(),y = "Accuracy (%)") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-1, face="bold"),
        axis.ticks.y = element_blank(),
        axis.title.x=element_text(face="bold"))

ggsave("Fig2_Accuracy1cp.pdf",device = "pdf",width = 90, dpi=500, height = 90, units = "mm")

##AUC

ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = AUC * 100,
                          ymin = AUC_ci_low * 100,
                          ymax = AUC_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = AUC_ci_high,ymin = AUC_ci_low),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = AUC,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(0.85,1.2),breaks = seq(0.85,1.2, by=.05),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.2f (%.2f-%.2f)", AUC, AUC_ci_low, AUC_ci_high), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 1.06, size = 3, color="black") +
  geom_text(aes(y = 1.17,label = ifelse(group == "1", sprintf("%s", G1),
                               ifelse(group == "2", sprintf("%s", G2), sprintf("%s", G3))),
                group = factor(group, levels = group_order)),
            position = position_dodge(width = 0.75), size = 3, color = "black") +
  labs(title = element_blank(),x = element_blank(),y = "AUC") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-2, face="bold"),
        axis.ticks.y = element_blank(),
        axis.title.x=element_text(face="bold"),
        plot.margin=unit(c(0.5, 1, 0.5, 0.5), "lines"))

ggsave("Fig2_AUC.pdf",device = "pdf",width = 100, dpi=500, height = 90, units = "mm")

```

##2cp

```{r figures 2 cutpoint, echo=F}

plotdata <- read.xlsx("~/Documents/Projects/LumiPulse/Lumi-MultiCohort/Results new/Fig4/Fig4_Plotdata_sensitivity.xlsx")
plotdata <- plotdata[grep("2 Cutpoint", plotdata$Cutpoint), ]

plotdata$modeltype <- factor(plotdata$group, levels = c(2,1))
group_order <- c("3", "2", "1")
desired_order <- c("Age", "Diabetes", "CKD", "Education", "APOE", "Sex")

##Accuracy
ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = Accuracy * 100,
                          ymin = Accuracy_ci_low * 100,
                          ymax = Accuracy_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = Accuracy_ci_high * 100,ymin = Accuracy_ci_low * 100),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = Accuracy * 100,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(70,115),breaks = seq(70,115, by=10),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Accuracy*100, Accuracy_ci_low*100, Accuracy_ci_high*100), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 106, size = 3, color="black") +
  labs(title = element_blank(),x = element_blank(),y = "Accuracy (%)") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-1, face="bold"),
        axis.ticks.y = element_blank(),
        axis.title.x=element_text(face="bold"))

ggsave("Fig2_Accuracy2cp.pdf",device = "pdf",width = 90, dpi=500, height = 90, units = "mm")

##Intermediates

#Alter data again for plotting
igroup1_gender <- merged_gender[0:2, 34:39]
colnames(igroup1_gender) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_gender$group <- "1"
igroup2_gender <- merged_gender[0:2, 40:45]
colnames(igroup2_gender) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_gender$group <- "2"
imerged_gender <- bind_rows(igroup1_gender, igroup2_gender)
imerged_gender$Cohort <- "Sex"
imerged_gender$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#Education
igroup1_education <- merged_education[0:2, 34:39]
colnames(igroup1_education) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_education$group <- "1"
igroup2_education <- merged_education[0:2, 40:45]
colnames(igroup2_education) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_education$group <- "2"
imerged_education <- bind_rows(igroup1_education, igroup2_education)
imerged_education$Cohort <- "Education"
imerged_education$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#CKD
igroup1_CKD <- merged_CKD[0:2, 34:39]
colnames(igroup1_CKD) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_CKD$group <- "1"
igroup2_CKD <- merged_CKD[0:2, 40:45]
colnames(igroup2_CKD) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_CKD$group <- "2"
imerged_CKD <- bind_rows(igroup1_CKD, igroup2_CKD)
imerged_CKD$Cohort <- "CKD"
imerged_CKD$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#Diabetes
igroup1_diabetes <- merged_diabetes[0:2, 34:39]
colnames(igroup1_diabetes) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_diabetes$group <- "1"
igroup2_diabetes <- merged_diabetes[0:2, 40:45]
colnames(igroup2_diabetes) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_diabetes$group <- "2"
imerged_diabetes <- bind_rows(igroup1_diabetes, igroup2_diabetes)
imerged_diabetes$Cohort <- "Diabetes"
imerged_diabetes$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#APOE
igroup1_apoe <- merged_apoe[0:2, 34:39]
colnames(igroup1_apoe) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_apoe$group <- "1"
igroup2_apoe <- merged_apoe[0:2, 40:45]
colnames(igroup2_apoe) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_apoe$group <- "2"
imerged_apoe <- bind_rows(igroup1_apoe, igroup2_apoe)
imerged_apoe$Cohort <- "APOE"
imerged_apoe$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#Age
igroup1_age <- merged_age[0:2, 46:51]
colnames(igroup1_age) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_age$group <- "1"
igroup2_age <- merged_age[0:2, 52:57]
colnames(igroup2_age) <-c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_age$group <- "2"
igroup3_age <- merged_age[0:2, 58:63]
colnames(igroup3_age) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup3_age$group <- "3"
imerged_age <- bind_rows(igroup1_age, igroup2_age, igroup3_age)
imerged_age$Cohort <- "Age"
imerged_age$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint", "1 Cutpoint", "2 Cutpoint")


plotdata_i <- bind_rows(imerged_gender, imerged_education, imerged_CKD,imerged_diabetes,imerged_apoe, imerged_age)
plotdata_i <- plotdata_i[grep("2 Cutpoint", plotdata_i$Cutpoint), ]

openxlsx::write.xlsx(plotdata_i,file="Fi2_plotdata_intermediate.xlsx", rowNames =T)


desired_order <- c("Sex", "APOE", "Education", "CKD", "Diabetes", "Age")
plotdata_i$modeltype <- factor(plotdata_i$group, levels = c(2,1))
group_order <- c("1", "2", "3")
group_colors <- c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF")

###Figure
ggplot(data = plotdata_i, aes(x = factor(Cohort, levels = desired_order), y = Intermediatep, fill = factor(group, levels = group_order))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), color = "black", width = 0.7, alpha=0.75, size=0.4) +
  geom_errorbar(aes(ymax = Intermediatep_ci_high, ymin = Intermediatep_ci_low),
                position = position_dodge(width = 0.7), width = 0.2, size = 0.5, color = "black") +
  geom_text(aes(label = sprintf("%.f", Intermediatep)), 
            position = position_dodge(width = 0.7), vjust = -3, size = 4) +
  scale_y_continuous(limits=c(0,30),breaks = seq(0,30, by=5),expand =c(0,0))+
  scale_fill_manual(values = group_colors, guide = "none") +
  labs(title = element_blank(), x = "", y = "Intermediate values (%)") +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 10, angle=45, hjust=1, face="bold"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(face = "bold", size = 10),
    panel.border = element_rect(linewidth = 0.5, fill = NA, color=NA))
ggsave("Fig2_Intermediates.pdf",device = "pdf",width = 70, dpi=500, height = 80, units = "mm")

```





#In primary care (Age only)

```{r setup PC, echo=FALSE}
library(boot)
library(cutpointr) #Used for PPV and NPV
library(pROC)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(openxlsx)
lumi <- read.xlsx("BFPC_data.xlsx")

lumi$ptau217_spec90 <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95 <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95 <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi.df <- lumi

lumi <- lumi.df
lumi$age_category <- ifelse(lumi$age >= 80, 2, ifelse(lumi$age < median(lumi$age[lumi$age < 80], na.rm = TRUE), 0, 1)) #73
lumi <- lumi %>% rename(strat = age_category)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)
lumi.3 <- lumi %>% filter(strat == 2)


##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve3 <- pROC::roc(csf_status~pl_ptau217, data=lumi.3, quiet=T)
coordinates3 <- coords(roc_curve3, x="all", transpose=F)
auc3 <- ci.auc(roc_curve3)[2]

#AUC deLong
results_delong12 <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong12 <-round(results_delong12$p.value,3)

results_delong23 <- roc.test(roc_curve2, roc_curve3, method = "delong")
pval_delong23 <-round(results_delong23$p.value,3)

results_delong13 <- roc.test(roc_curve1, roc_curve3, method = "delong")
pval_delong13 <-round(results_delong13$p.value,3)


##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  d3 <- d %>% filter(strat == 2)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  #Create confusion matrix3
  v_tp3=sum(d3$csf_status==1 & d3$ptau217_spec90==1)
  v_fp3=sum(d3$csf_status==0 & d3$ptau217_spec90==1)
  v_tn3=sum(d3$csf_status==0 & d3$ptau217_spec90==0)
  v_fn3=sum(d3$csf_status==1 & d3$ptau217_spec90==0)
  
  #Sensitivity and specificity3
  sens3 <- v_tp3 / (v_tp3 + v_fn3)
  spec3 <- v_tn3 / (v_tn3 + v_fp3)
  
  #Accuracy3
  acc3=(v_tp3+v_tn3)/(v_tp3+v_tn3+v_fn3+v_fp3)
  
  #Calculate PPV and NPV (cutpointr)3
  PPV3=ppv(tp = v_tp3,fp = v_fp3,
          tn = v_tn3,fn = v_fn3)
  
  NPV3=npv(tp = v_tp3,fp = v_fp3,
          tn = v_tn3,fn = v_fn3)
  
  #Differences 1-2
  diff_acc12 <- acc - acc2
  diff_ppv12 <- PPV - PPV2
  diff_npv12 <- NPV - NPV2
  
  #Differences 2-3
  diff_acc23 <- acc2 - acc3
  diff_ppv23 <- PPV2 - PPV3
  diff_npv23 <- NPV2 - NPV3
  
  #Differences 1-3
  diff_acc13 <- acc - acc3
  diff_ppv13 <- PPV - PPV3
  diff_npv13 <- NPV - NPV3
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, sens3, spec3, acc3, PPV3, NPV3,#15
           diff_acc12, diff_ppv12, diff_npv12, diff_acc23, diff_ppv23, diff_npv23,#21
           diff_acc13, diff_ppv13, diff_npv13))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3)[3],3),
  accuracy3 = round(boot_results$t0[13], 3),
  acc_ci_lower3 = round(quantile(boot_results$t[,13], c(0.025, 0.975), na.rm=T)[1],3),
  acc_ci_upper3 = round(quantile(boot_results$t[,13], c(0.025, 0.975), na.rm=T)[2],3),
  PPV3 = round(boot_results$t0[14], 3),
  ppv_ci_lower3 = round(quantile(boot_results$t[,14], c(0.025, 0.975), na.rm=T)[1],3),
  ppv_ci_upper3 = round(quantile(boot_results$t[,14], c(0.025, 0.975), na.rm=T)[2],3),
  NPV3 = round(boot_results$t0[15], 3),
  npv_ci_lower3 = round(quantile(boot_results$t[,15], c(0.025, 0.975), na.rm=T)[1],3),
  npv_ci_upper3 = round(quantile(boot_results$t[,15], c(0.025, 0.975), na.rm=T)[2],3),
  
  diff_acc12 = round(boot_results$t0[16], 3),
  diff_ppv12 = round(boot_results$t0[17], 3),
  diff_npv12 = round(boot_results$t0[18], 3),
  diff_acc23 = round(boot_results$t0[19], 3),
  diff_ppv23 = round(boot_results$t0[20], 3),
  diff_npv23 = round(boot_results$t0[21], 3),
  diff_acc13 = round(boot_results$t0[22], 3),
  diff_ppv13 = round(boot_results$t0[23], 3),
  diff_npv13 = round(boot_results$t0[24], 3),

  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  intermediate_n3 = NA,
  intermediate_cilow3 = NA,
  intermediate_cihigh3 = NA,
  intermediate_n_percentage3= NA,
  intermediate_n_percentage_low3= NA,
  intermediate_n_percentage_high3= NA,
  diff_n12 = NA,
  diff_nperc12 = NA,
  diff_n23 = NA,
  diff_nperc23 = NA,
  diff_n13 = NA,
  diff_nperc13 = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

bootstrap_replicates <- boot_results$t

#Categories 1-2
##Bootstrapped comparisons between 90% and Youden, Accuracy 12
boot_accdiff12 <- boot_results$t0[16]
results_underH0_accdiff12 <- bootstrap_replicates[,16] - mean(bootstrap_replicates[,16])
boot_pvalue_accdiff12 <- mean(abs(results_underH0_accdiff12) >= abs(boot_accdiff12))

##Bootstrapped comparisons between 90% and Youden, PPV 12
boot_ppvdiff12 <- boot_results$t0[17]
results_underH0_ppvdiff12 <- bootstrap_replicates[,17] - mean(bootstrap_replicates[,17])
boot_pvalue_ppvdiff12 <- mean(abs(results_underH0_ppvdiff12) >= abs(boot_ppvdiff12))

##Bootstrapped comparisons between 90% and Youden, NPV 12 
boot_npvdiff12 <- boot_results$t0[18]
results_underH0_npvdiff12 <- bootstrap_replicates[,18] - mean(bootstrap_replicates[,18])
boot_pvalue_npvdiff12 <- mean(abs(results_underH0_npvdiff12) >= abs(boot_npvdiff12))

#Categories 2-3
##Bootstrapped comparisons between 90% and Youden, Accuracy 23
boot_accdiff23 <- boot_results$t0[19]
results_underH0_accdiff23 <- bootstrap_replicates[,19] - mean(na.omit(bootstrap_replicates[,19]))
boot_pvalue_accdiff23 <- mean(na.omit(abs(results_underH0_accdiff23) >= abs(boot_accdiff23)))

##Bootstrapped comparisons between 90% and Youden, PPV 23
boot_ppvdiff23 <- boot_results$t0[20]
results_underH0_ppvdiff23 <- bootstrap_replicates[,20] - mean(na.omit(bootstrap_replicates[,20]))
boot_pvalue_ppvdiff23 <- mean(na.omit(abs(results_underH0_ppvdiff23) >= abs(boot_ppvdiff23)))

##Bootstrapped comparisons between 90% and Youden, NPV 23
boot_npvdiff23 <- boot_results$t0[21]
results_underH0_npvdiff23 <- bootstrap_replicates[,21] - mean(na.omit(bootstrap_replicates[,21]))
boot_pvalue_npvdiff23 <- mean(na.omit(abs(results_underH0_npvdiff23) >= abs(boot_npvdiff23)))

#Categories 1-3

##Bootstrapped comparisons Accuracy 13
boot_accdiff13 <- boot_results$t0[22]
results_underH0_accdiff13 <- bootstrap_replicates[,22] - mean(na.omit(bootstrap_replicates[,22]))
boot_pvalue_accdiff13 <- mean(na.omit(abs(results_underH0_accdiff13) >= abs(boot_accdiff13)))

##Bootstrapped comparisonsPPV 13
boot_ppvdiff13 <- boot_results$t0[23]
results_underH0_ppvdiff13 <- bootstrap_replicates[,23] - mean(na.omit(bootstrap_replicates[,23]))
boot_pvalue_ppvdiff13 <- mean(na.omit(abs(results_underH0_ppvdiff13) >= abs(boot_ppvdiff13)))

##Bootstrapped comparisons NPV 13
boot_npvdiff13 <- boot_results$t0[24]
results_underH0_npvdiff13 <- bootstrap_replicates[,24] - mean(na.omit(bootstrap_replicates[,24]))
boot_pvalue_npvdiff13 <- mean(na.omit(abs(results_underH0_npvdiff13) >= abs(boot_npvdiff13)))

pvals_age <- data.frame(
  Age_12 = c(
    round(boot_pvalue_accdiff12, 3),
    round(boot_pvalue_ppvdiff12, 3),
    round(boot_pvalue_npvdiff12, 3),
    pval_delong12,
    NA,NA, NA, NA, NA),
  Age_23 = c(
    round(boot_pvalue_accdiff23, 3),
    round(boot_pvalue_ppvdiff23, 3),
    round(boot_pvalue_npvdiff23, 3),
    pval_delong23,
    NA,NA, NA, NA, NA),
  Age_13 = c(
    round(boot_pvalue_accdiff13, 3),
    round(boot_pvalue_ppvdiff13, 3),
    round(boot_pvalue_npvdiff13, 3),
    pval_delong13,
    NA,NA, NA, NA, NA))
rownames(pvals_age) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)

##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  d3 <- d %>% filter(strat == 2)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  intermediate_n3 <- length(which(d3$greyzone ==0))
  intermediate_npercent3 <- round((length(which(d3$greyzone == 0)) / nrow(d3)) * 100, 3)
  
  diff_intermediaten12 <- intermediate_n1 - intermediate_n2
  diff_percent12 <- intermediate_npercent1 - intermediate_npercent2
  
  diff_intermediaten23 <- intermediate_n2 - intermediate_n3
  diff_percent23 <- intermediate_npercent2 - intermediate_npercent3
  
  diff_intermediaten13 <- intermediate_n1 - intermediate_n3
  diff_percent13 <- intermediate_npercent1 - intermediate_npercent3
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,intermediate_npercent3,intermediate_n3, diff_intermediaten12,diff_percent12, diff_intermediaten23,diff_percent23, diff_intermediaten13,diff_percent13))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)
greyzone_CI3 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 6)
greyzone_percentage3 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 5)

bootstrap_replicates <- boot_results_greyzone$t

# Bootstrapped comparisons between #n greyzone 12
boot_ndiff12 <- boot_results_greyzone$t0[7]
results_underH0_ndiff12 <- bootstrap_replicates[,7] - mean(bootstrap_replicates[,7])
boot_pvalue_ndiff12 <- mean(abs(results_underH0_ndiff12) >= abs(boot_ndiff12))
boot_npercdiff12 <- boot_results_greyzone$t0[8]
results_underH0_npercdiff12 <- bootstrap_replicates[,8] - mean(bootstrap_replicates[,8])
boot_pvalue_npercdiff12 <- mean(abs(results_underH0_npercdiff12) >= abs(boot_npercdiff12))

# Bootstrapped comparisons between #n greyzone 23
boot_ndiff23 <- boot_results_greyzone$t0[9]
results_underH0_ndiff23 <- bootstrap_replicates[,9] - mean(bootstrap_replicates[,9])
boot_pvalue_ndiff23 <- mean(abs(results_underH0_ndiff23) >= abs(boot_ndiff23))
boot_npercdiff23 <- boot_results_greyzone$t0[10]
results_underH0_npercdiff23 <- bootstrap_replicates[,10] - mean(na.omit(bootstrap_replicates[,10]))
boot_pvalue_npercdiff23 <- mean(na.omit(abs(results_underH0_npercdiff23) >= abs(boot_npercdiff23)))

# Bootstrapped comparisons between #n greyzone 13
boot_ndiff13 <- boot_results_greyzone$t0[11]
results_underH0_ndiff13 <- bootstrap_replicates[,11] - mean(na.omit(bootstrap_replicates[,11]))
boot_pvalue_ndiff13 <- mean(na.omit(abs(results_underH0_ndiff13) >= abs(boot_ndiff13)))
boot_npercdiff13 <- boot_results_greyzone$t0[12]
results_underH0_npercdiff13 <- bootstrap_replicates[,12] - mean(na.omit(bootstrap_replicates[,12]))
boot_pvalue_npercdiff13 <- mean(na.omit(abs(results_underH0_npercdiff13) >= abs(boot_npercdiff13)))

pvals_age_n <- data.frame(
  Age_12 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff12, 3),
    round(boot_pvalue_npercdiff12, 3), NA, NA,NA),
  Age_23 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff23, 3),
    round(boot_pvalue_npercdiff23, 3), NA, NA,NA),
  Age_13 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff13, 3),
    round(boot_pvalue_npercdiff13, 3), NA, NA,NA))
rownames(pvals_age_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3)[3],3),
  accuracy3 = round(boot_results_twocutpoints$t0[13], 3),
  acc_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975), na.rm=T)[1],3),
  acc_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975), na.rm=T)[2],3),
  PPV3 = round(boot_results_twocutpoints$t0[14], 3),
  ppv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,14], c(0.025, 0.975), na.rm=T)[1],3),
  ppv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,14], c(0.025, 0.975), na.rm=T)[2],3),
  NPV3 = round(boot_results_twocutpoints$t0[15], 3),
  npv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,15], c(0.025, 0.975), na.rm=T)[1],3),
  npv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,15], c(0.025, 0.975), na.rm=T)[2],3),
  
  diff_acc12 = round(boot_results_twocutpoints$t0[16], 3),
  diff_ppv12 = round(boot_results_twocutpoints$t0[17], 3),
  diff_npv12 = round(boot_results_twocutpoints$t0[18], 3),
  diff_acc23 = round(boot_results_twocutpoints$t0[19], 3),
  diff_ppv23 = round(boot_results_twocutpoints$t0[20], 3),
  diff_npv23 = round(boot_results_twocutpoints$t0[21], 3),
  diff_acc13 = round(boot_results_twocutpoints$t0[22], 3),
  diff_ppv13 = round(boot_results_twocutpoints$t0[23], 3),
  diff_npv13 = round(boot_results_twocutpoints$t0[24], 3),
  
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  
  intermediate_n3 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow3 = round(greyzone_CI3$normal[,2],3),
  intermediate_cihigh3 =round(greyzone_CI3$normal[,3],3),
  intermediate_n_percentage3= round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low3= round(greyzone_percentage3$normal[,2],3),
  intermediate_n_percentage_high3= round(greyzone_percentage3$normal[,3],3),
  diff_n12 = round(boot_results_greyzone$t0[7],3),
  diff_nperc12 =  round(boot_results_greyzone$t0[8],3),
  diff_n23 = round(boot_results_greyzone$t0[9],3),
  diff_nperc23 = round(boot_results_greyzone$t0[10],3),
  diff_n13 = round(boot_results_greyzone$t0[11],3),
  diff_nperc13 = round(boot_results_greyzone$t0[12],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

bootstrap_replicates <- boot_results_twocutpoints$t
# Bootstrapped comparisons Accuracy12
boot_accdiff12_2 <- boot_results_twocutpoints$t0[16]
results_underH0_accdiff12_2 <- bootstrap_replicates[,16] - mean(bootstrap_replicates[,16])
boot_pvalue_accdiff12_2 <- mean(abs(results_underH0_accdiff12_2) >= abs(boot_accdiff12_2))
boot_ppvdiff12_2 <- boot_results_twocutpoints$t0[17]
results_underH0_ppvdiff12_2 <- bootstrap_replicates[,17] - mean(bootstrap_replicates[,17])
boot_pvalue_ppvdiff12_2 <- mean(abs(results_underH0_ppvdiff12_2) >= abs(boot_ppvdiff12_2))
boot_npvdiff12_2 <- boot_results_twocutpoints$t0[18]
results_underH0_npvdiff12_2 <- bootstrap_replicates[,18] - mean(bootstrap_replicates[,18])
boot_pvalue_npvdiff12_2 <- mean(abs(results_underH0_npvdiff12_2) >= abs(boot_npvdiff12_2))

# Bootstrapped comparisons Accuracy23
boot_accdiff23_2 <- boot_results_twocutpoints$t0[19]
results_underH0_accdiff23_2 <- bootstrap_replicates[,19] - mean(na.omit(bootstrap_replicates[,19]))
boot_pvalue_accdiff23_2 <- mean(na.omit(abs(results_underH0_accdiff23_2) >= abs(boot_accdiff23_2)))
boot_ppvdiff23_2 <- boot_results_twocutpoints$t0[20]
results_underH0_ppvdiff23_2 <- bootstrap_replicates[,20] - mean(na.omit(bootstrap_replicates[,20]))
boot_pvalue_ppvdiff23_2 <- mean(na.omit(abs(results_underH0_ppvdiff23_2) >= abs(boot_ppvdiff23_2)))
boot_npvdiff23_2 <- boot_results_twocutpoints$t0[21]
results_underH0_npvdiff23_2 <- bootstrap_replicates[,21] - mean(na.omit(bootstrap_replicates[,21]))
boot_pvalue_npvdiff23_2 <- mean(na.omit(abs(results_underH0_npvdiff23_2) >= abs(boot_npvdiff23_2)))

# Bootstrapped comparisons Accuracy13
boot_accdiff13_2 <- boot_results_twocutpoints$t0[22]
results_underH0_accdiff13_2 <- bootstrap_replicates[,22] - mean(na.omit(bootstrap_replicates[,22]))
boot_pvalue_accdiff13_2 <- mean(na.omit(abs(results_underH0_accdiff13_2) >= abs(boot_accdiff13_2)))
boot_ppvdiff13_2 <- boot_results_twocutpoints$t0[23]
results_underH0_ppvdiff13_2 <- bootstrap_replicates[,23] - mean(na.omit(bootstrap_replicates[,23]))
boot_pvalue_ppvdiff13_2 <- mean(na.omit(abs(results_underH0_ppvdiff13_2) >= abs(boot_ppvdiff13_2)))
boot_npvdiff13_2 <- boot_results_twocutpoints$t0[24]
results_underH0_npvdiff13_2 <- bootstrap_replicates[,24] - mean(na.omit(bootstrap_replicates[,24]))
boot_pvalue_npvdiff13_2 <- mean(na.omit(abs(results_underH0_npvdiff13_2) >= abs(boot_npvdiff13_2)))

pvals_age_2 <- data.frame(
  Age_12 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff12_2, 3),
    round(boot_pvalue_ppvdiff12_2, 3),
    round(boot_pvalue_npvdiff12_2, 3)),
    Age_23 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff23_2, 3),
    round(boot_pvalue_ppvdiff23_2, 3),
    round(boot_pvalue_npvdiff23_2, 3)),
    Age_13 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff13_2, 3),
    round(boot_pvalue_ppvdiff13_2, 3),
    round(boot_pvalue_npvdiff13_2, 3)))
rownames(pvals_age_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----

merged_age <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Age") #merge 2 dataframes
merged_age$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)

participants_g3 <- nrow(lumi.3)
participants_g3_csf0 <- sum(lumi.3$csf_status == 0)
participants_g3_csf1 <- sum(lumi.3$csf_status == 1)

merged_age$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_age$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
merged_age$G3 <- c(paste(participants_g3_csf0, "/", participants_g3_csf1), paste(participants_g3_csf0, "/", participants_g3_csf1))

openxlsx::write.xlsx(merged_age,file="Age_PC.xlsx", rowNames =T)

pvalues_age <- rbind(
  pvals_age,
  pvals_age_n,
  pvals_age_2
)
pvalues_age <- pvalues_age %>% drop_na()
pvalues_age <- rbind(pvalues_age, pval_delong12, pval_delong13, pval_delong23)
rownames(pvalues_age)[rownames(pvalues_age) == "10"] <- "pval_delong12"
rownames(pvalues_age)[rownames(pvalues_age) == "11"] <- "pval_delong13"
rownames(pvalues_age)[rownames(pvalues_age) == "12"] <- "pval_delong23"
openxlsx::write.xlsx(pvalues_age,file="Age_Pvalues_PC.xlsx", rowNames =T)

```

#In Secondary care (Age only)

```{r pool secondary care data, eval=FALSE, include=FALSE}
library(readxl)
BFMC <- read.xlsx("BFMC_data.xlsx")
BBRC <- read.xlsx("BBRC_data.xlsx")
Brescia <- read.xlsx("Brescia_data.xlsx")
Gothenburg <- read.xlsx("Gothenburg_data.xlsx")
pooled <- rbind(BFMC, BBRC, Brescia, Gothenburg)
```

```{r split by age (change for cohort), echo=F}

lumi <- X #change for the right dataset, make sure to change document title in the end
lumi.df <- lumi

lumi <- lumi.df
lumi$age_category <- ifelse(lumi$age >= 80, 2, ifelse(lumi$age < median(lumi$age[lumi$age < 80], na.rm = TRUE), 0, 1)) #73
lumi <- lumi %>% rename(strat = age_category)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)
lumi.3 <- lumi %>% filter(strat == 2)


##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve3 <- pROC::roc(csf_status~pl_ptau217, data=lumi.3, quiet=T)
coordinates3 <- coords(roc_curve3, x="all", transpose=F)
auc3 <- ci.auc(roc_curve3)[2]

#AUC deLong
results_delong12 <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong12 <-round(results_delong12$p.value,3)

results_delong23 <- roc.test(roc_curve2, roc_curve3, method = "delong")
pval_delong23 <-round(results_delong23$p.value,3)

results_delong13 <- roc.test(roc_curve1, roc_curve3, method = "delong")
pval_delong13 <-round(results_delong13$p.value,3)


##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  d3 <- d %>% filter(strat == 2)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  #Create confusion matrix3
  v_tp3=sum(d3$csf_status==1 & d3$ptau217_spec90==1)
  v_fp3=sum(d3$csf_status==0 & d3$ptau217_spec90==1)
  v_tn3=sum(d3$csf_status==0 & d3$ptau217_spec90==0)
  v_fn3=sum(d3$csf_status==1 & d3$ptau217_spec90==0)
  
  #Sensitivity and specificity3
  sens3 <- v_tp3 / (v_tp3 + v_fn3)
  spec3 <- v_tn3 / (v_tn3 + v_fp3)
  
  #Accuracy3
  acc3=(v_tp3+v_tn3)/(v_tp3+v_tn3+v_fn3+v_fp3)
  
  #Calculate PPV and NPV (cutpointr)3
  PPV3=ppv(tp = v_tp3,fp = v_fp3,
          tn = v_tn3,fn = v_fn3)
  
  NPV3=npv(tp = v_tp3,fp = v_fp3,
          tn = v_tn3,fn = v_fn3)
  
  #Differences 1-2
  diff_acc12 <- acc - acc2
  diff_ppv12 <- PPV - PPV2
  diff_npv12 <- NPV - NPV2
  
  #Differences 2-3
  diff_acc23 <- acc2 - acc3
  diff_ppv23 <- PPV2 - PPV3
  diff_npv23 <- NPV2 - NPV3
  
  #Differences 1-3
  diff_acc13 <- acc - acc3
  diff_ppv13 <- PPV - PPV3
  diff_npv13 <- NPV - NPV3
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, sens3, spec3, acc3, PPV3, NPV3,#15
           diff_acc12, diff_ppv12, diff_npv12, diff_acc23, diff_ppv23, diff_npv23,#21
           diff_acc13, diff_ppv13, diff_npv13))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)


##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3)[3],3),
  accuracy3 = round(boot_results$t0[13], 3),
  acc_ci_lower3 = round(quantile(boot_results$t[,13], c(0.025, 0.975), na.rm=T)[1],3),
  acc_ci_upper3 = round(quantile(boot_results$t[,13], c(0.025, 0.975), na.rm=T)[2],3),
  PPV3 = round(boot_results$t0[14], 3),
  ppv_ci_lower3 = round(quantile(boot_results$t[,14], c(0.025, 0.975), na.rm=T)[1],3),
  ppv_ci_upper3 = round(quantile(boot_results$t[,14], c(0.025, 0.975), na.rm=T)[2],3),
  NPV3 = round(boot_results$t0[15], 3),
  npv_ci_lower3 = round(quantile(boot_results$t[,15], c(0.025, 0.975), na.rm=T)[1],3),
  npv_ci_upper3 = round(quantile(boot_results$t[,15], c(0.025, 0.975), na.rm=T)[2],3),
  
  diff_acc12 = round(boot_results$t0[16], 3),
  diff_ppv12 = round(boot_results$t0[17], 3),
  diff_npv12 = round(boot_results$t0[18], 3),
  diff_acc23 = round(boot_results$t0[19], 3),
  diff_ppv23 = round(boot_results$t0[20], 3),
  diff_npv23 = round(boot_results$t0[21], 3),
  diff_acc13 = round(boot_results$t0[22], 3),
  diff_ppv13 = round(boot_results$t0[23], 3),
  diff_npv13 = round(boot_results$t0[24], 3),

  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  intermediate_n3 = NA,
  intermediate_cilow3 = NA,
  intermediate_cihigh3 = NA,
  intermediate_n_percentage3= NA,
  intermediate_n_percentage_low3= NA,
  intermediate_n_percentage_high3= NA,
  diff_n12 = NA,
  diff_nperc12 = NA,
  diff_n23 = NA,
  diff_nperc23 = NA,
  diff_n13 = NA,
  diff_nperc13 = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

bootstrap_replicates <- boot_results$t

##Categories 1-2
# Bootstrapped comparisons between 90% and Youden, Accuracy 12
boot_accdiff12 <- boot_results$t0[16]
results_underH0_accdiff12 <- bootstrap_replicates[,16] - mean(bootstrap_replicates[,16])
boot_pvalue_accdiff12 <- mean(abs(results_underH0_accdiff12) >= abs(boot_accdiff12))

# Bootstrapped comparisons between 90% and Youden, PPV 12
boot_ppvdiff12 <- boot_results$t0[17]
results_underH0_ppvdiff12 <- bootstrap_replicates[,17] - mean(bootstrap_replicates[,17])
boot_pvalue_ppvdiff12 <- mean(abs(results_underH0_ppvdiff12) >= abs(boot_ppvdiff12))

# Bootstrapped comparisons between 90% and Youden, NPV 12 
boot_npvdiff12 <- boot_results$t0[18]
results_underH0_npvdiff12 <- bootstrap_replicates[,18] - mean(bootstrap_replicates[,18])
boot_pvalue_npvdiff12 <- mean(abs(results_underH0_npvdiff12) >= abs(boot_npvdiff12))

##Categories 2-3
# Bootstrapped comparisons between 90% and Youden, Accuracy 23
boot_accdiff23 <- boot_results$t0[19]
results_underH0_accdiff23 <- bootstrap_replicates[,19] - mean(na.omit(bootstrap_replicates[,19]))
boot_pvalue_accdiff23 <- mean(na.omit(abs(results_underH0_accdiff23) >= abs(boot_accdiff23)))

# Bootstrapped comparisons between 90% and Youden, PPV 23
boot_ppvdiff23 <- boot_results$t0[20]
results_underH0_ppvdiff23 <- bootstrap_replicates[,20] - mean(na.omit(bootstrap_replicates[,20]))
boot_pvalue_ppvdiff23 <- mean(na.omit(abs(results_underH0_ppvdiff23) >= abs(boot_ppvdiff23)))

# Bootstrapped comparisons between 90% and Youden, NPV 23
boot_npvdiff23 <- boot_results$t0[21]
results_underH0_npvdiff23 <- bootstrap_replicates[,21] - mean(na.omit(bootstrap_replicates[,21]))
boot_pvalue_npvdiff23 <- mean(na.omit(abs(results_underH0_npvdiff23) >= abs(boot_npvdiff23)))

##Categories 1-3

# Bootstrapped comparisons Accuracy 13
boot_accdiff13 <- boot_results$t0[22]
results_underH0_accdiff13 <- bootstrap_replicates[,22] - mean(na.omit(bootstrap_replicates[,22]))
boot_pvalue_accdiff13 <- mean(na.omit(abs(results_underH0_accdiff13) >= abs(boot_accdiff13)))

# Bootstrapped comparisonsPPV 13
boot_ppvdiff13 <- boot_results$t0[23]
results_underH0_ppvdiff13 <- bootstrap_replicates[,23] - mean(na.omit(bootstrap_replicates[,23]))
boot_pvalue_ppvdiff13 <- mean(na.omit(abs(results_underH0_ppvdiff13) >= abs(boot_ppvdiff13)))

# Bootstrapped comparisons NPV 13
boot_npvdiff13 <- boot_results$t0[24]
results_underH0_npvdiff13 <- bootstrap_replicates[,24] - mean(na.omit(bootstrap_replicates[,24]))
boot_pvalue_npvdiff13 <- mean(na.omit(abs(results_underH0_npvdiff13) >= abs(boot_npvdiff13)))

pvals_age <- data.frame(
  Age_12 = c(
    round(boot_pvalue_accdiff12, 3),
    round(boot_pvalue_ppvdiff12, 3),
    round(boot_pvalue_npvdiff12, 3),
    pval_delong12,
    NA,NA, NA, NA, NA),
  Age_23 = c(
    round(boot_pvalue_accdiff23, 3),
    round(boot_pvalue_ppvdiff23, 3),
    round(boot_pvalue_npvdiff23, 3),
    pval_delong23,
    NA,NA, NA, NA, NA),
  Age_13 = c(
    round(boot_pvalue_accdiff13, 3),
    round(boot_pvalue_ppvdiff13, 3),
    round(boot_pvalue_npvdiff13, 3),
    pval_delong13,
    NA,NA, NA, NA, NA))
rownames(pvals_age) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)

##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  d3 <- d %>% filter(strat == 2)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  intermediate_n3 <- length(which(d3$greyzone ==0))
  intermediate_npercent3 <- round((length(which(d3$greyzone == 0)) / nrow(d3)) * 100, 3)
  
  diff_intermediaten12 <- intermediate_n1 - intermediate_n2
  diff_percent12 <- intermediate_npercent1 - intermediate_npercent2
  
  diff_intermediaten23 <- intermediate_n2 - intermediate_n3
  diff_percent23 <- intermediate_npercent2 - intermediate_npercent3
  
  diff_intermediaten13 <- intermediate_n1 - intermediate_n3
  diff_percent13 <- intermediate_npercent1 - intermediate_npercent3
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,intermediate_npercent3,intermediate_n3, diff_intermediaten12,diff_percent12, diff_intermediaten23,diff_percent23, diff_intermediaten13,diff_percent13))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)
greyzone_CI3 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 6)
greyzone_percentage3 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 5)

bootstrap_replicates <- boot_results_greyzone$t

# Bootstrapped comparisons between #n greyzone 12
boot_ndiff12 <- boot_results_greyzone$t0[7]
results_underH0_ndiff12 <- bootstrap_replicates[,7] - mean(bootstrap_replicates[,7])
boot_pvalue_ndiff12 <- mean(abs(results_underH0_ndiff12) >= abs(boot_ndiff12))
boot_npercdiff12 <- boot_results_greyzone$t0[8]
results_underH0_npercdiff12 <- bootstrap_replicates[,8] - mean(bootstrap_replicates[,8])
boot_pvalue_npercdiff12 <- mean(abs(results_underH0_npercdiff12) >= abs(boot_npercdiff12))

# Bootstrapped comparisons between #n greyzone 23
boot_ndiff23 <- boot_results_greyzone$t0[9]
results_underH0_ndiff23 <- bootstrap_replicates[,9] - mean(bootstrap_replicates[,9])
boot_pvalue_ndiff23 <- mean(abs(results_underH0_ndiff23) >= abs(boot_ndiff23))
boot_npercdiff23 <- boot_results_greyzone$t0[10]
results_underH0_npercdiff23 <- bootstrap_replicates[,10] - mean(na.omit(bootstrap_replicates[,10]))
boot_pvalue_npercdiff23 <- mean(na.omit(abs(results_underH0_npercdiff23) >= abs(boot_npercdiff23)))

# Bootstrapped comparisons between #n greyzone 13
boot_ndiff13 <- boot_results_greyzone$t0[11]
results_underH0_ndiff13 <- bootstrap_replicates[,11] - mean(na.omit(bootstrap_replicates[,11]))
boot_pvalue_ndiff13 <- mean(na.omit(abs(results_underH0_ndiff13) >= abs(boot_ndiff13)))
boot_npercdiff13 <- boot_results_greyzone$t0[12]
results_underH0_npercdiff13 <- bootstrap_replicates[,12] - mean(na.omit(bootstrap_replicates[,12]))
boot_pvalue_npercdiff13 <- mean(na.omit(abs(results_underH0_npercdiff13) >= abs(boot_npercdiff13)))

pvals_age_n <- data.frame(
  Age_12 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff12, 3),
    round(boot_pvalue_npercdiff12, 3), NA, NA,NA),
  Age_23 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff23, 3),
    round(boot_pvalue_npercdiff23, 3), NA, NA,NA),
  Age_13 = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff13, 3),
    round(boot_pvalue_npercdiff13, 3), NA, NA,NA))
rownames(pvals_age_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3)[3],3),
  accuracy3 = round(boot_results_twocutpoints$t0[13], 3),
  acc_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975), na.rm=T)[1],3),
  acc_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975), na.rm=T)[2],3),
  PPV3 = round(boot_results_twocutpoints$t0[14], 3),
  ppv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,14], c(0.025, 0.975), na.rm=T)[1],3),
  ppv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,14], c(0.025, 0.975), na.rm=T)[2],3),
  NPV3 = round(boot_results_twocutpoints$t0[15], 3),
  npv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,15], c(0.025, 0.975), na.rm=T)[1],3),
  npv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,15], c(0.025, 0.975), na.rm=T)[2],3),
  
  diff_acc12 = round(boot_results_twocutpoints$t0[16], 3),
  diff_ppv12 = round(boot_results_twocutpoints$t0[17], 3),
  diff_npv12 = round(boot_results_twocutpoints$t0[18], 3),
  diff_acc23 = round(boot_results_twocutpoints$t0[19], 3),
  diff_ppv23 = round(boot_results_twocutpoints$t0[20], 3),
  diff_npv23 = round(boot_results_twocutpoints$t0[21], 3),
  diff_acc13 = round(boot_results_twocutpoints$t0[22], 3),
  diff_ppv13 = round(boot_results_twocutpoints$t0[23], 3),
  diff_npv13 = round(boot_results_twocutpoints$t0[24], 3),
  
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  
  intermediate_n3 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow3 = round(greyzone_CI3$normal[,2],3),
  intermediate_cihigh3 =round(greyzone_CI3$normal[,3],3),
  intermediate_n_percentage3= round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low3= round(greyzone_percentage3$normal[,2],3),
  intermediate_n_percentage_high3= round(greyzone_percentage3$normal[,3],3),
  diff_n12 = round(boot_results_greyzone$t0[7],3),
  diff_nperc12 =  round(boot_results_greyzone$t0[8],3),
  diff_n23 = round(boot_results_greyzone$t0[9],3),
  diff_nperc23 = round(boot_results_greyzone$t0[10],3),
  diff_n13 = round(boot_results_greyzone$t0[11],3),
  diff_nperc13 = round(boot_results_greyzone$t0[12],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

bootstrap_replicates <- boot_results_twocutpoints$t

# Bootstrapped comparisons Accuracy12
boot_accdiff12_2 <- boot_results_twocutpoints$t0[16]
results_underH0_accdiff12_2 <- bootstrap_replicates[,16] - mean(bootstrap_replicates[,16])
boot_pvalue_accdiff12_2 <- mean(abs(results_underH0_accdiff12_2) >= abs(boot_accdiff12_2))
boot_ppvdiff12_2 <- boot_results_twocutpoints$t0[17]
results_underH0_ppvdiff12_2 <- bootstrap_replicates[,17] - mean(bootstrap_replicates[,17])
boot_pvalue_ppvdiff12_2 <- mean(abs(results_underH0_ppvdiff12_2) >= abs(boot_ppvdiff12_2))
boot_npvdiff12_2 <- boot_results_twocutpoints$t0[18]
results_underH0_npvdiff12_2 <- bootstrap_replicates[,18] - mean(bootstrap_replicates[,18])
boot_pvalue_npvdiff12_2 <- mean(abs(results_underH0_npvdiff12_2) >= abs(boot_npvdiff12_2))

# Bootstrapped comparisons Accuracy23
boot_accdiff23_2 <- boot_results_twocutpoints$t0[19]
results_underH0_accdiff23_2 <- bootstrap_replicates[,19] - mean(na.omit(bootstrap_replicates[,19]))
boot_pvalue_accdiff23_2 <- mean(na.omit(abs(results_underH0_accdiff23_2) >= abs(boot_accdiff23_2)))
boot_ppvdiff23_2 <- boot_results_twocutpoints$t0[20]
results_underH0_ppvdiff23_2 <- bootstrap_replicates[,20] - mean(na.omit(bootstrap_replicates[,20]))
boot_pvalue_ppvdiff23_2 <- mean(na.omit(abs(results_underH0_ppvdiff23_2) >= abs(boot_ppvdiff23_2)))
boot_npvdiff23_2 <- boot_results_twocutpoints$t0[21]
results_underH0_npvdiff23_2 <- bootstrap_replicates[,21] - mean(na.omit(bootstrap_replicates[,21]))
boot_pvalue_npvdiff23_2 <- mean(na.omit(abs(results_underH0_npvdiff23_2) >= abs(boot_npvdiff23_2)))

# Bootstrapped comparisons Accuracy13
boot_accdiff13_2 <- boot_results_twocutpoints$t0[22]
results_underH0_accdiff13_2 <- bootstrap_replicates[,22] - mean(na.omit(bootstrap_replicates[,22]))
boot_pvalue_accdiff13_2 <- mean(na.omit(abs(results_underH0_accdiff13_2) >= abs(boot_accdiff13_2)))
boot_ppvdiff13_2 <- boot_results_twocutpoints$t0[23]
results_underH0_ppvdiff13_2 <- bootstrap_replicates[,23] - mean(na.omit(bootstrap_replicates[,23]))
boot_pvalue_ppvdiff13_2 <- mean(na.omit(abs(results_underH0_ppvdiff13_2) >= abs(boot_ppvdiff13_2)))
boot_npvdiff13_2 <- boot_results_twocutpoints$t0[24]
results_underH0_npvdiff13_2 <- bootstrap_replicates[,24] - mean(na.omit(bootstrap_replicates[,24]))
boot_pvalue_npvdiff13_2 <- mean(na.omit(abs(results_underH0_npvdiff13_2) >= abs(boot_npvdiff13_2)))

pvals_age_2 <- data.frame(
  Age_12 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff12_2, 3),
    round(boot_pvalue_ppvdiff12_2, 3),
    round(boot_pvalue_npvdiff12_2, 3)),
    Age_23 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff23_2, 3),
    round(boot_pvalue_ppvdiff23_2, 3),
    round(boot_pvalue_npvdiff23_2, 3)),
    Age_13 = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff13_2, 3),
    round(boot_pvalue_ppvdiff13_2, 3),
    round(boot_pvalue_npvdiff13_2, 3)))
rownames(pvals_age_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----

merged_age <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Age") #merge 2 dataframes
merged_age$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)

participants_g3 <- nrow(lumi.3)
participants_g3_csf0 <- sum(lumi.3$csf_status == 0)
participants_g3_csf1 <- sum(lumi.3$csf_status == 1)

merged_age$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_age$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
merged_age$G3 <- c(paste(participants_g3_csf0, "/", participants_g3_csf1), paste(participants_g3_csf0, "/", participants_g3_csf1))

openxlsx::write.xlsx(merged_age,file="Age_X.xlsx", rowNames =T)

pvalues_age <- rbind(
  pvals_age,
  pvals_age_n,
  pvals_age_2
)
pvalues_age <- pvalues_age %>% drop_na()
pvalues_age <- rbind(pvalues_age, pval_delong12, pval_delong13, pval_delong23)
rownames(pvalues_age)[rownames(pvalues_age) == "10"] <- "pval_delong12"
rownames(pvalues_age)[rownames(pvalues_age) == "11"] <- "pval_delong13"
rownames(pvalues_age)[rownames(pvalues_age) == "12"] <- "pval_delong23"
openxlsx::write.xlsx(pvalues_age,file="Age_Pvalues_X.xlsx", rowNames =T)

```



#In primary care (all)

```{r setup, echo=FALSE}
library(boot)
library(cutpointr) #Used for PPV and NPV
library(pROC)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(openxlsx)

lumi <- read.xlsx("BFPC_data.xlsx")

lumi$ptau217_spec90 <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95 <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95 <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi.df <- lumi
```

#Sex
```{r split by sex PC, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = sex)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

#AUC deLong
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <- round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)


##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_gender <- data.frame(
  Gender = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_gender) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)

##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_gender_n <- data.frame(
  Gender = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_gender_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons between groups, Accuracy
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons between groups, PPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons between groups, NPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_gender_2 <- data.frame(
  Gender = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_gender_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----

merged_gender <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Gender") #merge 2 dataframes
merged_gender$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_gender$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_gender$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))

openxlsx::write.xlsx(merged_gender,file="Sex_BFPC.xlsx", rowNames =T)

pvalues_gender <- rbind(
  pvals_gender,
  pvals_gender_n,
  pvals_gender_2
)
pvalues_gender <- pvalues_gender %>% drop_na()
pvalues_gender$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_gender,file="Sex_Pvalues_BFPC.xlsx", rowNames =T)

```

##APOE
```{r split by APOE BFPC, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = apoe)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function


##AUC differences with DeLong----

results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <-round(results_delong$p.value,3)


##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)


##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")


# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_apoe <- data.frame(
  APOE = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_apoe) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)


##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_apoe_n <- data.frame(
  APOE = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_apoe_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons between 90% and Youden, Accuracy
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons between 90% and Youden, PPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons between 90% and Youden, NPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_apoe_2 <- data.frame(
  APOE = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_apoe_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----

merged_apoe <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "APOE") #merge 2 dataframes
merged_apoe$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_apoe$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_apoe$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
openxlsx::write.xlsx(merged_apoe,file="APOE_BFPC.xlsx", rowNames =T)

pvalues_apoe <- rbind(
  pvals_apoe,
  pvals_apoe_n,
  pvals_apoe_2)
pvalues_apoe <- pvalues_apoe %>% drop_na()
pvalues_apoe$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_apoe,file="BFPC.xlsx", rowNames =T)

```

##Diabetes
```{r split by diabetes, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = diabetes)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

#AUC deLong
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <-round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)


##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")


# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_diabetes <- data.frame(
  Diabetes = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_diabetes) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)


##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_diabetes_n <- data.frame(
  Diabetes = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_diabetes_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_diabetes_2 <- data.frame(
  Diabetes = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_diabetes_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----

merged_diabetes <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Diabetes") #merge 2 dataframes
merged_diabetes$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_diabetes$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_diabetes$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
openxlsx::write.xlsx(merged_diabetes,file="Diabetes_BFPC_new.xlsx", rowNames =T)

pvalues_diabetes <- rbind(
  pvals_diabetes,
  pvals_diabetes_n,
  pvals_diabetes_2
)
pvalues_diabetes <- pvalues_diabetes %>% drop_na()
pvalues_diabetes$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_diabetes,file="Diabetes_Pvalues_BFPC_new.xlsx", rowNames =T)
```

##CKD
```{r split by CKD BFPC, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = CKD)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

#AUC deLong
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <-round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)


##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")


# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_ckd <- data.frame(
  CKD = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_ckd) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered.age <- lumi %>% filter(greyzone ==1)


##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_ckd_n <- data.frame(
  CKD = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_ckd_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_ckd_2 <- data.frame(
  CKD = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_ckd_2) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval","Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----

merged_CKD <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "CKD") #merge 2 dataframes
merged_CKD$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_CKD$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_CKD$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
openxlsx::write.xlsx(merged_CKD,file="CKD_BFPC.xlsx", rowNames =T)

pvalues_ckd <- rbind(
  pvals_ckd,
  pvals_ckd_n,
  pvals_ckd_2
)
pvalues_ckd <- pvalues_ckd %>% drop_na()
pvalues_ckd$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_ckd,file="CKD_Pvalues_BFPC.xlsx", rowNames =T)
```


##Education
```{r split by education BFPC, echo=F}
lumi <- lumi.df
lumi$education_median <- ifelse(lumi$education < median(lumi$education, na.rm = TRUE), 0, 1)
lumi <- lumi %>% rename(strat = education_median)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

##Fit ROC curve and define threshold at 90% specificity ----

roc_curve1 <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1 <- coords(roc_curve1, x="all", transpose=F)
auc1 <- ci.auc(roc_curve1)[2] #AUC will be bootstrapped 2000 times, already included in function

roc_curve2 <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2 <- coords(roc_curve2, x="all", transpose=F)
auc2 <- ci.auc(roc_curve2)[2] #AUC will be bootstrapped 2000 times, already included in function

#AUC deLong
results_delong <- roc.test(roc_curve1, roc_curve2, method = "delong")
pval_delong <-round(results_delong$p.value,3)

##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  #Create confusion matrix1
  v_tp=sum(d1$csf_status==1 & d1$ptau217_spec90==1)
  v_fp=sum(d1$csf_status==0 & d1$ptau217_spec90==1)
  v_tn=sum(d1$csf_status==0 & d1$ptau217_spec90==0)
  v_fn=sum(d1$csf_status==1 & d1$ptau217_spec90==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix2
  v_tp2=sum(d2$csf_status==1 & d2$ptau217_spec90==1)
  v_fp2=sum(d2$csf_status==0 & d2$ptau217_spec90==1)
  v_tn2=sum(d2$csf_status==0 & d2$ptau217_spec90==0)
  v_fn2=sum(d2$csf_status==1 & d2$ptau217_spec90==0)
  
  #Sensitivity and specificity2
  sens2 <- v_tp2 / (v_tp2 + v_fn2)
  spec2 <- v_tn2 / (v_tn2 + v_fp2)
  
  #Accuracy2
  acc2=(v_tp2+v_tn2)/(v_tp2+v_tn2+v_fn2+v_fp2)
  
  #Calculate PPV and NPV (cutpointr)2
  PPV2=ppv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  NPV2=npv(tp = v_tp2,fp = v_fp2,
          tn = v_tn2,fn = v_fn2)
  
  diff_acc <- acc - acc2
  diff_ppv <- PPV - PPV2
  diff_npv <- NPV - NPV2
  return(c(sens, spec, acc, PPV, NPV, sens2, spec2, acc2, PPV2, NPV2, diff_acc, diff_ppv, diff_npv))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)


##Add results to dataframe, will be used for plotting ----
results_1cp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  diff_n = NA,
  diff_nperc = NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")


# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results$t
boot_accdiff <- boot_results$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results$t
boot_ppvdiff <- boot_results$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results$t
boot_npvdiff <- boot_results$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_education <- data.frame(
  Education = c(
    round(boot_pvalue_accdiff, 3),
    round(boot_pvalue_ppvdiff, 3),
    round(boot_pvalue_npvdiff, 3),
    pval_delong,
    NA,NA, NA, NA, NA))
rownames(pvals_education) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Filter out intermediate participants ----
lumi$greyzone <- ifelse(lumi$ptau217_sens95 == 0| lumi$ptau217_spec95 == 1, 1, 0) #Intermediate values get assigned 0
lumi.filtered <- lumi %>% filter(greyzone ==1)


##Define function to bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  d$greyzone <- ifelse(d$ptau217_sens95 == 0| d$ptau217_spec95 == 1, 1, 0)
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  
  intermediate_n1 <- length(which(d1$greyzone ==0))
  intermediate_npercent1 <- round((length(which(d1$greyzone == 0)) / nrow(d1)) * 100, 3)
  
  intermediate_n2 <- length(which(d2$greyzone ==0))
  intermediate_npercent2 <- round((length(which(d2$greyzone == 0)) / nrow(d2)) * 100, 3)
  
  diff_intermediaten <- intermediate_n1 - intermediate_n2
  diff_percent <- intermediate_npercent1 - intermediate_npercent2
  return(c(intermediate_npercent1, intermediate_n1, intermediate_npercent2,intermediate_n2,diff_intermediaten,diff_percent))
}

##Bootstrap to get 95%CI of #n intermediates ----
set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)
greyzone_CI1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 2)
greyzone_percentage1 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 1)
greyzone_CI2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 4)
greyzone_percentage2 <- boot.ci(boot_results_greyzone, type = "norm",seed=12345,index = 3)

# Bootstrapped comparisons between #n greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_ndiff <- boot_results_greyzone$t0[5]
results_underH0_ndiff <- bootstrap_replicates[,5] - mean(bootstrap_replicates[,5])
boot_pvalue_ndiff <- mean(abs(results_underH0_ndiff) >= abs(boot_ndiff))

# Bootstrapped comparisons between percentage n in greyzone
bootstrap_replicates <- boot_results_greyzone$t
boot_npercdiff <- boot_results_greyzone$t0[6]
results_underH0_npercdiff <- bootstrap_replicates[,6] - mean(bootstrap_replicates[,6])
boot_pvalue_npercdiff <- mean(abs(results_underH0_npercdiff) >= abs(boot_npercdiff))

pvals_education_n <- data.frame(
  Education = c(NA, NA, NA,NA,
    round(boot_pvalue_ndiff, 3),
    round(boot_pvalue_npercdiff, 3), NA, NA,NA))
rownames(pvals_education_n) <- c("Accuracy pval", "PPV pval", "NPV pval", "DeLong pval", "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")

##Repeat bootstrap in filtered sample, remove intermediate participants ----
set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi.filtered, statistic = f_comp_stats, R = 2000)

##Add results to dataframe for plotting ----
results_twocp <- data.frame(
  auc1 = round(ci.auc(roc_curve1)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  auc2 = round(ci.auc(roc_curve2)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[8], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[9], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[10], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_acc = round(boot_results_twocutpoints$t0[11], 3),
  diffacc_cilow = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffacc_ciup = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_ppv = round(boot_results_twocutpoints$t0[12], 3),
  diffppv_cilow = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffppv_ciup = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  diff_npv = round(boot_results_twocutpoints$t0[13], 3),
  diffnpv_cilow = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffnpv_ciup = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(greyzone_CI1$normal[,2],3),
  intermediate_cihigh1 = round(greyzone_CI1$normal[,3],3),
  intermediate_n_percentage1=round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1=round(greyzone_percentage1$normal[,2],3),
  intermediate_n_percentage_high1=round(greyzone_percentage1$normal[,3],3),
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(greyzone_CI2$normal[,2],3),
  intermediate_cihigh2 = round(greyzone_CI2$normal[,3],3),
  intermediate_n_percentage2=round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2=round(greyzone_percentage2$normal[,2],3),
  intermediate_n_percentage_high2=round(greyzone_percentage2$normal[,3],3),
  diff_n = round(boot_results_greyzone$t0[5],3),
  diff_nperc = round(boot_results_greyzone$t0[6],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

# Bootstrapped comparisons Accuracy
bootstrap_replicates <- boot_results_twocutpoints$t
boot_accdiff <- boot_results_twocutpoints$t0[11]
results_underH0_accdiff <- bootstrap_replicates[,11] - mean(bootstrap_replicates[,11])
boot_pvalue_accdiff2 <- mean(abs(results_underH0_accdiff) >= abs(boot_accdiff))

# Bootstrapped comparisons PPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_ppvdiff <- boot_results_twocutpoints$t0[12]
results_underH0_ppvdiff <- bootstrap_replicates[,12] - mean(bootstrap_replicates[,12])
boot_pvalue_ppvdiff2 <- mean(abs(results_underH0_ppvdiff) >= abs(boot_ppvdiff))

# Bootstrapped comparisons NPV
bootstrap_replicates <- boot_results_twocutpoints$t
boot_npvdiff <- boot_results_twocutpoints$t0[13]
results_underH0_npvdiff <- bootstrap_replicates[,13] - mean(bootstrap_replicates[,13])
boot_pvalue_npvdiff2 <- mean(abs(results_underH0_npvdiff) >= abs(boot_npvdiff))

pvals_education_2 <- data.frame(
  Education = c(NA, NA, NA, NA, NA,NA,
    round(boot_pvalue_accdiff2, 3),
    round(boot_pvalue_ppvdiff2, 3),
    round(boot_pvalue_npvdiff2, 3)))
rownames(pvals_education_2) <- c("Accuracy pval", "PPV pval", "NPV pval","DeLong pval",  "Intermediate N", "Intermediate N%", "Accuracy2cutpoints", "PPV2cutpoints", "NPV2cutpoints")


#Store data 3 ----
merged_education <- rbind(results_1cp, results_twocp) %>% 
  mutate(Cohort = "Education") #merge 2 dataframes
merged_education$modeltype <- c("1", "2")
participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)
merged_education$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_education$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
openxlsx::write.xlsx(merged_education,file="Education_BFPC.xlsx", rowNames =T)

pvalues_education <- rbind(
  pvals_education,
  pvals_education_n,
  pvals_education_2
)
pvalues_education <- pvalues_education %>% drop_na()
pvalues_education$DeLong <- pval_delong
openxlsx::write.xlsx(pvalues_education,file="Education_Pvalues_BFPC.xlsx", rowNames =T)

```


##Figures 1 cutpoint

###Create plotdata

```{r figures BFPC set data, echo=F}
merged_gender <- read_xlsx("Gender_BFPC.xlsx")
rownames(merged_gender) <- merged_gender[[1]]  
merged_gender <- merged_gender[ , -1]   

group1_gender <- cbind(merged_gender[0:2, 1:12], merged_gender[0:2, 50:51])
colnames(group1_gender) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high", "G1", "G2")
group1_gender$group <- "1"
group2_gender <- cbind(merged_gender[0:2, 13:24], merged_gender[0:2, 50:51])
colnames(group2_gender) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high", "G1", "G2")
group2_gender$group <- "2"
merged_gender2 <- bind_rows(group1_gender, group2_gender)
merged_gender2$Cohort <- "Sex"
merged_gender2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#Education
merged_education <- read_xlsx("Education_BFPC.xlsx")
rownames(merged_education) <- merged_education[[1]]  # Use the first column as row names
merged_education <- merged_education[ , -1]  
group1_education <- cbind(merged_education[0:2, 1:12], merged_education[0:2, 50:51])
colnames(group1_education) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high", "G1", "G2")
group1_education$group <- "1"
group2_education <- cbind(merged_education[0:2, 13:24], merged_education[0:2, 50:51])
colnames(group2_education) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group2_education$group <- "2"
merged_education2 <- bind_rows(group1_education, group2_education)
merged_education2$Cohort <- "Education"
merged_education2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#CKD
merged_CKD <- read_xlsx("CKD_BFPC.xlsx")
rownames(merged_CKD) <- merged_CKD[[1]]  # Use the first column as row names
merged_CKD <- merged_CKD[ , -1]  
group1_CKD <- cbind(merged_CKD[0:2, 1:12], merged_CKD[0:2, 50:51])
colnames(group1_CKD) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group1_CKD$group <- "1"
group2_CKD <- cbind(merged_CKD[0:2, 13:24], merged_CKD[0:2, 50:51])
colnames(group2_CKD) <- c( "AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group2_CKD$group <- "2"
merged_CKD2 <- bind_rows(group1_CKD, group2_CKD)
merged_CKD2$Cohort <- "CKD"
merged_CKD2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")


#Diabetes
merged_diabetes <- read_xlsx("Diabetes_BFPC_new.xlsx")
rownames(merged_diabetes) <- merged_diabetes[[1]]  # Use the first column as row names
merged_diabetes <- merged_diabetes[ , -1]  
group1_diabetes <- cbind(merged_diabetes[0:2, 1:12], merged_diabetes[0:2, 50:51])
colnames(group1_diabetes) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group1_diabetes$group <- "1"
group2_diabetes <- cbind(merged_diabetes[0:2, 13:24], merged_diabetes[0:2, 50:51])
colnames(group2_diabetes) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group2_diabetes$group <- "2"
group1_diabetes$AUC <- as.numeric(as.character(group1_diabetes$AUC))
merged_diabetes2 <- bind_rows(group1_diabetes, group2_diabetes)
merged_diabetes2$Cohort <- "Diabetes"
merged_diabetes2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#APOE
merged_apoe <- read_xlsx("APOE_BFPC.xlsx")
rownames(merged_apoe) <- merged_apoe[[1]]  # Use the first column as row names
merged_apoe <- merged_apoe[ , -1]  
group1_apoe <- cbind(merged_apoe[0:2, 1:12], merged_apoe[0:2, 50:51])
colnames(group1_apoe) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group1_apoe$group <- "1"
group2_apoe <- cbind(merged_apoe[0:2, 13:24], merged_apoe[0:2, 50:51])
colnames(group2_apoe) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2")
group2_apoe$group <- "2"
merged_apoe2 <- bind_rows(group1_apoe, group2_apoe)
merged_apoe2$Cohort <- "APOE"
merged_apoe2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

#Age
merged_age <- read_xlsx("ge_BFPC.xlsx")
rownames(merged_age) <- merged_age[[1]]  # Use the first column as row names
merged_age <- merged_age[ , -1]  
group1_age <- cbind(merged_age[0:2, 1:12], merged_age[0:2, 72:74])
colnames(group1_age) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2","G3")
group1_age$group <- "1"
group2_age <- cbind(merged_age[0:2, 13:24], merged_age[0:2, 72:74])
colnames(group2_age) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2","G3")
group2_age$group <- "2"
group3_age <- cbind(merged_age[0:2, 25:36], merged_age[0:2, 72:74])
colnames(group3_age) <- c("AUC", "AUC_ci_low", "AUC_ci_high", "Accuracy", "Accuracy_ci_low", "Accuracy_ci_high", "PPV", "PPV_ci_low","PPV_ci_high", "NPV", "NPV_ci_low", "NPV_ci_high","G1", "G2","G3")
group3_age$group <- "3"
merged_age2 <- bind_rows(group1_age, group2_age, group3_age)
merged_age2$Cohort <- "Age"
merged_age2$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint", "1 Cutpoint", "2 Cutpoint")


plotdata <- bind_rows(merged_gender2, merged_education2, merged_CKD2,merged_diabetes2, merged_age2,merged_apoe2) 

plotdata <- plotdata[grep("1 Cutpoint", plotdata$Cutpoint), ]
plotdata$modeltype <- factor(plotdata$group, levels = c(2,1))
desired_order <- c("Age", "Diabetes", "CKD", "Education", "APOE", "Sex")
group_order <- c("3", "2", "1")

```

###Accuracy 1cp PC

```{r accuracy 1cp PC, echo = F}
group_order <- c("3", "2", "1")
desired_order <- c("Age", "Diabetes", "CKD", "Education", "APOE", "Sex")

ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = Accuracy * 100,
                          ymin = Accuracy_ci_low * 100,
                          ymax = Accuracy_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = Accuracy_ci_high * 100,ymin = Accuracy_ci_low * 100),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = Accuracy * 100,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(50,115),breaks = seq(50,115, by=10),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Accuracy*100, Accuracy_ci_low*100, Accuracy_ci_high*100), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 106, size = 3, color="black") +
  labs(title = element_blank(),x = element_blank(),y = "Accuracy (%)") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-1, face="bold"),
        axis.ticks.y = element_blank(),
        axis.title.x=element_text(face="bold"))
```

###PPV
```{r PPV figure 1cp PC, echo=F}

ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = PPV * 100,
                          ymin = PPV_ci_low * 100,
                          ymax = PPV_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = PPV_ci_high * 100,ymin = PPV_ci_low * 100),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = PPV * 100,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(50,115),breaks = seq(50,115, by=10),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", PPV*100, PPV_ci_low*100, PPV_ci_high*100), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 106, size =3, color="black") +
  labs(title = element_blank(),x = element_blank(),y = "PPV (%)") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-2, face="bold"),
        axis.ticks.y = element_blank(),
        axis.title.x=element_text(face="bold"))
```

###NPV
```{r NPV figure 1cp PC, echo=F}
ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = NPV * 100,
                          ymin = NPV_ci_low * 100,
                          ymax = NPV_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = NPV_ci_high * 100,ymin = NPV_ci_low * 100),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = NPV * 100,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(50,115),breaks = seq(50,115, by=10),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", NPV*100, NPV_ci_low*100, NPV_ci_high*100), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 106, size = 3, color="black") +
  labs(title = element_blank(),x = element_blank(),y = "NPV (%)") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-1, face="bold"),
        axis.ticks.y = element_blank())
```

###AUC
```{r AUC figure 1cp PC, echo=F}
ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = AUC * 100,
                          ymin = AUC_ci_low * 100,
                          ymax = AUC_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = AUC_ci_high,ymin = AUC_ci_low),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = AUC,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(0.80,1.2),breaks = seq(0.80,1.2, by=.05),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(y = 1.06,label = ifelse(group == "1", sprintf("%s", G1),
                               ifelse(group == "2", sprintf("%s", G2), sprintf("%s", G3))),
                group = factor(group, levels = group_order)),
            position = position_dodge(width = 0.75), size = 3, color = "black") +
  labs(title = element_blank(),x = element_blank(),y = "AUC") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-2, face="bold"),
        axis.ticks.y = element_blank(),
        axis.title.x=element_text(face="bold"),
        plot.margin=unit(c(0.5, 1, 0.5, 0.5), "lines"))

```



###Figures 2 cutpoint

```{r figures 2 cutpoint, echo=F}
plotdata <- read.xlsx("Plotdata_BFPC.xlsx")
plotdata <- plotdata[grep("2 Cutpoint", plotdata$Cutpoint), ]
plotdata$modeltype <- factor(plotdata$group, levels = c(2,1))
group_order <- c("3", "2", "1")
desired_order <- c("Age", "Diabetes", "CKD", "Education", "APOE", "Sex")

```

###Accuracy2
```{r accuracy figure 2cp PC, echo=F}
group_order <- c("3", "2", "1")
desired_order <- c("Age", "Diabetes", "CKD", "Education", "APOE", "Sex")

ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = Accuracy * 100,
                          ymin = Accuracy_ci_low * 100,
                          ymax = Accuracy_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = Accuracy_ci_high * 100,ymin = Accuracy_ci_low * 100),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = Accuracy * 100,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(70,115),breaks = seq(70,115, by=10),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Accuracy*100, Accuracy_ci_low*100, Accuracy_ci_high*100), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 106, size = 3, color="black") +
  labs(title = element_blank(),x = element_blank(),y = "Accuracy (%)") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-1, face="bold"),
        axis.ticks.y = element_blank(),
        axis.title.x=element_text(face="bold"))

```


###PPV 2
```{r PPV figure 2cp PC, echo=F}

ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = PPV * 100,
                          ymin = PPV_ci_low * 100,
                          ymax = PPV_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = PPV_ci_high * 100,ymin = PPV_ci_low * 100),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = PPV * 100,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(70,115),breaks = seq(70,115, by=10),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", PPV*100, PPV_ci_low*100, PPV_ci_high*100), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 106, size =3, color="black") +
  labs(title = element_blank(),x = element_blank(),y = "PPV (%)") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-2, face="bold"),
        axis.ticks.y = element_blank(),
        axis.title.x=element_text(face="bold"))

```

###NPV 2
```{r NPV figure 2cp PC, echo=F}

ggplot(data=plotdata, aes(x= factor(Cohort, levels=desired_order),y = NPV * 100,
                          ymin = NPV_ci_low * 100,
                          ymax = NPV_ci_high * 100,
                          color = factor(group, levels = group_order)))+
  geom_errorbar(aes(x = factor(Cohort, levels=desired_order),ymax = NPV_ci_high * 100,ymin = NPV_ci_low * 100),
                width = 0.2,linewidth = 0.5,position = position_dodge(width = 0.75)) +
  geom_point(aes(x = factor(Cohort, levels=desired_order),y = NPV * 100,color = factor(group, levels = group_order)),
             position = position_dodge(width = 0.75),size = 4,stroke = 0.5) +
  coord_flip()+
  scale_y_continuous(limits=c(60,115),breaks = seq(60,115, by=10),expand =c(0,0))+
  scale_colour_manual(values = c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF"), guide = "none") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", NPV*100, NPV_ci_low*100, NPV_ci_high*100), group=factor(group, levels = group_order)), 
           position = position_dodge(width=0.75), y = 106, size = 3, color="black") +
  labs(title = element_blank(),x = element_blank(),y = "NPV (%)") +
  theme_classic()+
  theme(axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10,vjust=-1, face="bold"),
        axis.ticks.y = element_blank())

```


###Intermediate
```{r NPV figure 1 cutpoint, echo=F}
igroup1_gender <- merged_gender[0:2, 34:39]
colnames(igroup1_gender) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_gender$group <- "1"
igroup2_gender <- merged_gender[0:2, 40:45]
colnames(igroup2_gender) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_gender$group <- "2"
imerged_gender <- bind_rows(igroup1_gender, igroup2_gender)
imerged_gender$Cohort <- "Sex"
imerged_gender$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

igroup1_education <- merged_education[0:2, 34:39]
colnames(igroup1_education) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_education$group <- "1"
igroup2_education <- merged_education[0:2, 40:45]
colnames(igroup2_education) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_education$group <- "2"
imerged_education <- bind_rows(igroup1_education, igroup2_education)
imerged_education$Cohort <- "Education"
imerged_education$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

igroup1_CKD <- merged_CKD[0:2, 34:39]
colnames(igroup1_CKD) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_CKD$group <- "1"
igroup2_CKD <- merged_CKD[0:2, 40:45]
colnames(igroup2_CKD) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_CKD$group <- "2"
imerged_CKD <- bind_rows(igroup1_CKD, igroup2_CKD)
imerged_CKD$Cohort <- "CKD"
imerged_CKD$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

igroup1_diabetes <- merged_diabetes[0:2, 34:39]
colnames(igroup1_diabetes) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_diabetes$group <- "1"
igroup2_diabetes <- merged_diabetes[0:2, 40:45]
colnames(igroup2_diabetes) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_diabetes$group <- "2"
imerged_diabetes <- bind_rows(igroup1_diabetes, igroup2_diabetes)
imerged_diabetes$Cohort <- "Diabetes"
imerged_diabetes$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

igroup1_apoe <- merged_apoe[0:2, 33:38]
colnames(igroup1_apoe) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_apoe$group <- "1"
igroup2_apoe <- merged_apoe[0:2, 39:44]
colnames(igroup2_apoe) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_apoe$group <- "2"
imerged_apoe <- bind_rows(igroup1_apoe, igroup2_apoe)
imerged_apoe$Cohort <- "APOE"
imerged_apoe$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint")

igroup1_age <- merged_age[0:2, 46:51]
colnames(igroup1_age) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup1_age$group <- "1"
igroup2_age <- merged_age[0:2, 52:57]
colnames(igroup2_age) <-c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup2_age$group <- "2"
igroup3_age <- merged_age[0:2, 58:63]##SET COLUMNS
colnames(igroup3_age) <- c("Intermediaten", "Intermediaten_ci_low", "Intermediaten_ci_high", "Intermediatep", "Intermediatep_ci_low", "Intermediatep_ci_high")
igroup3_age$group <- "3"
imerged_age <- bind_rows(igroup1_age, igroup2_age, igroup3_age)
imerged_age$Cohort <- "Age"
imerged_age$Cutpoint <- c("1 Cutpoint", "2 Cutpoint","1 Cutpoint", "2 Cutpoint", "1 Cutpoint", "2 Cutpoint")


plotdata_i <- bind_rows(imerged_gender, imerged_education, imerged_CKD,imerged_diabetes,imerged_apoe, imerged_age) 
plotdata_i <- plotdata_i[grep("2 Cutpoint", plotdata_i$Cutpoint), ]

desired_order <- c("Sex", "APOE", "Education", "CKD", "Diabetes", "Age")
plotdata_i$modeltype <- factor(plotdata_i$group, levels = c(2,1))
group_order <- c("1", "2", "3")
group_colors <- c("1" = "#4DBBD5FF", "2" = "#E64B35FF", "3" = "#3C5488FF")


##Figure
ggplot(data = plotdata_i, aes(x = factor(Cohort, levels = desired_order), y = Intermediatep, fill = factor(group, levels = group_order))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), color = "black", width = 0.7, alpha=0.75, size=0.4) +
  geom_errorbar(aes(ymax = Intermediatep_ci_high, ymin = Intermediatep_ci_low),
                position = position_dodge(width = 0.7), width = 0.2, size = 0.5, color = "black") +
  geom_text(aes(label = sprintf("%.f", Intermediatep)), 
            position = position_dodge(width = 0.7), vjust = -3, size = 4) +
  scale_y_continuous(limits=c(0,35),breaks = seq(0,35, by=5),expand =c(0,0))+
  scale_fill_manual(values = group_colors, guide = "none") +
  labs(title = element_blank(), x = "", y = "Intermediate values (%)") +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 10, angle=45, hjust=1, face="bold"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(face = "bold", size = 10),
    panel.border = element_rect(linewidth = 0.5, fill = NA, color=NA))

```



