---
title: "Fig3, eFig1"
author: "Noelle"
date: "2024-08-08"
output: html_document
---
This document contains the code used for analyzing p-tau217 Lumipulse performances, compared to p-tau217 C2N and %p-tau217 C2N.

#In primary care
#BFPC
```{r C2N comparisons BFPC, echo=F}
lumi <- read_xlsx("BFPC_data.xlsx")

#Cutoffs were determined in secondary care MalmÃ¶, see cutoff file
lumi$ptau217_spec90_lumi <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95_lumi <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95_lumi <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 
lumi$ptau217_spec95_c2n <- ifelse(lumi$p_tau217_v2 > 2.92, 1, 0)
lumi$ptau217_sens95_c2n <- ifelse(lumi$p_tau217_v2 > 1.59, 1, 0)

lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 
lumi$ptau217_spec95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 5.08, 1, 0)
lumi$ptau217_sens95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 3.55, 1, 0)

lumi <- lumi %>% drop_na(p_tau217_ratio_v2)

##AUC differences with DeLong----
biomarkers <- c("pl_ptau217", "p_tau217_v2", "p_tau217_ratio_v2")

results_delong <- list()
index <- 1

for (i in seq_along(biomarkers)){
  for (j in seq_along(biomarkers)){ 
    if (i < j) {
      predictor1 <- biomarkers[i]
      predictor2 <- biomarkers[j]
      
      formula1 <- as.formula(paste("csf_status~",predictor1, collapse=""))
      formula2 <- as.formula(paste("csf_status~",predictor2, collapse=""))
      
      roc_curve1 <- pROC::roc(formula1, data=lumi, quiet=T)
      roc_curve2 <- pROC::roc(formula2, data=lumi,quiet=T)
      
      res <- roc.test(roc_curve1, roc_curve2, method = "delong")
      
      long <- data.frame(
        comp = paste(predictor1, predictor2, sep=" vs. "),
        auc1a = round(roc_curve1$auc,3),
        auc2a = round(roc_curve2$auc,3),
        pval = round(res$p.value,3),
        auc1_ci_low = round(ci.auc(roc_curve1)[1],3),
        auc1_ci_high =round(ci.auc(roc_curve1)[3],3),
        auc2_ci_low =round(ci.auc(roc_curve2)[1],3),
        auc2_ci_high = round(ci.auc(roc_curve2)[3],3)
        )
      
      results_delong[[length(results_delong) + 1]] <- long
      index <- index + 1
    }
  }
}


results_delong <- do.call(rbind.data.frame, results_delong)
results_delong$padj <- round(p.adjust(results_delong$pval, method = "fdr"),3)
openxlsx::write.xlsx(results_delong,
                     file="BFPC_DeLong.xlsx")

#Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  #Create confusion matrix for Lumi
  v_tp=sum(d$csf_status==1 & d$ptau217_spec90_lumi==1)#change
  v_fp=sum(d$csf_status==0 & d$ptau217_spec90_lumi==1)
  v_tn=sum(d$csf_status==0 & d$ptau217_spec90_lumi==0)
  v_fn=sum(d$csf_status==1 & d$ptau217_spec90_lumi==0)
  acc_lumi=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  PPV_lumi=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  NPV_lumi=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix for C2N
  v_tp_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==1) #change
  v_fp_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==1)
  v_tn_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==0)
  v_fn_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==0)
  acc_c=(v_tp_c+v_tn_c)/(v_tp_c+v_tn_c+v_fn_c+v_fp_c)
  PPV_c=ppv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  NPV_c=npv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  
  #Create confusion matrix for C2N Ratio
  cv_tp=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==1)
  cv_fp=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==1)
  cv_tn=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==0)
  cv_fn=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==0)
  acc_c2nr=(cv_tp+cv_tn)/(cv_tp+cv_tn+cv_fn+cv_fp)
  PPV_c2nr=ppv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  NPV_c2nr=npv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  
  
  acclumi_c2n <- acc_lumi - acc_c
  acclumi_c2nratio <- acc_lumi - acc_c2nr
  accc2n_c2nratio <- acc_c - acc_c2nr

  ppvlumi_c2n <- PPV_lumi - PPV_c
  ppvlumi_c2nratio <- PPV_lumi - PPV_c2nr
  ppvc2n_c2nratio <- PPV_c - PPV_c2nr
  
  npvlumi_c2n <- NPV_lumi - NPV_c
  npvlumi_c2nratio <- NPV_lumi - NPV_c2nr
  npvc2n_c2nratio <- NPV_c - NPV_c2nr
  return(c(acc_lumi, acc_c, acc_c2nr, PPV_lumi, PPV_c, PPV_c2nr, NPV_lumi, NPV_c, NPV_c2nr,#9
           acclumi_c2n, acclumi_c2nratio, accc2n_c2nratio, ppvlumi_c2n,ppvlumi_c2nratio, ppvc2n_c2nratio,#15
           npvlumi_c2n, npvlumi_c2nratio,npvc2n_c2nratio))
}

set.seed(12345)

boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 13,
  "NPV pval Lumi vs. C2N" = 16,
  "Accuracy pval Lumi vs. %C2N" = 11,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 17,
  "Accuracy pval C2N vs. %C2N" = 12,
  "PPV pval C2N vs. %C2N" = 15,
  "NPV pval C2N vs. %C2N" = 18)

pvals_1cp <- data.frame(
  Grey = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N vs. %C2N"))

bootstrap_replicates <- boot_results$t
for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results$t0[index]
  results_underH0_diff <- bootstrap_replicates[, index] - mean(bootstrap_replicates[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_1cp[paste0(stat_name), "Grey"] <- round(p_value, 3)
}

##Add results to dataframe, will be used for plotting ----
results_1cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = round(results_delong$auc1a[1],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[1], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[1], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[7], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2n <- data.frame(
method = "C2N",
  auc1 = round(results_delong$auc1a[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[2], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[5], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[8], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = round(results_delong$auc2a[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc2_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc2_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[6], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

merged_results_1cp <- rbind(results_1cp_lumi, results_1cp_c2n, results_1cp_c2nratio)

##Greyzone---

lumi <- lumi %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                      # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  
  d_lumi <- d %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_lumi <- length(which(d_lumi$greyzone_lumi ==2))
  intermediate_npercent_lumi <- round((length(which(d_lumi$greyzone_lumi == 2)) / nrow(d_lumi)) * 100, 3)

  #C2N
  d_c2n <- d %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_c2n <- length(which(d_c2n$greyzone_c2n ==2))
  intermediate_npercent_c2n <- round((length(which(d_c2n$greyzone_c2n == 2)) / nrow(d_c2n)) * 100, 3)
  
  #C2N ratio
  d_c2nr <- d %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_c2nr <- length(which(d_c2nr$greyzone_c2nr == 2))
  intermediate_npercent_c2nr <- round((length(which(d_c2nr$greyzone_c2nr == 2)) / nrow(d_c2nr)) * 100, 3)
  
  #DIFFERENCES BETWEEN ASSAYS
  ##lumi vs. C2N
  diff_n_lumi_c2n <- intermediate_n_lumi - intermediate_n_c2n
  diff_nperc_lumi_c2n <- intermediate_npercent_lumi - intermediate_npercent_c2n

  ##lumi vs. C2N%
  diff_n_lumi_c2nr <- intermediate_n_lumi - intermediate_n_c2nr
  diff_nperc_lumi_c2nr <- intermediate_npercent_lumi - intermediate_npercent_c2nr

  ##C2n vs. C2N%
  diff_n_c2n_c2nr <- intermediate_n_c2n - intermediate_n_c2nr
  diff_nperc_c2n_c2nr <- intermediate_npercent_c2n - intermediate_npercent_c2nr

  return(c(intermediate_npercent_lumi, intermediate_n_lumi,intermediate_npercent_c2n, intermediate_n_c2n,
           intermediate_npercent_c2nr, intermediate_n_c2nr,
           diff_n_lumi_c2n,diff_nperc_lumi_c2n,diff_n_lumi_c2nr,diff_nperc_lumi_c2nr,diff_n_c2n_c2nr,diff_nperc_c2n_c2nr))
}

set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)

stat_indices <- list(
  "Intermediate N pval Lumi vs. C2N" = 7, "Intermediate N pval Lumi vs. C2N%" =9 , "Intermediate N pval C2N vs. C2N%" = 11, 
  "Intermediate Perc pval Lumi vs. C2N" =8 , "Intermediate Perc pval Lumi vs. C2N%" = 10, "Intermediate Perc pval C2N vs. C2N%" = 12)

pvals_intermediate <- data.frame(
  Grey = numeric(length(stat_indices)),
  row.names = c(
  "Intermediate N pval Lumi vs. C2N", "Intermediate N pval Lumi vs. C2N%", "Intermediate N pval C2N vs. C2N%", 
  "Intermediate Perc pval Lumi vs. C2N", "Intermediate Perc pval Lumi vs. C2N%", "Intermediate Perc pval C2N vs. C2N%"))

bootstrap_replicates_grey <- boot_results_greyzone$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_greyzone$t0[index]
  results_underH0_diff <- bootstrap_replicates_grey[, index] - mean(bootstrap_replicates_grey[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_intermediate[paste0(stat_name), "Grey"] <- round(p_value, 3)
}


#2CPs

f_comp_stats_2cp <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d_lumi <- d %>% filter(greyzone_lumi != 2)
  
  #LUMI
  #Create confusion matrix1
  v_tp=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==1)
  v_fp=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==1)
  v_tn=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==0)
  v_fn=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #C2N
  
  d_c2n  <- d %>% filter(greyzone_c2n != 2)
  
  
  #Create confusion matrix1
  c2nv_tp=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_fp=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_tn=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==0)
  c2nv_fn=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==0)
  
  #Sensitivity and specificity1
  c2nsens <- c2nv_tp / (c2nv_tp + c2nv_fn)
  c2nspec <- c2nv_tn / (c2nv_tn +c2nv_fp)
  
  #Accuracy1
  c2nacc=(c2nv_tp+c2nv_tn)/(c2nv_tp+c2nv_tn+c2nv_fn+c2nv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nPPV=ppv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  c2nNPV=npv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  #C2NR 
  d_c2nr <- d %>% filter(greyzone_c2nr != 2)
  
  #Create confusion matrix1
  c2nrv_tp=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_fp=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_tn=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==0)
  c2nrv_fn=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==0)
  
  #Sensitivity and specificity1
  c2nrsens <- c2nrv_tp / (c2nrv_tp + c2nrv_fn)
  c2nrspec <- c2nrv_tn / (c2nrv_tn + c2nrv_fp)
  
  #Accuracy1
  c2nracc=(c2nrv_tp+c2nrv_tn)/(c2nrv_tp+c2nrv_tn+c2nrv_fn+c2nrv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nrPPV=ppv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  c2nrNPV=npv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  ##Different comparisons
  
  ##lumi vs. C2N
  diff_acc_lumi_c2n <- acc - c2nacc
  diff_ppv_lumi_c2n <- PPV - c2nPPV
  diff_npv_lumi_c2n <- NPV - c2nNPV

  ##lumi vs. C2N%
  diff_acc_lumi_c2nr <- acc - c2nracc
  diff_ppv_lumi_c2nr <- PPV - c2nrPPV
  diff_npv_lumi_c2nr <- NPV - c2nrNPV
  
   ##C2n vs. C2N%
  diff_acc_c2n_c2nr <- c2nacc - c2nracc
  diff_ppv_c2n_c2nr <- c2nPPV - c2nrPPV
  diff_npv_c2n_c2nr <- c2nNPV - c2nrNPV
  
  
  return(c(acc, PPV, NPV,c2nacc, c2nPPV, c2nNPV,c2nracc, c2nrPPV, c2nrNPV,#9
           diff_acc_lumi_c2n, diff_ppv_lumi_c2n, diff_npv_lumi_c2n,#12
           diff_acc_lumi_c2nr, diff_ppv_lumi_c2nr, diff_npv_lumi_c2nr,#15
           diff_acc_c2n_c2nr, diff_ppv_c2n_c2nr, diff_npv_c2n_c2nr))
}

set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi, statistic = f_comp_stats_2cp, R = 2000)

results_2cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[2], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[3], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp C2N----
results_2cp_c2n <- data.frame(
  method = "C2N",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[4], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[5], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[6], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,6], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp %C2N----
results_2cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[7], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[8], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

merged_results_2cp <- rbind(results_2cp_lumi, results_2cp_c2n, results_2cp_c2nratio)

##Pvalues 2cp
stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 11,
  "NPV pval Lumi vs. C2N" = 12,
  "Accuracy pval Lumi vs. %C2N" = 13,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 15,
  "Accuracy pval C2N vs. %C2N" = 16,
  "PPV pval C2N vs. %C2N" = 17,
  "NPV pval C2N  vs. %C2N" = 18)

pvals_2cp <- data.frame(
  Grey = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N vs. %C2N"))

bootstrap_replicates_2cp <- boot_results_twocutpoints$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_twocutpoints$t0[index]
  results_underH0_diff <- bootstrap_replicates_2cp[, index] - mean(bootstrap_replicates_2cp[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_2cp[paste0(stat_name), "Grey"] <- round(p_value, 3)
}

merged_comps_c2n <- rbind(merged_results_1cp, merged_results_2cp)
merged_comps_c2n$Cutpoints <- c("1 Cutpoint","1 Cutpoint","1 Cutpoint","2 Cutpoints","2 Cutpoints","2 Cutpoints")
openxlsx::write.xlsx(merged_comps_c2n,file="BFPC_C2N.xlsx", rowNames =T)

pvalues_cognition <- rbind(
  pvals_1cp,
  pvals_intermediate,
  pvals_2cp
)
openxlsx::write.xlsx(pvalues_cognition,file="BFPC_pvals_C2N.xlsx", rowNames =T)
```

#In secondary care (pooled)

```{r C2N comparisons pooled, echo=F}
BFMC <- read_xlsx("BFMC_data.xlsx")
Got <- read_xlsx("Gothenburg_data_C2N.xlsx")
Bres <- read_xlsx("Brescia_data_C2N.xlsx")

lumi <- rbind(BFMC, Bres, Got)

lumi$ptau217_spec90_lumi <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95_lumi <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95_lumi <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 
lumi$ptau217_spec95_c2n <- ifelse(lumi$p_tau217_v2 > 2.92, 1, 0)
lumi$ptau217_sens95_c2n <- ifelse(lumi$p_tau217_v2 > 1.59, 1, 0)

lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 
lumi$ptau217_spec95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 5.08, 1, 0)
lumi$ptau217_sens95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 3.55, 1, 0)

lumi <- lumi %>% drop_na(p_tau217_ratio_v2)

##AUC differences with DeLong----
biomarkers <- c("pl_ptau217", "p_tau217_v2", "p_tau217_ratio_v2")

results_delong <- list()
index <- 1

for (i in seq_along(biomarkers)){
  for (j in seq_along(biomarkers)){ 
    if (i < j) {
      predictor1 <- biomarkers[i]
      predictor2 <- biomarkers[j]
      
      formula1 <- as.formula(paste("csf_status~",predictor1, collapse=""))
      formula2 <- as.formula(paste("csf_status~",predictor2, collapse=""))
      
      roc_curve1 <- pROC::roc(formula1, data=lumi, quiet=T)
      roc_curve2 <- pROC::roc(formula2, data=lumi,quiet=T)
      
      res <- roc.test(roc_curve1, roc_curve2, method = "delong")
      
      long <- data.frame(
        comp = paste(predictor1, predictor2, sep=" vs. "),
        auc1a = round(roc_curve1$auc,3),
        auc2a = round(roc_curve2$auc,3),
        pval = round(res$p.value,3),
        auc1_ci_low = round(ci.auc(roc_curve1)[1],3),
        auc1_ci_high =round(ci.auc(roc_curve1)[3],3),
        auc2_ci_low =round(ci.auc(roc_curve2)[1],3),
        auc2_ci_high = round(ci.auc(roc_curve2)[3],3)
        )
      
      results_delong[[length(results_delong) + 1]] <- long
      index <- index + 1
    }
  }
}


results_delong <- do.call(rbind.data.frame, results_delong)
results_delong$padj <- round(p.adjust(results_delong$pval, method = "fdr"),3)
openxlsx::write.xlsx(results_delong,
                     file="C2N_pooled_DeLong.xlsx")

#Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  #Create confusion matrix for Lumi
  v_tp=sum(d$csf_status==1 & d$ptau217_spec90_lumi==1)#change
  v_fp=sum(d$csf_status==0 & d$ptau217_spec90_lumi==1)
  v_tn=sum(d$csf_status==0 & d$ptau217_spec90_lumi==0)
  v_fn=sum(d$csf_status==1 & d$ptau217_spec90_lumi==0)
  acc_lumi=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  PPV_lumi=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  NPV_lumi=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #Create confusion matrix for C2N
  v_tp_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==1) #change
  v_fp_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==1)
  v_tn_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==0)
  v_fn_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==0)
  acc_c=(v_tp_c+v_tn_c)/(v_tp_c+v_tn_c+v_fn_c+v_fp_c)
  PPV_c=ppv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  NPV_c=npv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  
  #Create confusion matrix for C2N Ratio
  cv_tp=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==1)
  cv_fp=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==1)
  cv_tn=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==0)
  cv_fn=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==0) #threshold is too high in Gothenburg
  
  acc_c2nr=(cv_tp+cv_tn)/(cv_tp+cv_tn+cv_fn+cv_fp)
  PPV_c2nr=ppv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  NPV_c2nr=npv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  
  
  acclumi_c2n <- acc_lumi - acc_c
  acclumi_c2nratio <- acc_lumi - acc_c2nr
  accc2n_c2nratio <- acc_c - acc_c2nr

  ppvlumi_c2n <- PPV_lumi - PPV_c
  ppvlumi_c2nratio <- PPV_lumi - PPV_c2nr
  ppvc2n_c2nratio <- PPV_c - PPV_c2nr
  
  npvlumi_c2n <- NPV_lumi - NPV_c
  npvlumi_c2nratio <- NPV_lumi - NPV_c2nr
  npvc2n_c2nratio <- NPV_c - NPV_c2nr
  return(c(acc_lumi, acc_c, acc_c2nr, PPV_lumi, PPV_c, PPV_c2nr, NPV_lumi, NPV_c, NPV_c2nr,#9
           acclumi_c2n, acclumi_c2nratio, accc2n_c2nratio, ppvlumi_c2n,ppvlumi_c2nratio, ppvc2n_c2nratio,#15
           npvlumi_c2n, npvlumi_c2nratio,npvc2n_c2nratio))
}

set.seed(12345)

boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 13,
  "NPV pval Lumi vs. C2N" = 16,
  "Accuracy pval Lumi vs. %C2N" = 11,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 17,
  "Accuracy pval C2N vs. %C2N" = 12,
  "PPV pval C2N vs. %C2N" = 15,
  "NPV pval C2N  vs. %C2N" = 18)

pvals_1cp <- data.frame(
  Grey = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N  vs. %C2N"))

bootstrap_replicates <- boot_results$t
for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results$t0[index]
  results_underH0_diff <- bootstrap_replicates[, index] - mean(bootstrap_replicates[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_1cp[paste0(stat_name), "Grey"] <- round(p_value, 3)
}

##Add results to dataframe, will be used for plotting ----
results_1cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = round(results_delong$auc1a[1],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[1], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[1], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[7], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2n <- data.frame(
method = "C2N",
  auc1 = round(results_delong$auc1a[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[2], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[5], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[8], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = round(results_delong$auc2a[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc2_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc2_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[6], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

merged_results_1cp <- rbind(results_1cp_lumi, results_1cp_c2n, results_1cp_c2nratio)

##Greyzone---

lumi <- lumi %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                      # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  
  d_lumi <- d %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_lumi <- length(which(d_lumi$greyzone_lumi ==2))
  intermediate_npercent_lumi <- round((length(which(d_lumi$greyzone_lumi == 2)) / nrow(d_lumi)) * 100, 3)

  #C2N
  d_c2n <- d %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_c2n <- length(which(d_c2n$greyzone_c2n ==2))
  intermediate_npercent_c2n <- round((length(which(d_c2n$greyzone_c2n == 2)) / nrow(d_c2n)) * 100, 3)
  
  #C2N ratio
  d_c2nr <- d %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_c2nr <- length(which(d_c2nr$greyzone_c2nr == 2))
  intermediate_npercent_c2nr <- round((length(which(d_c2nr$greyzone_c2nr == 2)) / nrow(d_c2nr)) * 100, 3)
  
  #DIFFERENCES BETWEEN ASSAYS
  ##lumi vs. C2N
  diff_n_lumi_c2n <- intermediate_n_lumi - intermediate_n_c2n
  diff_nperc_lumi_c2n <- intermediate_npercent_lumi - intermediate_npercent_c2n

  ##lumi vs. C2N%
  diff_n_lumi_c2nr <- intermediate_n_lumi - intermediate_n_c2nr
  diff_nperc_lumi_c2nr <- intermediate_npercent_lumi - intermediate_npercent_c2nr

  ##C2n vs. C2N%
  diff_n_c2n_c2nr <- intermediate_n_c2n - intermediate_n_c2nr
  diff_nperc_c2n_c2nr <- intermediate_npercent_c2n - intermediate_npercent_c2nr

  return(c(intermediate_npercent_lumi, intermediate_n_lumi,intermediate_npercent_c2n, intermediate_n_c2n,
           intermediate_npercent_c2nr, intermediate_n_c2nr,
           diff_n_lumi_c2n,diff_nperc_lumi_c2n,diff_n_lumi_c2nr,diff_nperc_lumi_c2nr,diff_n_c2n_c2nr,diff_nperc_c2n_c2nr))
}

set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)

stat_indices <- list(
  "Intermediate N pval Lumi vs. C2N" = 7, "Intermediate N pval Lumi vs. C2N%" =9 , "Intermediate N pval C2N vs. C2N%" = 11, 
  "Intermediate Perc pval Lumi vs. C2N" =8 , "Intermediate Perc pval Lumi vs. C2N%" = 10, "Intermediate Perc pval C2N vs. C2N%" = 12)

pvals_intermediate <- data.frame(
  Grey = numeric(length(stat_indices)),
  row.names = c(
  "Intermediate N pval Lumi vs. C2N", "Intermediate N pval Lumi vs. C2N%", "Intermediate N pval C2N vs. C2N%", 
  "Intermediate Perc pval Lumi vs. C2N", "Intermediate Perc pval Lumi vs. C2N%", "Intermediate Perc pval C2N vs. C2N%"))

bootstrap_replicates_grey <- boot_results_greyzone$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_greyzone$t0[index]
  results_underH0_diff <- bootstrap_replicates_grey[, index] - mean(bootstrap_replicates_grey[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_intermediate[paste0(stat_name), "Grey"] <- round(p_value, 3)
}


#2CPs

f_comp_stats_2cp <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d_lumi <- d %>% filter(greyzone_lumi != 2)
  
  #LUMI
  #Create confusion matrix1
  v_tp=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==1)
  v_fp=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==1)
  v_tn=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==0)
  v_fn=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #C2N
  
  d_c2n  <- d %>% filter(greyzone_c2n != 2)
  
  
  #Create confusion matrix1
  c2nv_tp=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_fp=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_tn=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==0)
  c2nv_fn=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==0)
  
  #Sensitivity and specificity1
  c2nsens <- c2nv_tp / (c2nv_tp + c2nv_fn)
  c2nspec <- c2nv_tn / (c2nv_tn +c2nv_fp)
  
  #Accuracy1
  c2nacc=(c2nv_tp+c2nv_tn)/(c2nv_tp+c2nv_tn+c2nv_fn+c2nv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nPPV=ppv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  c2nNPV=npv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  #C2NR 
  d_c2nr <- d %>% filter(greyzone_c2nr != 2)
  
  #Create confusion matrix1
  c2nrv_tp=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_fp=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_tn=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==0)
  c2nrv_fn=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==0)
  
  #Sensitivity and specificity1
  c2nrsens <- c2nrv_tp / (c2nrv_tp + c2nrv_fn)
  c2nrspec <- c2nrv_tn / (c2nrv_tn + c2nrv_fp)
  
  #Accuracy1
  c2nracc=(c2nrv_tp+c2nrv_tn)/(c2nrv_tp+c2nrv_tn+c2nrv_fn+c2nrv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nrPPV=ppv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  c2nrNPV=npv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  ##Different comparisons
  
  ##lumi vs. C2N
  diff_acc_lumi_c2n <- acc - c2nacc
  diff_ppv_lumi_c2n <- PPV - c2nPPV
  diff_npv_lumi_c2n <- NPV - c2nNPV

  ##lumi vs. C2N%
  diff_acc_lumi_c2nr <- acc - c2nracc
  diff_ppv_lumi_c2nr <- PPV - c2nrPPV
  diff_npv_lumi_c2nr <- NPV - c2nrNPV
  
   ##C2n vs. C2N%
  diff_acc_c2n_c2nr <- c2nacc - c2nracc
  diff_ppv_c2n_c2nr <- c2nPPV - c2nrPPV
  diff_npv_c2n_c2nr <- c2nNPV - c2nrNPV
  
  
  return(c(acc, PPV, NPV,c2nacc, c2nPPV, c2nNPV,c2nracc, c2nrPPV, c2nrNPV,#9
           diff_acc_lumi_c2n, diff_ppv_lumi_c2n, diff_npv_lumi_c2n,#12
           diff_acc_lumi_c2nr, diff_ppv_lumi_c2nr, diff_npv_lumi_c2nr,#15
           diff_acc_c2n_c2nr, diff_ppv_c2n_c2nr, diff_npv_c2n_c2nr))
}

set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi, statistic = f_comp_stats_2cp, R = 2000)

results_2cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[2], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[3], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp C2N----
results_2cp_c2n <- data.frame(
  method = "C2N",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[4], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[5], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[6], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,6], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp %C2N----
results_2cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[7], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[8], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

merged_results_2cp <- rbind(results_2cp_lumi, results_2cp_c2n, results_2cp_c2nratio)

##Pvalues 2cp
stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 11,
  "NPV pval Lumi vs. C2N" = 12,
  "Accuracy pval Lumi vs. %C2N" = 13,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 15,
  "Accuracy pval C2N vs. %C2N" = 16,
  "PPV pval C2N vs. %C2N" = 17,
  "NPV pval C2N  vs. %C2N" = 18)

pvals_2cp <- data.frame(
  Grey = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N  vs. %C2N"))

bootstrap_replicates_2cp <- boot_results_twocutpoints$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_twocutpoints$t0[index]
  results_underH0_diff <- bootstrap_replicates_2cp[, index] - mean(bootstrap_replicates_2cp[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_2cp[paste0(stat_name), "Grey"] <- round(p_value, 3)
}



merged_comps_c2n <- rbind(merged_results_1cp, merged_results_2cp)
merged_comps_c2n$Cutpoints <- c("1 Cutpoint","1 Cutpoint","1 Cutpoint","2 Cutpoints","2 Cutpoints","2 Cutpoints")
openxlsx::write.xlsx(merged_comps_c2n,file="C2N_pooled.xlsx", rowNames =T)

pvalues_cognition <- rbind(
  pvals_1cp,
  pvals_intermediate,
  pvals_2cp
)
openxlsx::write.xlsx(pvalues_cognition,file="C2N_pooled_pvals.xlsx", rowNames =T)
```


Plots

##Boxplots for p-tau217 C2N in pooled and primary care
```{r boxplots p-tau217, echo=F}
pooled <- lumi
datasets <- list(pooled, BFPC)
dataset_names <- c("Pooled", "BFPC")
colorlist <- c("#3c5488ff","#79AF97FF")
output_directory <- "Fig5/"

for (i in seq_along(datasets)) {
  lumi <- datasets[[i]]
  name <- dataset_names[i]
  colorplot <- colorlist[i]
  lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))
  
  ggplot(lumi, aes(x = csf_status, y = p_tau217_v2, group=csf_status)) +
    geom_boxplot(aes(alpha = csf_status), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, fill=colorplot) +
    geom_jitter(width = 0.2,size = 0.6, color="grey10", alpha=0.45)+
    scale_alpha_manual(values = c(0.25, 0.75), labels = c("0" ="Negatives","1" ="Positives"), guide="none")+
    scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, by = 10))+
    geom_hline(yintercept=2.27, linetype="dotted", color="grey20")+
    scale_x_discrete(labels=c("0" ="Negatives","1" ="Positives"))+
    labs(x = "AD status", y = "Plasma p-tau217 C2N") +
    theme_classic()+
    stat_compare_means(method="t.test", label="p.signif", label.x=1.5)#, label.x = 1.5, label.y = 3.0)

  ggsave(paste0(output_directory,"Boxplot_ptau217C2N_v2_", name, ".pdf"),device = "pdf",width = 100, dpi=500, height = 80, units = "mm")

}

```

##Boxplots for %p-tau217 C2N in pooled and primary care

```{r boxplots ratio p-tau217, echo=F}

datasets <- list(pooled, BFPC)
dataset_names <- c("Pooled", "BFPC")
colorlist <- c("#3c5488ff","#79AF97FF")
output_directory <- "Fig5/"

for (i in seq_along(datasets)) {
  lumi <- datasets[[i]]
  name <- dataset_names[i]
  colorplot <- colorlist[i]
  lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

  ggplot(lumi, aes(x = csf_status, y = p_tau217_ratio_v2, group=csf_status)) +
    geom_boxplot(aes(alpha = csf_status), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, fill=colorplot) +
    geom_jitter(width = 0.2,size = 0.6, color="grey10", alpha=0.45)+
    scale_alpha_manual(values = c(0.25, 0.75), labels = c("0" ="Negatives","1" ="Positives"), guide="none")+
    geom_hline(yintercept=4.27, linetype="dotted", color="grey20")+
    scale_x_discrete(labels=c("0" ="Negatives","1" ="Positives"))+
    labs(x = "AD status", y = "Plasma %p-tau217 C2N") +
    theme_classic()+
    stat_compare_means(method="t.test", label="p.signif", label.x=1.5)#, label.x = 1.5, label.y = 3.0)

  ggsave(paste0(output_directory,"Boxplot_ratioptau217C2N_", name, ".pdf"),device = "pdf",width = 100, dpi=500, height = 80, units = "mm")

}

```

##Fig5 plot

```{r figure Pooled etc 1cp, echo=F}
library(readxl)
df1 <- read_xlsx("C2N_pooled_2.xlsx")
names(df1)[1] <- "Approach"
df1$cohort <- "Pooled"

df5 <-  read_xlsx("C2N_BFPC.xlsx")
names(df5)[1] <- "Approach"
df5$cohort <- "BF-PC"

#1CP
merged_results <- rbind(df1, df5)
merged_results <- merged_results %>% filter(Cutpoints == "1 Cutpoint")
merged_results_ptau217 <- merged_results %>% filter(method == "Lumipulse")
merged_results_c2n <- merged_results %>% filter(method == "C2N")
merged_results_c2nr <- merged_results %>% filter(method == "C2N%")

plotdata <- cbind(merged_results_ptau217,merged_results_c2n,merged_results_c2nr)

plot_acc1 <- cbind(plotdata[0:2, 6:8])
plot_acc1$group <- c("1", "1")
colnames(plot_acc1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc2 <- cbind(plotdata[0:2, 28:30])
plot_acc2$group <- c("2", "2")
colnames(plot_acc2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc3 <- cbind(plotdata[0:2, 50:52])
plot_acc3$group <- c("3", "3")
colnames(plot_acc3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc <- rbind(plot_acc1, plot_acc2,plot_acc3)
plot_acc$cohort <- c("Pooled", "Primary care","Pooled","Primary care")

plot_ppv1 <- cbind(plotdata[0:2, 9:11])
plot_ppv1$group <- c("1", "1")
colnames(plot_ppv1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv2 <- cbind(plotdata[0:2, 31:33])
plot_ppv2$group <- c("2", "2")
colnames(plot_ppv2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv3 <- cbind(plotdata[0:2, 53:55])
plot_ppv3$group <- c("3", "3")
colnames(plot_ppv3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv <- rbind(plot_ppv1, plot_ppv2,plot_ppv3)
plot_ppv$cohort <- c("Pooled", "Primary care","Pooled","Primary care")

plot_npv1 <- cbind(plotdata[0:2, 12:14])
plot_npv1$group <- c("1", "1")
colnames(plot_npv1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv2 <- cbind(plotdata[0:2, 34:36])
plot_npv2$group <- c("2", "2")
colnames(plot_npv2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv3 <- cbind(plotdata[0:2, 56:58])
plot_npv3$group <- c("3", "3")
colnames(plot_npv3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv <- rbind(plot_npv1, plot_npv2,plot_npv3)
plot_npv$cohort <- c("Pooled", "Primary care","Pooled","Primary care")

plot_auc1 <- cbind(plotdata[0:2, 3:5])
plot_auc1$group <- c("1", "1")
colnames(plot_auc1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_auc2 <- cbind(plotdata[0:2,25:27])
plot_auc2$group <- c("2", "2")
colnames(plot_auc2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_auc3 <- cbind(plotdata[0:2,47:49])
plot_auc3$group <- c("3", "3")
colnames(plot_auc3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_auc <- rbind(plot_auc1, plot_auc2,plot_auc3)
plot_auc$cohort <- c("Pooled", "Primary care","Pooled","Primary care")

tick_positions <- seq(60, 100, by = 10)
group_order <- c("3","2", "1")

#Accuracy plot----
ggplot(data=plot_acc, aes(y=factor(cohort, levels = c("Primary care", "Pooled")),
                          x=Measure1*100, fill = factor(cohort, levels = c("Primary care", "Pooled")), 
                          color=factor(cohort, levels = c("Primary care", "Pooled")),
                          shape=factor(group, levels=group_order))) +
  geom_vline(xintercept = (plot_acc$Measure1[1])*100, color = "#3c5488ff", linetype = "dotted", alpha=0.5)+
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.25, linewidth = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7), size = 4, stroke = 0.5) +
  scale_x_continuous(limits=c(70,120),breaks = seq(70,120, by=10),expand =c(0,0)) +
  labs(x = "Accuracy (%)", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), 
                group=interaction(cohort,factor(group, levels=group_order)), x=96), 
            position = position_dodge(width = 0.7), hjust = -0.3, size = 4) +
  scale_color_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_fill_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_shape_manual(values = c("1"=21, "2"=22, "3" = 24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_blank())

ggsave("Acc_1cutpoint.pdf",device = "pdf",width = 90, dpi=500, height = 70, units = "mm")

#PPV plot----
ggplot(data=plot_ppv, aes(y=factor(cohort, levels = c("Primary care", "Pooled")),
                          x=Measure1*100, fill = factor(cohort, levels = c("Primary care", "Pooled")), 
                          color=factor(cohort, levels = c("Primary care", "Pooled")),
                          shape=factor(group, levels=group_order))) +
  geom_vline(xintercept = (plot_ppv$Measure1[1])*100, color = "#3c5488ff", linetype = "dotted", alpha=0.5)+
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.25, linewidth = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7), size = 4, stroke = 0.5) +
  scale_x_continuous(limits=c(70,120),breaks = seq(70,120, by=10),expand =c(0,0)) +
  labs(x = "PPV (%)", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), 
                group=interaction(cohort,factor(group, levels=group_order)), x=96), 
            position = position_dodge(width = 0.7), hjust = -0.3, size = 4) +
  scale_color_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_fill_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_shape_manual(values = c("1"=21, "2"=22, "3" = 24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_blank())

ggsave("PPV_1cutpoint.pdf",device = "pdf",width = 90, dpi=500, height = 70, units = "mm")

#NPV plot---- 
ggplot(data=plot_npv, aes(y=factor(cohort, levels = c("Primary care", "Pooled")),
                          x=Measure1*100, fill = factor(cohort, levels = c("Primary care", "Pooled")), 
                          color=factor(cohort, levels = c("Primary care", "Pooled")),
                          shape=factor(group, levels=group_order))) +
  geom_vline(xintercept = (plot_npv$Measure1[1])*100, color = "#3c5488ff", linetype = "dotted", alpha=0.5)+
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.25, linewidth = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7), size = 4, stroke = 0.5) +
  scale_x_continuous(limits=c(70,120),breaks = seq(70,120, by=10),expand =c(0,0)) +
  labs(x = "NPV (%)", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), 
                group=interaction(cohort,factor(group, levels=group_order)), x=96), 
            position = position_dodge(width = 0.7), hjust = -0.3, size = 4) +
  scale_color_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_fill_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_shape_manual(values = c("1"=21, "2"=22, "3" = 24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_blank())

ggsave("NPV_1cutpoint.pdf",device = "pdf",width = 90, dpi=500, height = 70, units = "mm")

#AUC plot---- 
tick_positions <- seq(.70, 1.00, by = 1.0)

ggplot(data=plot_auc, aes(y=factor(cohort, levels = c("Primary care", "Pooled")),
                          x=Measure1, fill = factor(cohort, levels = c("Primary care", "Pooled")), 
                          color=factor(cohort, levels = c("Primary care", "Pooled")),
                          shape=factor(group, levels=group_order))) +
  geom_vline(xintercept = (plot_auc$Measure1[1]), color = "#3c5488ff", linetype = "dotted", alpha=0.5)+
  geom_errorbar(aes(xmin = ci_low , xmax = ci_high ),
                width = 0.25, linewidth = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7), size = 4, stroke = 0.5) +
  scale_x_continuous(limits=c(.85,1.1),breaks = seq(.85,1.1, by=0.05),expand =c(0,0)) +
  labs(x = "AUC", y = "") +
  geom_text(aes(label = sprintf("%.2f (%.2f-%.2f)", Measure1, ci_low, ci_high), 
                group=interaction(cohort,factor(group, levels=group_order)), x=.96), 
            position = position_dodge(width = 0.7), hjust = -0.3, size = 4) +
  scale_color_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_fill_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_shape_manual(values = c("1"=21, "2"=22, "3" = 24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_blank())

ggsave("AUC_1cutpoint.pdf",device = "pdf",width = 90, dpi=500, height = 70, units = "mm")
```

```{r Figure pooled etc. 2cp, echo=F}
library(readxl)
df1 <- read_xlsx("Fig3_pooled_2.xlsx") #change for results Gothenburg etc .
names(df1)[1] <- "Approach"
df1$cohort <- "Pooled"
df5 <-  read_xlsx("Fig3_BFPC.xlsx")
names(df5)[1] <- "Approach"
df5$cohort <- "Primary care"

#2CP
merged_results <- rbind(df1, df5)
merged_results2 <- merged_results %>% filter(Cutpoints == "2 Cutpoints")
merged_results_ptau217 <- merged_results2 %>% filter(method == "Lumipulse")
merged_results_c2n <- merged_results2 %>% filter(method == "C2N")
merged_results_c2nr <- merged_results2 %>% filter(method == "C2N%")

plotdata <- cbind(merged_results_ptau217,merged_results_c2n,merged_results_c2nr)

plot_acc1 <- cbind(plotdata[0:2, 6:8])
plot_acc1$group <- c("1", "1")
colnames(plot_acc1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc2 <- cbind(plotdata[0:2, 28:30])
plot_acc2$group <- c("2", "2")
colnames(plot_acc2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc3 <- cbind(plotdata[0:2, 50:52])
plot_acc3$group <- c("3", "3")
colnames(plot_acc3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc <- rbind(plot_acc1, plot_acc2,plot_acc3)
plot_acc$cohort <- c("Pooled", "Primary care","Pooled","Primary care")

plot_ppv1 <- cbind(plotdata[0:2, 9:11])
plot_ppv1$group <- c("1", "1")
colnames(plot_ppv1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv2 <- cbind(plotdata[0:2, 31:33])
plot_ppv2$group <- c("2", "2")
colnames(plot_ppv2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv3 <- cbind(plotdata[0:2, 53:55])
plot_ppv3$group <- c("3", "3")
colnames(plot_ppv3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv <- rbind(plot_ppv1, plot_ppv2,plot_ppv3)
plot_ppv$cohort <- c("Pooled", "Primary care","Pooled","Primary care")

plot_npv1 <- cbind(plotdata[0:2, 12:14])
plot_npv1$group <- c("1", "1")
colnames(plot_npv1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv2 <- cbind(plotdata[0:2, 34:36])
plot_npv2$group <- c("2", "2")
colnames(plot_npv2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv3 <- cbind(plotdata[0:2, 56:58])
plot_npv3$group <- c("3", "3")
colnames(plot_npv3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv <- rbind(plot_npv1, plot_npv2,plot_npv3)
plot_npv$cohort <- c("Pooled", "Primary care","Pooled","Primary care")

plot_grey1 <- cbind(plotdata[0:2, 18:20])
plot_grey1$group <- c("1", "1")
colnames(plot_grey1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_grey2 <- cbind(plotdata[0:2, 40:42])
plot_grey2$group <- c("2", "2")
colnames(plot_grey2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_grey3 <- cbind(plotdata[0:2, 62:64])
plot_grey3$group <- c("3", "3")
colnames(plot_grey3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_grey <- rbind(plot_grey1, plot_grey2,plot_grey3)
plot_grey$cohort <- c("Pooled", "BF-PC")

tick_positions <- seq(60, 100, by = 10)
group_order <- c("3","2", "1")

#Accuracy plot----
ggplot(data=plot_acc, aes(y=factor(cohort, levels = c("Primary care", "Pooled")),
                          x=Measure1*100, fill = factor(cohort, levels = c("Primary care", "Pooled")), 
                          color=factor(cohort, levels = c("Primary care", "Pooled")),
                          shape=factor(group, levels=group_order))) +
  geom_vline(xintercept = (plot_acc$Measure1[1])*100, color = "#3c5488ff", linetype = "dotted", alpha=0.5)+
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.25, linewidth = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7), size = 4, stroke = 0.5) +
  scale_x_continuous(limits=c(70,120),breaks = seq(70,120, by=10),expand =c(0,0)) +
  labs(x = "Accuracy (%)", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), 
                group=interaction(cohort,factor(group, levels=group_order)), x=96), 
            position = position_dodge(width = 0.7), hjust = -0.3, size = 4) +
  scale_color_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_fill_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  #scale_shape_manual(values = c("2"=21, "1"=22), labels=c("P-tau217", "P-tau217/AB42")) +
  scale_shape_manual(values = c("1"=21, "2"=22, "3" = 24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_blank())

ggsave("Acc_2cutpoint.pdf",device = "pdf",width = 90, dpi=500, height = 70, units = "mm")


#PPV plot----
ggplot(data=plot_ppv, aes(y=factor(cohort, levels = c("Primary care", "Pooled")),
                          x=Measure1*100, fill = factor(cohort, levels = c("Primary care", "Pooled")), 
                          color=factor(cohort, levels = c("Primary care", "Pooled")),
                          shape=factor(group, levels=group_order))) +
  geom_vline(xintercept = (plot_ppv$Measure1[1])*100, color = "#3c5488ff", linetype = "dotted", alpha=0.5)+
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.25, linewidth = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7), size = 4, stroke = 0.5) +
  scale_x_continuous(limits=c(70,120),breaks = seq(70,120, by=10),expand =c(0,0)) +
  labs(x = "PPV (%)", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), 
                group=interaction(cohort,factor(group, levels=group_order)), x=96), 
            position = position_dodge(width = 0.7), hjust = -0.3, size = 4) +
  scale_color_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_fill_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  #scale_shape_manual(values = c("2"=21, "1"=22), labels=c("P-tau217", "P-tau217/AB42")) +
  scale_shape_manual(values = c("1"=21, "2"=22, "3" = 24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_blank())

ggsave("PPV_2cutpoint.pdf",device = "pdf",width = 90, dpi=500, height = 70, units = "mm")

#NPV plot---- 
ggplot(data=plot_npv, aes(y=factor(cohort, levels = c("Primary care", "Pooled")),
                          x=Measure1*100, fill = factor(cohort, levels = c("Primary care", "Pooled")), 
                          color=factor(cohort, levels = c("Primary care", "Pooled")),
                          shape=factor(group, levels=group_order))) +
  geom_vline(xintercept = (plot_npv$Measure1[1])*100, color = "#3c5488ff", linetype = "dotted", alpha=0.5)+
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.25, linewidth = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7), size = 4, stroke = 0.5) +
  scale_x_continuous(limits=c(70,120),breaks = seq(70,120, by=10),expand =c(0,0)) +
  labs(x = "NPV (%)", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), 
                group=interaction(cohort,factor(group, levels=group_order)), x=96), 
            position = position_dodge(width = 0.7), hjust = -0.3, size = 4) +
  scale_color_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_fill_manual(values=c("#79AF97FF", "#3c5488ff"), guide="none") +
  scale_shape_manual(values = c("1"=21, "2"=22, "3" = 24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_blank())

ggsave("NPV_2cutpoint.pdf",device = "pdf",width = 90, dpi=500, height = 70, units = "mm")

#grey----
library(ggpattern)

desired_order <- c("Pooled","Primary care")
group_order <- c("1", "2", "3")
group_colors <- c("#79AF97FF", "#3c5488ff")

ggplot(data = plot_grey, aes(x = factor(cohort, levels = desired_order),  y = Measure1, fill = factor(cohort, levels = desired_order), 
                             pattern = factor(group, levels = group_order))) +
  geom_bar_pattern(stat = "identity",position = position_dodge(width = 0.7), color = "black", 
                   width = 0.7, pattern_fill = "white",
                   pattern_color = "white", pattern_density = 0.3,
                   size = 0.2) +
  geom_errorbar(aes(ymax = ci_high, ymin = ci_low),position = position_dodge(width = 0.7), 
                width = 0.2, size = 0.5, color = "black") +
  geom_text(aes(label = sprintf("%.f", Measure1)), position = position_dodge(width = 0.7), 
            vjust = -4, size = 4) +
  scale_fill_manual(values=c("#3c5488ff", "#79AF97FF"), guide="none") +
  scale_y_continuous(limits = c(0, 25), breaks = seq(0, 25, by = 5),  expand = c(0, 0)) +
  scale_pattern_manual(values = c("stripe", "none", "circle"), 
                       labels = c("p-tau217 Lumipulse", "p-tau217 C2N", "%p-tau217 C2N")) +
  labs(title = element_blank(), 
       x = "", 
       y = "Intermediate values (%)") +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1, face = "bold"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(face = "bold", size = 10),
    panel.border = element_rect(linewidth = 0.5, fill = NA, color = NA),
    legend.title = element_blank()
  )

ggsave("Intermediates_pooled_v3.pdf",device = "pdf",width = 120, dpi=500, height = 70, units = "mm")
```


#Comorbidity plots C2N p-tau217
```{r setup c2n ptau217, echo=FALSE}
library(boot)
library(cutpointr) #Used for PPV and NPV
library(pROC)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(openxlsx)
library(ggpubr)

BFMC <- read_xlsx("BFMC_data.xlsx")
BFPC <- read_xlsx("BFPC_data.xlsx")
Bre <- read_xlsx("Brescia_data.xlsx")
Got <- read_xlsx("Gothenburg_data_C2N.xlsx")
Bres <- read_xlsx("Brescia_data_C2N.xlsx")

lumi <- rbind(BFMC, Bres, Got, BFPC)
lumi <- lumi %>% drop_na(p_tau217_v2)

lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 
lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 

lumi.df <- lumi
```

```{r boxplot sex c2n ptau217, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = sex)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
  geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +
  scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Males", "Females"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Males", "Females"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, by = 5)) +
  geom_hline(yintercept = 2.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 25)

ggsave("Boxplot_sex_C2Nptau217.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")
```

```{r boxplot APOE c2n ptau217, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = apoe)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
  geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +
   scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Non-carriers", "Carriers"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Non-carriers", "Carriers"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, by = 5)) +
  geom_hline(yintercept = 2.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 25)

ggsave("Boxplot_APOE_C2Nptau217.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

```{r boxplot diabetes c2n ptau217, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = diabetes)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
  geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +
  scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Diabetes-", "Diabetes+"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Diabetes-", "Diabetes+"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, by = 5)) +
  geom_hline(yintercept = 2.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 25)

ggsave("Boxplot_diabetes_C2Nptau217.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

```{r boxplot CKD c2n ptau217, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = CKD)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
  geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +
   scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("CKD-", "CKD+"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("CKD-", "CKD+"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, by = 5)) +
  geom_hline(yintercept = 2.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 25)

ggsave("Boxplot_CKD_C2Nptau217.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

```{r boxplot Educ c2n ptau217, echo=F}
lumi <- lumi.df
lumi$education_median <- ifelse(lumi$education < median(lumi$education, na.rm = TRUE), 0, 1)
lumi <- lumi %>% rename(strat = education_median)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
  #geom_jitter(aes(color = factor(strat)), size = 0.6, alpha = 0.25, width=0.2) +
  geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +
   scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("< 10 years", "> 10 years"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("< 10 years", "> 10 years"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, by = 5)) +
  geom_hline(yintercept = 2.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 25)

ggsave("Boxplot_Education_C2Nptau217.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

```{r boxplot age c2n ptau217, echo=F}
library(ggsignif)
lumi <- lumi.df
lumi$age_category <- ifelse(lumi$age >= 80, 2, ifelse(lumi$age < median(lumi$age[lumi$age < 80], na.rm = TRUE), 0, 1)) #73
lumi <- lumi %>% rename(strat = age_category)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)
lumi.3 <- lumi %>% filter(strat == 2)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

stat_test <- compare_means(p_tau217_v2 ~ strat,  data = lumi, group.by = "csf_status", method="t.test")
my_comparisons <- list( c("2", "1"), c("2", "0"), c("1", "0"))
my_comparisons <- list( c("<73", "73-80"), c("<73", "> 80"), c("73-80", "> 80"))

stat_test$p.adj <- round(stat_test$p.adj,3)
stat_test$p <- round(stat_test$p,3)
lumi$group <- interaction(lumi$csf_status, lumi$strat)

ggplot(lumi, aes(x = csf_status, y = p_tau217_v2, group = group)) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +
  scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF", "#3C5488FF"), labels = c("<73", "73-80", "> 80"), name="Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF", "#3C5488FF"), guide = "none", labels = c("<73", "73-80", "> 80")) +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, by = 5)) +
  geom_hline(yintercept = 2.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.y = 25)

ggsave("Boxplot_age_C2Nptau217.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")
stat_test
```





#Comorbidity plots C2N %p-tau217
```{r setup %c2n, echo=FALSE}
library(boot)
library(cutpointr) #Used for PPV and NPV
library(pROC)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(openxlsx)
library(ggpubr)

BFMC <- read_xlsx("BFMC_data.xlsx")
BFPC <- read_xlsx("BFPC_data.xlsx")
Bre <- read_xlsx("Brescia_data.xlsx")
Got <- read_xlsx("Gothenburg_data_C2N.xlsx")
Bres <- read_xlsx("Brescia_data_C2N.xlsx")

lumi <- rbind(BFMC, Bres, Got, BFPC)
lumi <- lumi %>% drop_na(p_tau217_ratio_v2)

lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 
lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 

lumi.df <- lumi
```

```{r boxplot sex %c2n, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = sex)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_ratio_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +  scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Males", "Females"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Males", "Females"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 5)) +
  geom_hline(yintercept = 4.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma %p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 30)

ggsave("Boxplot_sex_ratioC2N.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")
```

```{r boxplot APOE %c2n, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = apoe)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_ratio_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) + scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Non-carriers", "Carriers"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Non-carriers", "Carriers"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 5)) +
  geom_hline(yintercept = 4.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma %p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 30)

ggsave("Boxplot_APOE_ratioC2N.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

```{r boxplot diabetes %c2n, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = diabetes)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_ratio_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) + scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Diabetes-", "Diabetes+"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("Diabetes-", "Diabetes+"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 5)) +
  geom_hline(yintercept = 4.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma %p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 30)

ggsave("Boxplot_diabetes_ratioC2N.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

```{r boxplot CKD %c2n, echo=F}
lumi <- lumi.df
lumi <- lumi %>% rename(strat = CKD)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_ratio_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +   scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("CKD-", "CKD+"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("CKD-", "CKD+"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 5)) +
  geom_hline(yintercept = 4.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma %p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 30)

ggsave("Boxplot_CKD_ratioC2N.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

```{r boxplot Educ %c2n, echo=F}
lumi <- lumi.df
lumi$education_median <- ifelse(lumi$education < median(lumi$education, na.rm = TRUE), 0, 1)
lumi <- lumi %>% rename(strat = education_median)
lumi <- lumi %>% drop_na(strat)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

ggplot(lumi, aes(x = csf_status, y = p_tau217_ratio_v2, group = interaction(csf_status, strat))) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +   scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("< 10 years", "> 10 years"), name = "Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF"), labels = c("< 10 years", "> 10 years"), guide="none") +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 5)) +
  geom_hline(yintercept = 4.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma %p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.x = 1.5, label.y = 30)

ggsave("Boxplot_Education_ratioC2N.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")

```

```{r boxplot age %c2n, echo=F}
library(ggsignif)
lumi <- lumi.df
lumi$age_category <- ifelse(lumi$age >= 80, 2, ifelse(lumi$age < median(lumi$age[lumi$age < 80], na.rm = TRUE), 0, 1)) #73
lumi <- lumi %>% rename(strat = age_category)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)
lumi.3 <- lumi %>% filter(strat == 2)

lumi$csf_status <- as.factor(as.numeric(lumi$csf_status))

stat_test <- compare_means(p_tau217_ratio_v2 ~ strat,  data = lumi, group.by = "csf_status", method="t.test")

my_comparisons <- list( c("2", "1"), c("2", "0"), c("1", "0"))
my_comparisons <- list( c("<73", "73-80"), c("<73", "> 80"), c("73-80", "> 80"))

stat_test$p.adj <- round(stat_test$p.adj,3)
stat_test$p <- round(stat_test$p,3)
lumi$group <- interaction(lumi$csf_status, lumi$strat)

ggplot(lumi, aes(x = csf_status, y = p_tau217_ratio_v2, group = group)) +
  geom_boxplot(aes(fill = factor(strat)), position = position_dodge(0.8), width = 0.7, outlier.shape = NA, alpha=0.7) +
geom_jitter(aes(color = factor(strat)), 
              size = 0.6, alpha = 0.25, 
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.5)) +  scale_fill_manual(values = c("#4DBBD5FF", "#E64B35FF", "#3C5488FF"), labels = c("<73", "73-80", "> 80"), name="Legend") +
  scale_color_manual(values = c("#4DBBD5FF", "#E64B35FF", "#3C5488FF"), guide = "none", labels = c("<73", "73-80", "> 80")) +
  scale_alpha_manual(values = c(0.25, 0.75), guide = "none", labels = c("0" = "Negatives", "1" = "Positives")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0, 35, by = 5)) +
  geom_hline(yintercept = 4.27, linetype = "dotted", color = "grey20") +
  scale_x_discrete(labels = c("0" = "Negatives", "1" = "Positives")) +
  labs(x = "AD status", y = "Plasma %p-tau217 C2N") +
  theme_classic()+
  stat_compare_means(method="t.test", label="p.signif", label.y = 30)

ggsave("Boxplot_age_ratioC2N.pdf",device = "pdf",width = 120, dpi=500, height = 80, units = "mm")
stat_test
```



#Comorbidity comparisons for age with C2N and Lumipulse

##Set up dataset for this
```{r setup, include=FALSE}
library(boot)
library(cutpointr) #Used for PPV and NPV
library(pROC)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(openxlsx)

BFMC <- read_xlsx("BFMC_data.xlsx")
BFPC <- read_xlsx("BFPC_data.xlsx")
Bre <- read_xlsx("Brescia_data.xlsx")
Got <- read_xlsx("Gothenburg_data_C2N.xlsx")
Bres <- read_xlsx("Brescia_data_C2N.xlsx")

lumi <- rbind(BFMC, Bres, Got, BFPC)

lumi <- lumi %>% drop_na(p_tau217_ratio_v2,p_tau217_v2) #1132

lumi$ptau217_spec90_lumi <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95_lumi <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95_lumi <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 
lumi$ptau217_spec95_c2n <- ifelse(lumi$p_tau217_v2 > 2.92, 1, 0)
lumi$ptau217_sens95_c2n <- ifelse(lumi$p_tau217_v2 > 1.59, 1, 0)

lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 
lumi$ptau217_spec95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 5.08, 1, 0)
lumi$ptau217_sens95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 3.55, 1, 0)

lumi.df <- lumi
```


##Do age comparisons
```{r C2N vs. Lumipulse split by age, echo=F}
lumi <- lumi.df
lumi$age_category <- ifelse(lumi$age >= 80, 2, ifelse(lumi$age < median(lumi$age[lumi$age < 80], na.rm = TRUE), 0, 1)) #73
lumi <- lumi %>% rename(strat = age_category)
lumi.1 <- lumi %>% filter(strat ==0)
lumi.2 <- lumi %>% filter(strat == 1)
lumi.3 <- lumi %>% filter(strat == 2)

##Fit ROC curve and define threshold at 90% specificity ----
#Lumi
roc_curve1_lumi <- pROC::roc(csf_status~pl_ptau217, data=lumi.1, quiet=T)
coordinates1lumi <- coords(roc_curve1_lumi, x="all", transpose=F)
auc1lumi <- ci.auc(roc_curve1_lumi)[2]
roc_curve2_lumi <- pROC::roc(csf_status~pl_ptau217, data=lumi.2, quiet=T)
coordinates2lumi <- coords(roc_curve2_lumi, x="all", transpose=F)
auc2lumi <- ci.auc(roc_curve2_lumi)[2]
roc_curve3_lumi <- pROC::roc(csf_status~pl_ptau217, data=lumi.3, quiet=T)
coordinates3lumi <- coords(roc_curve3_lumi, x="all", transpose=F)
auc3lumi <- ci.auc(roc_curve3_lumi)[2]

#C2N
roc_curve1_c2n <- pROC::roc(csf_status~p_tau217_v2, data=lumi.1, quiet=T)
coordinates1c2n <- coords(roc_curve1_c2n, x="all", transpose=F)
auc1c2n <- ci.auc(roc_curve1_c2n)[2]
roc_curve2_c2n <- pROC::roc(csf_status~p_tau217_v2, data=lumi.2, quiet=T)
coordinates2c2n <- coords(roc_curve2_c2n, x="all", transpose=F)
auc2c2n <- ci.auc(roc_curve2_c2n)[2]
roc_curve3_c2n <- pROC::roc(csf_status~p_tau217_v2, data=lumi.3, quiet=T)
coordinates3c2n <- coords(roc_curve3_c2n, x="all", transpose=F)
auc3c2n <- ci.auc(roc_curve3_c2n)[2]

#C2Nratio
roc_curve1_c2nr <- pROC::roc(csf_status~p_tau217_ratio_v2, data=lumi.1, quiet=T)
coordinates1c2nr <- coords(roc_curve1_c2nr, x="all", transpose=F)
auc1c2nr <- ci.auc(roc_curve1_c2nr)[2]
roc_curve2_c2nr <- pROC::roc(csf_status~p_tau217_ratio_v2, data=lumi.2, quiet=T)
coordinates2c2nr <- coords(roc_curve2_c2nr, x="all", transpose=F)
auc2c2nr <- ci.auc(roc_curve2_c2nr)[2]
roc_curve3_c2nr <- pROC::roc(csf_status~p_tau217_ratio_v2, data=lumi.3, quiet=T)
coordinates3c2nr <- coords(roc_curve3_c2nr, x="all", transpose=F)
auc3c2nr <- ci.auc(roc_curve3_c2nr)[2]

##AUC deLong----
biomarkers <- c("pl_ptau217", "p_tau217_v2", "p_tau217_ratio_v2")
results_delong <- list()

for (i in seq_along(biomarkers)) {
  for (j in seq_along(biomarkers)) {
    if (i < j) {

      predictor1 <- biomarkers[i]
      predictor2 <- biomarkers[j]

      # Create formulas for the biomarkers
      formula1 <- as.formula(paste("csf_status ~", predictor1))
      formula2 <- as.formula(paste("csf_status ~", predictor2))

      # Generate ROC curves for each lumi dataset
      roc_curve1_1 <- pROC::roc(formula1, data = lumi.1, quiet = TRUE)
      roc_curve1_2 <- pROC::roc(formula2, data = lumi.1, quiet = TRUE)
      roc_curve2_1 <- pROC::roc(formula1, data = lumi.2, quiet = TRUE)
      roc_curve2_2 <- pROC::roc(formula2, data = lumi.2, quiet = TRUE)
      roc_curve3_1 <- pROC::roc(formula1, data = lumi.3, quiet = TRUE)
      roc_curve3_2 <- pROC::roc(formula2, data = lumi.3, quiet = TRUE)

      # Compare ROC curves within each age group
      res1 <- roc.test(roc_curve1_1, roc_curve1_2, method = "delong")
      res2 <- roc.test(roc_curve2_1, roc_curve2_2, method = "delong")
      res3 <- roc.test(roc_curve3_1, roc_curve3_2, method = "delong")
      
      #Compare ROC curves within each biomarker
      res4 <- roc.test(roc_curve1_1, roc_curve2_1, method = "delong")
      res5 <- roc.test(roc_curve1_1, roc_curve3_1, method = "delong")
      res6 <- roc.test(roc_curve2_1, roc_curve3_1, method = "delong")
      res7 <- roc.test(roc_curve1_2, roc_curve2_2, method = "delong")
      res8 <- roc.test(roc_curve1_2, roc_curve3_2, method = "delong")
      res9 <- roc.test(roc_curve2_2, roc_curve3_2, method = "delong")

      long <- data.frame(
        comp = paste(predictor1, predictor2, sep = " vs. "),
        auc1_age1 = round(roc_curve1_1$auc, 3),
        auc2_age1 = round(roc_curve1_2$auc, 3),
        pval_age1 = round(res1$p.value, 3),
        
        auc1_age2 = round(roc_curve2_1$auc, 3),
        auc2_age2 = round(roc_curve2_2$auc, 3),
        pval_age2 = round(res2$p.value, 3),
        
        auc1_age3 = round(roc_curve3_1$auc, 3),
        auc2_age3 = round(roc_curve3_2$auc, 3),
        pval_age3 = round(res3$p.value, 3),
        
        p_group1_age12 = round(res4$p.value, 3),
        p_group1_age13 = round(res5$p.value, 3),
        p_group1_age23 = round(res6$p.value, 3),
        
        p_group2_age12 = round(res7$p.value, 3),
        p_group2_age13 = round(res8$p.value, 3),
        p_group2_age23 = round(res9$p.value, 3)
        
      )

      results_delong[[length(results_delong) + 1]] <- long
    }
  }
}
results_delong <- do.call(rbind.data.frame, results_delong)
openxlsx::write.xlsx(results_delong,
                     file="C2N_DeLong_Age.xlsx")


##Calculate Accuracy, PPV, NPV and 95% CIs ----

f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d1 <- d %>% filter(strat == 0)
  d2 <- d %>% filter(strat == 1)
  d3 <- d %>% filter(strat == 2)
  
  compute_metrics <- function(d, assay) {
    v_tp <- sum(d$csf_status == 1 & d[[assay]] == 1)
    v_fp <- sum(d$csf_status == 0 & d[[assay]] == 1)
    v_tn <- sum(d$csf_status == 0 & d[[assay]] == 0)
    v_fn <- sum(d$csf_status == 1 & d[[assay]] == 0)
    
    sens <- v_tp / (v_tp + v_fn)
    spec <- v_tn / (v_tn + v_fp)
    acc <- (v_tp + v_tn) / (v_tp + v_tn + v_fn + v_fp)
    ppv <- ppv(tp = v_tp, fp = v_fp, tn = v_tn, fn = v_fn)
    npv <- npv(tp = v_tp, fp = v_fp, tn = v_tn, fn = v_fn)
    
    list(sens = sens, spec = spec, acc = acc, ppv = ppv, npv = npv)
  }
  
  # Metrics for LUMI
  lumi1 <- compute_metrics(d1, "ptau217_spec90_lumi")
  lumi2 <- compute_metrics(d2, "ptau217_spec90_lumi")
  lumi3 <- compute_metrics(d3, "ptau217_spec90_lumi")
  
  # Metrics for C2N
  c2n1 <- compute_metrics(d1, "ptau217_spec90_c2n")
  c2n2 <- compute_metrics(d2, "ptau217_spec90_c2n")
  c2n3 <- compute_metrics(d3, "ptau217_spec90_c2n")

  # Metrics for C2NR
  c2nr1 <- compute_metrics(d1, "ptau217_spec90_c2nr")
  c2nr2 <- compute_metrics(d2, "ptau217_spec90_c2nr")
  c2nr3 <- compute_metrics(d3, "ptau217_spec90_c2nr")
  
  # Calculate differences between groups Lumi
  diff_acc_lumi12 <- lumi1$acc - lumi2$acc
  diff_ppv_lumi12 <- lumi1$ppv - lumi2$ppv
  diff_npv_lumi12 <- lumi1$npv - lumi2$npv
  
  diff_acc_lumi13 <- lumi1$acc - lumi3$acc
  diff_ppv_lumi13 <- lumi1$ppv - lumi3$ppv
  diff_npv_lumi13 <- lumi1$npv - lumi3$npv
  
  diff_acc_lumi23 <- lumi2$acc - lumi3$acc
  diff_ppv_lumi23 <- lumi2$ppv - lumi3$ppv
  diff_npv_lumi23 <- lumi2$npv - lumi3$npv
  
  # Calculate differences between groups C2N
  diff_acc_c2n12 <- c2n1$acc - c2n2$acc
  diff_ppv_c2n12 <- c2n1$ppv - c2n2$ppv
  diff_npv_c2n12 <- c2n1$npv - c2n2$npv
  
  diff_acc_c2n13 <- c2n1$acc - c2n3$acc
  diff_ppv_c2n13 <- c2n1$ppv - c2n3$ppv
  diff_npv_c2n13 <- c2n1$npv - c2n3$npv
  
  diff_acc_c2n23 <- c2n2$acc - c2n3$acc
  diff_ppv_c2n23 <- c2n2$ppv - c2n3$ppv
  diff_npv_c2n23 <- c2n2$npv - c2n3$npv
  
  # Calculate differences between groups C2N%
  diff_acc_c2nr12 <- c2nr1$acc - c2nr2$acc
  diff_ppv_c2nr12 <- c2nr1$ppv - c2nr2$ppv
  diff_npv_c2nr12 <- c2nr1$npv - c2nr2$npv
  
  diff_acc_c2nr13 <- c2nr1$acc - c2nr3$acc
  diff_ppv_c2nr13 <- c2nr1$ppv - c2nr3$ppv
  diff_npv_c2nr13 <- c2nr1$npv - c2nr3$npv
  
  diff_acc_c2nr23 <- c2nr2$acc - c2nr3$acc
  diff_ppv_c2nr23 <- c2nr2$ppv - c2nr3$ppv
  diff_npv_c2nr23 <- c2nr2$npv - c2nr3$npv
  
  # Compare LUMI vs. C2N

  diff_acc_lumi_c2n1 <- lumi1$acc - c2n1$acc
  diff_ppv_lumi_c2n1 <- lumi1$ppv - c2n1$ppv
  diff_npv_lumi_c2n1 <- lumi1$npv - c2n1$npv

  diff_acc_lumi_c2n2 <- lumi2$acc - c2n2$acc
  diff_ppv_lumi_c2n2 <- lumi2$ppv - c2n2$ppv
  diff_npv_lumi_c2n2 <- lumi2$npv - c2n2$npv

  diff_acc_lumi_c2n3 <- lumi3$acc - c2n3$acc
  diff_ppv_lumi_c2n3 <- lumi3$ppv - c2n3$ppv
  diff_npv_lumi_c2n3 <- lumi3$npv - c2n3$npv
  
  # Compare LUMI vs. C2NR
  
  diff_acc_lumi_c2nr1 <- lumi1$acc -  c2nr1$acc
  diff_ppv_lumi_c2nr1 <- lumi1$ppv -  c2nr1$ppv
  diff_npv_lumi_c2nr1 <- lumi1$npv -  c2nr1$npv

  diff_acc_lumi_c2nr2 <- lumi2$acc -  c2nr2$acc
  diff_ppv_lumi_c2nr2 <- lumi2$ppv -  c2nr2$ppv
  diff_npv_lumi_c2nr2 <- lumi2$npv -  c2nr2$npv

  diff_acc_lumi_c2nr3 <- lumi3$acc -  c2nr3$acc
  diff_ppv_lumi_c2nr3 <- lumi3$ppv -  c2nr3$ppv
  diff_npv_lumi_c2nr3 <- lumi3$npv -  c2nr3$npv

  # Compare C2N vs. C2NR
  diff_acc_c2n_c2nr1 <- c2n1$acc - c2nr1$acc
  diff_ppv_c2n_c2nr1 <- c2n1$ppv - c2nr1$ppv
  diff_npv_c2n_c2nr1 <- c2n1$npv - c2nr1$npv
  
  diff_acc_c2n_c2nr2 <- c2n2$acc - c2nr2$acc
  diff_ppv_c2n_c2nr2 <- c2n2$ppv - c2nr2$ppv
  diff_npv_c2n_c2nr2 <- c2n2$npv - c2nr2$npv
  
  diff_acc_c2n_c2nr3 <- c2n3$acc - c2nr3$acc
  diff_ppv_c2n_c2nr3 <- c2n3$ppv - c2nr3$ppv
  diff_npv_c2n_c2nr3 <- c2n3$npv - c2nr3$npv
  
  return(c(lumi1$acc, lumi1$ppv, lumi1$npv, lumi2$acc, lumi2$ppv, lumi2$npv, lumi3$acc, lumi3$ppv, lumi3$npv, #9
           diff_acc_lumi12, diff_ppv_lumi12, diff_npv_lumi12,diff_acc_lumi13, diff_ppv_lumi13, diff_npv_lumi13,diff_acc_lumi23, diff_ppv_lumi23, diff_npv_lumi23,#18
           c2n1$acc, c2n1$ppv, c2n1$npv, c2n2$acc, c2n2$ppv, c2n2$npv, c2n3$acc, c2n3$ppv, c2n3$npv, #27
           diff_acc_c2n12, diff_ppv_c2n12, diff_npv_c2n12,diff_acc_c2n13, diff_ppv_c2n13, diff_npv_c2n13,diff_acc_c2n23, diff_ppv_c2n23, diff_npv_c2n23,#36
           c2nr1$acc, c2nr1$ppv, c2nr1$npv, c2nr2$acc, c2nr2$ppv, c2nr2$npv, c2nr3$acc, c2nr3$ppv, c2nr3$npv, #45
           diff_acc_c2nr12, diff_ppv_c2nr12, diff_npv_c2nr12,diff_acc_c2nr13, diff_ppv_c2nr13, diff_npv_c2nr13,diff_acc_c2nr23, diff_ppv_c2nr23, diff_npv_c2nr23,#54
           
           diff_acc_lumi_c2n1, diff_ppv_lumi_c2n1, diff_npv_lumi_c2n1, diff_acc_lumi_c2n2, diff_ppv_lumi_c2n2, diff_npv_lumi_c2n2, diff_acc_lumi_c2n3, diff_ppv_lumi_c2n3, diff_npv_lumi_c2n3, #63
           
           diff_acc_lumi_c2nr1, diff_ppv_lumi_c2nr1, diff_npv_lumi_c2nr1,diff_acc_lumi_c2nr2, diff_ppv_lumi_c2nr2, diff_npv_lumi_c2nr2, diff_acc_lumi_c2nr3, diff_ppv_lumi_c2nr3, diff_npv_lumi_c2nr3,#72
           
           diff_acc_c2n_c2nr1, diff_ppv_c2n_c2nr1, diff_npv_c2n_c2nr1,diff_acc_c2n_c2nr2, diff_ppv_c2n_c2nr2, diff_npv_c2n_c2nr2,diff_acc_c2n_c2nr3, diff_ppv_c2n_c2nr3, diff_npv_c2n_c2nr3))
}

set.seed(12345)
boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

##Add results to dataframe LUMI ----
results_1cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = round(ci.auc(roc_curve1_lumi)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1_lumi)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1_lumi)[3],3),
  accuracy1 = round(boot_results$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[2], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[3], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  
  auc2 = round(ci.auc(roc_curve2_lumi)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2_lumi)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2_lumi)[3],3),
  accuracy2 = round(boot_results$t0[4], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[5], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[6], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3_lumi)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3_lumi)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3_lumi)[3],3),
  accuracy3 = round(boot_results$t0[7], 3),
  acc_ci_lower3 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[1],3),
  acc_ci_upper3 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[2],3),
  PPV3 = round(boot_results$t0[8], 3),
  ppv_ci_lower3 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  ppv_ci_upper3 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  NPV3 = round(boot_results$t0[9], 3),
  npv_ci_lower3 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper3 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  
  diff_acc12 = round(boot_results$t0[10], 3),
  diffacc_cilow12 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[1],3),
  diffacc_ciup12 = round(quantile(boot_results$t[,10], c(0.025, 0.975))[2],3),
  diff_ppv12 = round(boot_results$t0[11], 3),
  diffppv_cilow12 = round(quantile(boot_results$t[,11], c(0.025, 0.975))[1],3),
  diffppv_ciup12 = round(quantile(boot_results$t[,11], c(0.025, 0.975))[2],3),
  diff_npv12 = round(boot_results$t0[12], 3),
  diffnpv_cilow12 = round(quantile(boot_results$t[,12], c(0.025, 0.975))[1],3),
  diffnpv_ciup12 = round(quantile(boot_results$t[,12], c(0.025, 0.975))[2],3),
  
  diff_acc13 = round(boot_results$t0[13], 3),
  diffacc_cilow13 = round(quantile(boot_results$t[,13], c(0.025, 0.975))[1],3),
  diffacc_ciup13 = round(quantile(boot_results$t[,13], c(0.025, 0.975))[2],3),
  diff_ppv13 = round(boot_results$t0[14], 3),
  diffppv_cilow13 = round(quantile(boot_results$t[,14], c(0.025, 0.975))[1],3),
  diffppv_ciup13 = round(quantile(boot_results$t[,14], c(0.025, 0.975))[2],3),
  diff_npv13 = round(boot_results$t0[15], 3),
  diffnpv_cilow13 = round(quantile(boot_results$t[,15], c(0.025, 0.975))[1],3),
  diffnpv_ciup13 = round(quantile(boot_results$t[,15], c(0.025, 0.975))[2],3),
  
  diff_acc23 = round(boot_results$t0[16], 3),
  diffacc_cilow23 = round(quantile(boot_results$t[,16], c(0.025, 0.975))[1],3),
  diffacc_ciup23 = round(quantile(boot_results$t[,16], c(0.025, 0.975))[2],3),
  diff_ppv23 = round(boot_results$t0[17], 3),
  diffppv_cilow23 = round(quantile(boot_results$t[,17], c(0.025, 0.975))[1],3),
  diffppv_ciup23 = round(quantile(boot_results$t[,17], c(0.025, 0.975))[2],3),
  diff_npv23 = round(boot_results$t0[18], 3),
  diffnpv_cilow23 = round(quantile(boot_results$t[,18], c(0.025, 0.975))[1],3),
  diffnpv_ciup23 = round(quantile(boot_results$t[,18], c(0.025, 0.975))[2],3),
  
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  
  intermediate_n3 = NA,
  intermediate_cilow3 = NA,
  intermediate_cihigh3 = NA,
  intermediate_n_percentage3= NA,
  intermediate_n_percentage_low3= NA,
  intermediate_n_percentage_high3= NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")


##Add results C2N----
results_1cp_c2n <- data.frame(
  method = "C2N",
  auc1 = round(ci.auc(roc_curve1_c2n)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1_c2n)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1_c2n)[3],3),
  accuracy1 = round(boot_results$t0[19], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,19], c(0.025, 0.975), na.rm=T)[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,19], c(0.025, 0.975), na.rm=T)[2],3),
  PPV1 = round(boot_results$t0[20], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,20], c(0.025, 0.975), na.rm=T)[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,20], c(0.025, 0.975), na.rm=T)[2],3),
  NPV1 = round(boot_results$t0[21], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,21], c(0.025, 0.975), na.rm=T)[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,21], c(0.025, 0.975), na.rm=T)[2],3),
  
  auc2 = round(ci.auc(roc_curve2_c2n)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2_c2n)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2_c2n)[3],3),
  accuracy2 = round(boot_results$t0[22], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,22], c(0.025, 0.975), na.rm=T)[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,22], c(0.025, 0.975), na.rm=T)[2],3),
  PPV2 = round(boot_results$t0[23], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,23], c(0.025, 0.975), na.rm=T)[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,23], c(0.025, 0.975), na.rm=T)[2],3),
  NPV2 = round(boot_results$t0[24], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,24], c(0.025, 0.975), na.rm=T)[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,24], c(0.025, 0.975), na.rm=T)[2],3),
  
  auc3 = round(ci.auc(roc_curve3_c2n)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3_c2n)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3_c2n)[3],3),
  accuracy3 = round(boot_results$t0[25], 3),
  acc_ci_lower3 = round(quantile(boot_results$t[,25], c(0.025, 0.975), na.rm=T)[1],3),
  acc_ci_upper3 = round(quantile(boot_results$t[,25], c(0.025, 0.975), na.rm=T)[2],3),
  PPV3 = round(boot_results$t0[26], 3),
  ppv_ci_lower3 = round(quantile(boot_results$t[,26], c(0.025, 0.975), na.rm=T)[1],3),
  ppv_ci_upper3 = round(quantile(boot_results$t[,26], c(0.025, 0.975), na.rm=T)[2],3),
  NPV3 = round(boot_results$t0[27], 3),
  npv_ci_lower3 = round(quantile(boot_results$t[,27], c(0.025, 0.975), na.rm=T)[1],3),
  npv_ci_upper3 = round(quantile(boot_results$t[,27], c(0.025, 0.975), na.rm=T)[2],3),
  
  diff_acc12 = round(boot_results$t0[28], 3),
  diffacc_cilow12 = round(quantile(boot_results$t[,28], c(0.025, 0.975), na.rm=T)[1],3),
  diffacc_ciup12 = round(quantile(boot_results$t[,28], c(0.025, 0.975), na.rm=T)[2],3),
  diff_ppv12 = round(boot_results$t0[29], 3),
  diffppv_cilow12 = round(quantile(boot_results$t[,29], c(0.025, 0.975), na.rm=T)[1],3),
  diffppv_ciup12 = round(quantile(boot_results$t[,29], c(0.025, 0.975), na.rm=T)[2],3),
  diff_npv12 = round(boot_results$t0[30], 3),
  diffnpv_cilow12 = round(quantile(boot_results$t[,30], c(0.025, 0.975), na.rm=T)[1],3),
  diffnpv_ciup12 = round(quantile(boot_results$t[,30], c(0.025, 0.975), na.rm=T)[2],3),
  
  diff_acc13 = round(boot_results$t0[31], 3),
  diffacc_cilow13 = round(quantile(boot_results$t[,31], c(0.025, 0.975), na.rm=T)[1],3),
  diffacc_ciup13 = round(quantile(boot_results$t[,31], c(0.025, 0.975), na.rm=T)[2],3),
  diff_ppv13 = round(boot_results$t0[32], 3),
  diffppv_cilow13 = round(quantile(boot_results$t[,32], c(0.025, 0.975), na.rm=T)[1],3),
  diffppv_ciup13 = round(quantile(boot_results$t[,32], c(0.025, 0.975), na.rm=T)[2],3),
  diff_npv13 = round(boot_results$t0[33], 3),
  diffnpv_cilow13 = round(quantile(boot_results$t[,33], c(0.025, 0.975), na.rm=T)[1],3),
  diffnpv_ciup13 = round(quantile(boot_results$t[,33], c(0.025, 0.975), na.rm=T)[2],3),
  
  diff_acc23 = round(boot_results$t0[34], 3),
  diffacc_cilow23 = round(quantile(boot_results$t[,34], c(0.025, 0.975), na.rm=T)[1],3),
  diffacc_ciup23 = round(quantile(boot_results$t[,34], c(0.025, 0.975), na.rm=T)[2],3),
  diff_ppv23 = round(boot_results$t0[35], 3),
  diffppv_cilow23 = round(quantile(boot_results$t[,35], c(0.025, 0.975), na.rm=T)[1],3),
  diffppv_ciup23 = round(quantile(boot_results$t[,35], c(0.025, 0.975), na.rm=T)[2],3),
  diff_npv23 = round(boot_results$t0[36], 3),
  diffnpv_cilow23 = round(quantile(boot_results$t[,36], c(0.025, 0.975), na.rm=T)[1],3),
  diffnpv_ciup23 = round(quantile(boot_results$t[,36], c(0.025, 0.975), na.rm=T)[2],3),
  
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  
  intermediate_n3 = NA,
  intermediate_cilow3 = NA,
  intermediate_cihigh3 = NA,
  intermediate_n_percentage3= NA,
  intermediate_n_percentage_low3= NA,
  intermediate_n_percentage_high3= NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

##Add results %C2N----
results_1cp_c2nratio <- data.frame(
  method = "C2N ratio",
  auc1 = round(ci.auc(roc_curve1_c2nr)[2],3),
  auc_ci_lower1 = round(ci.auc(roc_curve1_c2nr)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1_c2nr)[3],3),
  accuracy1 = round(boot_results$t0[37], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,37], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,37], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[38], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,38], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,38], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[39], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,39], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,39], c(0.025, 0.975))[2],3),
  
  auc2 = round(ci.auc(roc_curve2_c2nr)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2_c2nr)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2_c2nr)[3],3),
  accuracy2 = round(boot_results$t0[40], 3),
  acc_ci_lower2 = round(quantile(boot_results$t[,40], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results$t[,40], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results$t0[41], 3),
  ppv_ci_lower2 = round(quantile(boot_results$t[,41], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results$t[,41], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results$t0[42], 3),
  npv_ci_lower2 = round(quantile(boot_results$t[,42], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results$t[,42], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3_c2nr)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3_c2nr)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3_c2nr)[3],3),
  accuracy3 = round(boot_results$t0[43], 3),
  acc_ci_lower3 = round(quantile(boot_results$t[,43], c(0.025, 0.975))[1],3),
  acc_ci_upper3 = round(quantile(boot_results$t[,43], c(0.025, 0.975))[2],3),
  PPV3 = round(boot_results$t0[44], 3),
  ppv_ci_lower3 = round(quantile(boot_results$t[,44], c(0.025, 0.975))[1],3),
  ppv_ci_upper3 = round(quantile(boot_results$t[,44], c(0.025, 0.975))[2],3),
  NPV3 = round(boot_results$t0[45], 3),
  npv_ci_lower3 = round(quantile(boot_results$t[,45], c(0.025, 0.975))[1],3),
  npv_ci_upper3 = round(quantile(boot_results$t[,45], c(0.025, 0.975))[2],3),
  
  diff_acc12 = round(boot_results$t0[46], 3),
  diffacc_cilow12 = round(quantile(boot_results$t[,46], c(0.025, 0.975))[1],3),
  diffacc_ciup12 = round(quantile(boot_results$t[,46], c(0.025, 0.975))[2],3),
  diff_ppv12 = round(boot_results$t0[47], 3),
  diffppv_cilow12 = round(quantile(boot_results$t[,47], c(0.025, 0.975))[1],3),
  diffppv_ciup12 = round(quantile(boot_results$t[,47], c(0.025, 0.975))[2],3),
  diff_npv12 = round(boot_results$t0[48], 3),
  diffnpv_cilow12 = round(quantile(boot_results$t[,48], c(0.025, 0.975))[1],3),
  diffnpv_ciup12 = round(quantile(boot_results$t[,48], c(0.025, 0.975))[2],3),
  
  diff_acc13 = round(boot_results$t0[49], 3),
  diffacc_cilow13 = round(quantile(boot_results$t[,49], c(0.025, 0.975))[1],3),
  diffacc_ciup13 = round(quantile(boot_results$t[,49], c(0.025, 0.975))[2],3),
  diff_ppv13 = round(boot_results$t0[50], 3),
  diffppv_cilow13 = round(quantile(boot_results$t[,50], c(0.025, 0.975))[1],3),
  diffppv_ciup13 = round(quantile(boot_results$t[,50], c(0.025, 0.975))[2],3),
  diff_npv13 = round(boot_results$t0[51], 3),
  diffnpv_cilow13 = round(quantile(boot_results$t[,51], c(0.025, 0.975))[1],3),
  diffnpv_ciup13 = round(quantile(boot_results$t[,51], c(0.025, 0.975))[2],3),
  
  diff_acc23 = round(boot_results$t0[52], 3),
  diffacc_cilow23 = round(quantile(boot_results$t[,52], c(0.025, 0.975))[1],3),
  diffacc_ciup23 = round(quantile(boot_results$t[,52], c(0.025, 0.975))[2],3),
  diff_ppv23= round(boot_results$t0[53], 3),
  diffppv_cilow23 = round(quantile(boot_results$t[,53], c(0.025, 0.975))[1],3),
  diffppv_ciup23 = round(quantile(boot_results$t[,53], c(0.025, 0.975))[2],3),
  diff_npv23 = round(boot_results$t0[54], 3),
  diffnpv_cilow23 = round(quantile(boot_results$t[,54], c(0.025, 0.975))[1],3),
  diffnpv_ciup23 = round(quantile(boot_results$t[,54], c(0.025, 0.975))[2],3),
  
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1= NA,
  
  intermediate_n2 = NA,
  intermediate_cilow2 = NA,
  intermediate_cihigh2 = NA,
  intermediate_n_percentage2= NA,
  intermediate_n_percentage_low2= NA,
  intermediate_n_percentage_high2= NA,
  
  intermediate_n3 = NA,
  intermediate_cilow3 = NA,
  intermediate_cihigh3 = NA,
  intermediate_n_percentage3= NA,
  intermediate_n_percentage_low3= NA,
  intermediate_n_percentage_high3= NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

##Add all together in a dataframe----

results_1cp <- bind_rows(results_1cp_lumi, results_1cp_c2n, results_1cp_c2nratio)
results_1cp <- results_1cp %>% rownames_to_column(var="Cutpoint")
openxlsx::write.xlsx(results_1cp,
                      file="C2NPooled_1cp_age.xlsx")

stat_indices <- list(
  "Accuracy pval Lumi12" = 10,"PPV pval Lumi12" =11,"NPV pval Lumi12" = 12,
  "Accuracy pval Lumi13" = 13,"PPV pval Lumi13" =14,"NPV pval Lumi13" = 15,
  "Accuracy pval Lumi23" = 16,"PPV pval Lumi23" =17,"NPV pval Lumi23" = 18,
  "Accuracy pval C2N12" = 28, "PPV pval C2N12" = 29,"NPV pval C2N12" = 30,
  "Accuracy pval C2N13" = 31, "PPV pval C2N13" = 32,"NPV pval C2N13" = 33,
  "Accuracy pval C2N23" = 34, "PPV pval C2N23" = 35,"NPV pval C2N23" = 36,
  "Accuracy pval %C2N12" = 46, "PPV pval %C2N12" = 47,"NPV pval %C2N12" = 48,
  "Accuracy pval %C2N13" = 49, "PPV pval %C2N13" = 50,"NPV pval %C2N13" = 51,
  "Accuracy pval %C2N23" = 52, "PPV pval %C2N23" = 53,"NPV pval %C2N23" = 54,

  "Accuracy pval Lumi vs. C2N 1" = 55,"PPV pval Lumi vs. C2N 1" = 56,"NPV pval Lumi vs. C2N 1" = 57,
  "Accuracy pval Lumi vs. C2N 2" = 58,"PPV pval Lumi vs. C2N 2" = 59,"NPV pval Lumi vs. C2N 2" = 60,
  "Accuracy pval Lumi vs. C2N 3" = 61,"PPV pval Lumi vs. C2N 3" = 62,"NPV pval Lumi vs. C2N 3" = 63,

  "Accuracy pval Lumi vs. %C2N 1" = 64,"PPV pval Lumi vs. %C2N 1" = 65,"NPV pval Lumi vs. %C2N 1" = 66,
  "Accuracy pval Lumi vs. %C2N 2" = 67,"PPV pval Lumi vs. %C2N 2" = 68,"NPV pval Lumi vs. %C2N 2" = 69,
  "Accuracy pval Lumi vs. %C2N 3" = 70,"PPV pval Lumi vs. %C2N 3" = 71,"NPV pval Lumi vs. %C2N 3" = 72,

  "Accuracy pval C2N vs. %C2N 1" = 73,"PPV pval C2N vs. %C2N 1" = 74, "NPV pval C2N  vs. %C2N 1" = 75,
  "Accuracy pval C2N vs. %C2N 2" = 76,"PPV pval C2N vs. %C2N 2" = 77, "NPV pval C2N  vs. %C2N 2" = 78,  
  "Accuracy pval C2N vs. %C2N 3" = 79,"PPV pval C2N vs. %C2N 3" = 80, "NPV pval C2N  vs. %C2N 3" = 81)

pvals_age_1cp <- data.frame(
  Age = numeric(length(stat_indices)),
  row.names = c(
  "Accuracy pval Lumi12", "PPV pval Lumi12", "NPV pval Lumi12",
  "Accuracy pval Lumi13", "PPV pval Lumi13", "NPV pval Lumi13",
  "Accuracy pval Lumi23", "PPV pval Lumi23", "NPV pval Lumi23",
  "Accuracy pval C2N12", "PPV pval C2N12", "NPV pval C2N12",
  "Accuracy pval C2N13", "PPV pval C2N13", "NPV pval C2N13",
  "Accuracy pval C2N23", "PPV pval C2N23", "NPV pval C2N23",
  "Accuracy pval %C2N12", "PPV pval %C2N12", "NPV pval %C2N12",
  "Accuracy pval %C2N13", "PPV pval %C2N13", "NPV pval %C2N13",
  "Accuracy pval %C2N23", "PPV pval %C2N23", "NPV pval %C2N23",
  "Accuracy pval Lumi vs. C2N 1", "PPV pval Lumi vs. C2N 1", "NPV pval Lumi vs. C2N 1",
  "Accuracy pval Lumi vs. C2N 2", "PPV pval Lumi vs. C2N 2", "NPV pval Lumi vs. C2N 2",
  "Accuracy pval Lumi vs. C2N 3", "PPV pval Lumi vs. C2N 3", "NPV pval Lumi vs. C2N 3",
  "Accuracy pval Lumi vs. %C2N 1", "PPV pval Lumi vs. %C2N 1", "NPV pval Lumi vs. %C2N 1",
  "Accuracy pval Lumi vs. %C2N 2", "PPV pval Lumi vs. %C2N 2", "NPV pval Lumi vs. %C2N 2",
  "Accuracy pval Lumi vs. %C2N 3", "PPV pval Lumi vs. %C2N 3", "NPV pval Lumi vs. %C2N 3",
  "Accuracy pval C2N vs. %C2N 1", "PPV pval C2N vs. %C2N 1", "NPV pval C2N  vs. %C2N 1",
  "Accuracy pval C2N vs. %C2N 2", "PPV pval C2N vs. %C2N 2", "NPV pval C2N  vs. %C2N 2",
  "Accuracy pval C2N vs. %C2N 3", "PPV pval C2N vs. %C2N 3", "NPV pval C2N  vs. %C2N 3"))


bootstrap_replicates <- boot_results$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results$t0[index]
  results_underH0_diff <- bootstrap_replicates[, index] - mean(bootstrap_replicates[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_age_1cp[paste0(stat_name), "Age"] <- round(p_value, 3)
}
 openxlsx::write.xlsx(pvals_age_1cp,
                      file="C2N_pvalues1cp_age.xlsx",rowNames =T)


##2CP

lumi <- lumi %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                      # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))


##Bootstrap #n intermediate participants ----
f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  
  d_lumi <- d %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  d1_lumi <- d_lumi %>% filter(strat == 0)
  d2_lumi <- d_lumi %>% filter(strat == 1)
  d3_lumi <- d_lumi %>% filter(strat == 2)
  
  intermediate_n1_lumi <- length(which(d1_lumi$greyzone_lumi ==2))
  intermediate_npercent1_lumi <- round((length(which(d1_lumi$greyzone_lumi == 2)) / nrow(d1_lumi)) * 100, 3)
  
  intermediate_n2_lumi <- length(which(d2_lumi$greyzone_lumi ==2))
  intermediate_npercent2_lumi <- round((length(which(d2_lumi$greyzone_lumi == 2)) / nrow(d2_lumi)) * 100, 3)
  
  intermediate_n3_lumi <- length(which(d3_lumi$greyzone_lumi ==2))
  intermediate_npercent3_lumi <- round((length(which(d3_lumi$greyzone_lumi == 2)) / nrow(d3_lumi)) * 100, 3)
  
  diff_intermediaten_lumi12 <- intermediate_n1_lumi - intermediate_n2_lumi
  diff_percent_lumi12 <- intermediate_npercent1_lumi - intermediate_npercent2_lumi
  diff_intermediaten_lumi13 <- intermediate_n1_lumi - intermediate_n3_lumi
  diff_percent_lumi13 <- intermediate_npercent1_lumi - intermediate_npercent3_lumi
  diff_intermediaten_lumi23 <- intermediate_n2_lumi - intermediate_n3_lumi
  diff_percent_lumi23 <- intermediate_npercent2_lumi - intermediate_npercent3_lumi
  
  #C2N
  d_c2n <- d %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  d1_c2n <- d_c2n %>% filter(strat == 0)
  d2_c2n <- d_c2n %>% filter(strat == 1)
  d3_c2n <- d_c2n %>% filter(strat == 2)

  intermediate_n1_c2n <- length(which(d1_c2n$greyzone_c2n ==2))
  intermediate_npercent1_c2n <- round((length(which(d1_c2n$greyzone_c2n == 2)) / nrow(d1_c2n)) * 100, 3)
  intermediate_n2_c2n <- length(which(d2_c2n$greyzone_c2n ==2))
  intermediate_npercent2_c2n <- round((length(which(d2_c2n$greyzone_c2n == 2)) / nrow(d2_c2n)) * 100, 3)
  intermediate_n3_c2n <- length(which(d3_c2n$greyzone_c2n ==2))
  intermediate_npercent3_c2n <- round((length(which(d3_c2n$greyzone_c2n == 2)) / nrow(d3_c2n)) * 100, 3)
  
  diff_intermediaten_c2n12 <- intermediate_n1_c2n - intermediate_n2_c2n
  diff_percent_c2n12 <- intermediate_npercent1_c2n - intermediate_npercent2_c2n
  diff_intermediaten_c2n13 <- intermediate_n1_c2n - intermediate_n3_c2n
  diff_percent_c2n13 <- intermediate_npercent1_c2n - intermediate_npercent3_c2n
  diff_intermediaten_c2n23 <- intermediate_n2_c2n - intermediate_n3_c2n
  diff_percent_c2n23 <- intermediate_npercent2_c2n - intermediate_npercent3_c2n
  
  #C2N ratio
  d_c2nr <- d %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  d1_c2nr <- d_c2nr %>% filter(strat == 0)
  d2_c2nr <- d_c2nr %>% filter(strat == 1)
  d3_c2nr <- d_c2nr %>% filter(strat == 2)

  intermediate_n1_c2nr <- length(which(d1_c2nr$greyzone_c2nr ==2))
  intermediate_npercent1_c2nr <- round((length(which(d1_c2nr$greyzone_c2n == 2)) / nrow(d1_c2nr)) * 100, 3)
  intermediate_n2_c2nr <- length(which(d2_c2nr$greyzone_c2nr ==2))
  intermediate_npercent2_c2nr <- round((length(which(d2_c2nr$greyzone_c2nr == 2)) / nrow(d2_c2nr)) * 100, 3)
  intermediate_n3_c2nr <- length(which(d3_c2nr$greyzone_c2nr ==2))
  intermediate_npercent3_c2nr <- round((length(which(d3_c2nr$greyzone_c2nr == 2)) / nrow(d3_c2nr)) * 100, 3)
  
  diff_intermediaten_c2nr12 <- intermediate_n1_c2nr - intermediate_n2_c2nr
  diff_percent_c2nr12 <- intermediate_npercent1_c2nr - intermediate_npercent2_c2nr
  diff_intermediaten_c2nr13 <- intermediate_n1_c2nr - intermediate_n3_c2nr
  diff_percent_c2nr13 <- intermediate_npercent1_c2nr - intermediate_npercent3_c2nr
  diff_intermediaten_c2nr23 <- intermediate_n2_c2nr - intermediate_n3_c2nr
  diff_percent_c2nr23 <- intermediate_npercent2_c2nr - intermediate_npercent3_c2nr
  
  
  #DIFFERENCES BETWEEN ASSAYS
  ##lumi vs. C2N
  diff_n_lumi_c2n12 <- diff_intermediaten_lumi12 - diff_intermediaten_c2n12
  diff_nperc_lumi_c2n12 <- diff_percent_lumi12 - diff_percent_c2n12
  diff_n_lumi_c2n13 <- diff_intermediaten_lumi13 - diff_intermediaten_c2n13
  diff_nperc_lumi_c2n13 <- diff_percent_lumi13 - diff_percent_c2n13
  diff_n_lumi_c2n23 <- diff_intermediaten_lumi23 - diff_intermediaten_c2n23
  diff_nperc_lumi_c2n23 <- diff_percent_lumi23 - diff_percent_c2n23

  ##lumi vs. C2N%
  diff_n_lumi_c2nr12 <- diff_intermediaten_lumi12 - diff_intermediaten_c2nr12
  diff_nperc_lumi_c2nr12 <- diff_percent_lumi12 - diff_percent_c2nr12
  diff_n_lumi_c2nr13 <- diff_intermediaten_lumi13 - diff_intermediaten_c2nr13
  diff_nperc_lumi_c2nr13 <- diff_percent_lumi13 - diff_percent_c2nr13
  diff_n_lumi_c2nr23 <- diff_intermediaten_lumi23 - diff_intermediaten_c2nr23
  diff_nperc_lumi_c2nr23 <- diff_percent_lumi23 - diff_percent_c2nr23

  ##C2n vs. C2N%
  diff_n_c2n_c2nr12 <- diff_intermediaten_c2n12 - diff_intermediaten_c2nr12
  diff_nperc_c2n_c2nr12 <- diff_percent_c2n12 - diff_percent_c2nr12
  diff_n_c2n_c2nr13<- diff_intermediaten_c2n13 - diff_intermediaten_c2nr13
  diff_nperc_c2n_c2nr13 <- diff_percent_c2n13 - diff_percent_c2nr13
  diff_n_c2n_c2nr23 <- diff_intermediaten_c2n23- diff_intermediaten_c2nr23
  diff_nperc_c2n_c2nr23 <- diff_percent_c2n23 - diff_percent_c2nr23

  return(c(intermediate_npercent1_lumi, intermediate_n1_lumi, intermediate_npercent2_lumi,intermediate_n2_lumi,
           intermediate_npercent3_lumi,intermediate_n3_lumi, #6
           diff_intermediaten_lumi12, diff_intermediaten_lumi13, diff_intermediaten_lumi23,
           diff_percent_lumi12, diff_percent_lumi13, diff_percent_lumi23,#12
           intermediate_npercent1_c2n, intermediate_n1_c2n, intermediate_npercent2_c2n,intermediate_n2_c2n,
           intermediate_npercent3_c2n,intermediate_n3_c2n,#18
           diff_intermediaten_c2n12,diff_percent_c2n12, diff_intermediaten_c2n13,diff_percent_c2n13,
           diff_intermediaten_c2n23,diff_percent_c2n23,#24
           intermediate_npercent1_c2nr, intermediate_n1_c2nr, intermediate_npercent2_c2nr,intermediate_n2_c2nr,
           intermediate_npercent3_c2nr,intermediate_n3_c2nr,#30
           diff_intermediaten_c2nr12,diff_percent_c2n12, diff_intermediaten_c2nr13,diff_percent_c2n13,
           diff_intermediaten_c2nr23,diff_percent_c2n23,#36
          diff_n_lumi_c2n12,diff_nperc_lumi_c2n12,diff_n_lumi_c2n13,diff_nperc_lumi_c2n13,diff_n_lumi_c2n23,diff_nperc_lumi_c2n23,#42
          diff_n_lumi_c2nr12, diff_nperc_lumi_c2nr12,diff_n_lumi_c2nr13,diff_nperc_lumi_c2nr13,diff_n_lumi_c2nr23,diff_nperc_lumi_c2nr23,
          diff_n_c2n_c2nr12,diff_nperc_c2n_c2nr12,diff_n_c2n_c2nr13,diff_nperc_c2n_c2nr13,diff_n_c2n_c2nr23,diff_nperc_c2n_c2nr23))
}

set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)

stat_indices <- list(
  "Intermediate N pval Lumi12" = 7,"Intermediate percentage pval Lumi12" = 10,
  "Intermediate N pval Lumi13" = 8,"Intermediate percentage pval Lumi13" = 11,
  "Intermediate N pval Lumi23" = 9,"Intermediate percentage pval Lumi23" = 12,
      "Intermediate N pval C2N12" = 19,"Intermediate percentage pval C2N12" = 22,
      "Intermediate N pval C2N13" = 20,"Intermediate percentage pval C2N13" = 23,
      "Intermediate N pval C2N23" = 21,"Intermediate percentage pval C2N23" = 24,
      "Intermediate N pval C2N%12" = 31,"Intermediate percentage pval C2N%12" = 34,
      "Intermediate N pval C2N%13" = 32,"Intermediate percentage pval C2N%13" = 35,
      "Intermediate N pval C2N%23" = 33,"Intermediate percentage pval C2N%23" = 36,
  "Intermediate N pval Lumi vs. C2N12" = 37,   "Intermediate N pval Lumi vs. C2N13" = 39,   "Intermediate N pval Lumi vs. C2N23" = 41, 
    "Intermediate % pval Lumi vs. C2N12" = 38,   "Intermediate % pval Lumi vs. C2N13" = 40,   "Intermediate % pval Lumi vs. C2N23" = 42, 
  "Intermediate N pval Lumi vs. C2N%12" =43 , "Intermediate N pval C2N vs. C2N%13" = 45, "Intermediate N pval C2N vs. C2N%23" = 47, 
    "Intermediate % pval Lumi vs. C2N%12" =44 , "Intermediate % pval C2N vs. C2N%13" = 46, "Intermediate % pval C2N vs. C2N%23" = 48, 
  "Intermediate N pval C2N vs. C2N%12" =49 , "Intermediate N pval C2N vs. C2N%13" = 51, "Intermediate N pval C2N vs. C2N%23" = 53,
    "Intermediate % pval C2N vs. C2N%12" =50 , "Intermediate % pval C2N vs. C2N%13" = 52, "Intermediate % pval C2N vs. C2N%23" = 54)

pvals_age_intermediate <- data.frame(
  Age = numeric(length(stat_indices)),
  row.names = c("Intermediate N pval Lumi12", "Intermediate percentage pval Lumi12",
  "Intermediate N pval Lumi13", "Intermediate percentage pval Lumi13",
  "Intermediate N pval Lumi23", "Intermediate percentage pval Lumi23",
  "Intermediate N pval C2N12", "Intermediate percentage pval C2N12",
  "Intermediate N pval C2N13", "Intermediate percentage pval C2N13",
  "Intermediate N pval C2N23", "Intermediate percentage pval C2N23",
  "Intermediate N pval C2N%12", "Intermediate percentage pval C2N%12",
  "Intermediate N pval C2N%13", "Intermediate percentage pval C2N%13",
  "Intermediate N pval C2N%23", "Intermediate percentage pval C2N%23",
  "Intermediate N pval Lumi vs. C2N12", "Intermediate N pval Lumi vs. C2N13", "Intermediate N pval Lumi vs. C2N23",
  "Intermediate % pval Lumi vs. C2N12", "Intermediate % pval Lumi vs. C2N13", "Intermediate % pval Lumi vs. C2N23",
  "Intermediate N pval Lumi vs. C2N%12", "Intermediate N pval Lumi vs. C2N%13", "Intermediate N pval Lumi vs. C2N%23",
  "Intermediate % pval Lumi vs. C2N%12", "Intermediate % pval Lumi vs. C2N%13", "Intermediate % pval Lumi vs. C2N%23",
  "Intermediate N pval C2N vs. C2N%12", "Intermediate N pval C2N vs. C2N%13", "Intermediate N pval C2N vs. C2N%23",
  "Intermediate % pval C2N vs. C2N%12", "Intermediate % pval C2N vs. C2N%13", "Intermediate % pval C2N vs. C2N%23"
))

bootstrap_replicates_grey <- boot_results_greyzone$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_greyzone$t0[index]
  results_underH0_diff <- bootstrap_replicates_grey[, index] - mean(bootstrap_replicates_grey[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_age_intermediate[paste0(stat_name), "Age"] <- round(p_value, 3)
}


##Repeat bootstrap in filtered sample, remove intermediate participants ----

##Calculate Accuracy, PPV, NPV and 95% CIs, two cutpoint ----

f_comp_stats_2cp <- function(data, indices) {
  
   compute_metrics <- function(d, assay) {
    v_tp <- sum(d$csf_status == 1 & d[[assay]] == 1)
    v_fp <- sum(d$csf_status == 0 & d[[assay]] == 1)
    v_tn <- sum(d$csf_status == 0 & d[[assay]] == 0)
    v_fn <- sum(d$csf_status == 1 & d[[assay]] == 0)
    
    sens <- v_tp / (v_tp + v_fn)
    spec <- v_tn / (v_tn + v_fp)
    acc <- (v_tp + v_tn) / (v_tp + v_tn + v_fn + v_fp)
    ppv <- ppv(tp = v_tp, fp = v_fp, tn = v_tn, fn = v_fn)
    npv <- npv(tp = v_tp, fp = v_fp, tn = v_tn, fn = v_fn)
    
    list(sens = sens, spec = spec, acc = acc, ppv = ppv, npv = npv)
  }
  
  d <- as.data.frame(data[indices,])
  
  split_data <- function(data, assay_column) {
    list(
      d1 = data %>% filter(strat == 0),
      d2 = data %>% filter(strat == 1),
      d3 = data %>% filter(strat == 2)
    )
  }
  
  d_lumi <- d %>% filter(greyzone_lumi != 2)
  d_c2n  <- d %>% filter(greyzone_c2n != 2)
  d_c2nr <- d %>% filter(greyzone_c2nr != 2)

  # Process LUMI
  lumi_split <- split_data(d_lumi, "ptau217_spec90_lumi")
  lumi_metrics <- lapply(lumi_split, function(d) compute_metrics(d, "ptau217_spec90_lumi"))
  
  # Process C2N
  c2n_split <- split_data(d_c2n, "ptau217_spec90_c2n")
  c2n_metrics <- lapply(c2n_split, function(d) compute_metrics(d, "ptau217_spec90_c2n"))
  
  # Process C2NR
  c2nr_split <- split_data(d_c2nr, "ptau217_spec90_c2nr")
  c2nr_metrics <- lapply(c2nr_split, function(d) compute_metrics(d, "ptau217_spec90_c2nr"))
  

  # Extract metrics for comparisons
  lumi1 <- lumi_metrics[[1]]
  lumi2 <- lumi_metrics[[2]]
  lumi3 <- lumi_metrics[[3]]
  
  c2n1 <- c2n_metrics[[1]]
  c2n2 <- c2n_metrics[[2]]
  c2n3 <- c2n_metrics[[3]]
  
  c2nr1 <- c2nr_metrics[[1]]
  c2nr2 <- c2nr_metrics[[2]]
  c2nr3 <- c2nr_metrics[[3]]

  # Calculate differences between groups Lumi
  diff_acc_lumi12 <- lumi1$acc - lumi2$acc
  diff_ppv_lumi12 <- lumi1$ppv - lumi2$ppv
  diff_npv_lumi12 <- lumi1$npv - lumi2$npv
  
  diff_acc_lumi13 <- lumi1$acc - lumi3$acc
  diff_ppv_lumi13 <- lumi1$ppv - lumi3$ppv
  diff_npv_lumi13 <- lumi1$npv - lumi3$npv
  
  diff_acc_lumi23 <- lumi2$acc - lumi3$acc
  diff_ppv_lumi23 <- lumi2$ppv - lumi3$ppv
  diff_npv_lumi23 <- lumi2$npv - lumi3$npv
  
  # Calculate differences between groups C2N
  diff_acc_c2n12 <- c2n1$acc - c2n2$acc
  diff_ppv_c2n12 <- c2n1$ppv - c2n2$ppv
  diff_npv_c2n12 <- c2n1$npv - c2n2$npv
  
  diff_acc_c2n13 <- c2n1$acc - c2n3$acc
  diff_ppv_c2n13 <- c2n1$ppv - c2n3$ppv
  diff_npv_c2n13 <- c2n1$npv - c2n3$npv
  
  diff_acc_c2n23 <- c2n2$acc - c2n3$acc
  diff_ppv_c2n23 <- c2n2$ppv - c2n3$ppv
  diff_npv_c2n23 <- c2n2$npv - c2n3$npv
  
  # Calculate differences between groups C2N%
  diff_acc_c2nr12 <- c2nr1$acc - c2nr2$acc
  diff_ppv_c2nr12 <- c2nr1$ppv - c2nr2$ppv
  diff_npv_c2nr12 <- c2nr1$npv - c2nr2$npv
  
  diff_acc_c2nr13 <- c2nr1$acc - c2nr3$acc
  diff_ppv_c2nr13 <- c2nr1$ppv - c2nr3$ppv
  diff_npv_c2nr13 <- c2nr1$npv - c2nr3$npv
  
  diff_acc_c2nr23 <- c2nr2$acc - c2nr3$acc
  diff_ppv_c2nr23 <- c2nr2$ppv - c2nr3$ppv
  diff_npv_c2nr23 <- c2nr2$npv - c2nr3$npv
  
  # Compare LUMI vs. C2N
  diff_acc_lumi_c2n12 <- diff_acc_lumi12 - diff_acc_c2n12
  diff_ppv_lumi_c2n12 <- diff_ppv_lumi12 - diff_ppv_c2n12
  diff_npv_lumi_c2n12 <- diff_npv_lumi12 - diff_npv_c2n12

  diff_acc_lumi_c2n13 <- diff_acc_lumi13 - diff_acc_c2n13
  diff_ppv_lumi_c2n13 <- diff_ppv_lumi13 - diff_ppv_c2n13
  diff_npv_lumi_c2n13 <- diff_npv_lumi13 - diff_npv_c2n13
  
  diff_acc_lumi_c2n23 <- diff_acc_lumi23 - diff_acc_c2n23
  diff_ppv_lumi_c2n23 <- diff_ppv_lumi23 - diff_ppv_c2n23
  diff_npv_lumi_c2n23 <- diff_npv_lumi23 - diff_npv_c2n23
  
  # Compare LUMI vs. C2NR
  diff_acc_lumi_c2nr12 <- diff_acc_lumi12 - diff_acc_c2nr12
  diff_ppv_lumi_c2nr12 <- diff_ppv_lumi12 - diff_ppv_c2nr12
  diff_npv_lumi_c2nr12 <- diff_npv_lumi12 - diff_npv_c2nr12
  
  diff_acc_lumi_c2nr13 <- diff_acc_lumi13 - diff_acc_c2nr13
  diff_ppv_lumi_c2nr13 <- diff_ppv_lumi13 - diff_ppv_c2nr13
  diff_npv_lumi_c2nr13 <- diff_npv_lumi13 - diff_npv_c2nr13
  
  diff_acc_lumi_c2nr23 <- diff_acc_lumi23 - diff_acc_c2nr23
  diff_ppv_lumi_c2nr23 <- diff_ppv_lumi23 - diff_ppv_c2nr23
  diff_npv_lumi_c2nr23 <- diff_npv_lumi23 - diff_npv_c2nr23

  # Compare C2N vs. C2NR
  diff_acc_c2n_c2nr12 <- diff_acc_c2n12 - diff_acc_c2nr12
  diff_ppv_c2n_c2nr12 <- diff_ppv_c2n12 - diff_ppv_c2nr12
  diff_npv_c2n_c2nr12 <- diff_npv_c2n12 - diff_npv_c2nr12
  
  diff_acc_c2n_c2nr13 <- diff_acc_c2n13 - diff_acc_c2nr13
  diff_ppv_c2n_c2nr13 <- diff_ppv_c2n13 - diff_ppv_c2nr13
  diff_npv_c2n_c2nr13 <- diff_npv_c2n13 - diff_npv_c2nr13
  
  diff_acc_c2n_c2nr23 <- diff_acc_c2n23 - diff_acc_c2nr23
  diff_ppv_c2n_c2nr23 <- diff_ppv_c2n23 - diff_ppv_c2nr23
  diff_npv_c2n_c2nr23 <- diff_npv_c2n23 - diff_npv_c2nr23
  
  return(c(lumi1$acc, lumi1$ppv, lumi1$npv, lumi2$acc, lumi2$ppv, lumi2$npv, lumi3$acc, lumi3$ppv, lumi3$npv, #9
           diff_acc_lumi12, diff_ppv_lumi12, diff_npv_lumi12,diff_acc_lumi13, diff_ppv_lumi13, diff_npv_lumi13,diff_acc_lumi23, diff_ppv_lumi23, diff_npv_lumi23,#18
           c2n1$acc, c2n1$ppv, c2n1$npv, c2n2$acc, c2n2$ppv, c2n2$npv, c2n3$acc, c2n3$ppv, c2n3$npv, #27
           diff_acc_c2n12, diff_ppv_c2n12, diff_npv_c2n12,diff_acc_c2n13, diff_ppv_c2n13, diff_npv_c2n13,diff_acc_c2n23, diff_ppv_c2n23, diff_npv_c2n23,#36
           c2nr1$acc, c2nr1$ppv, c2nr1$npv, c2nr2$acc, c2nr2$ppv, c2nr2$npv, c2nr3$acc, c2nr3$ppv, c2nr3$npv, #45
           diff_acc_c2nr12, diff_ppv_c2nr12, diff_npv_c2nr12,diff_acc_c2nr13, diff_ppv_c2nr13, diff_npv_c2nr13,diff_acc_c2nr23, diff_ppv_c2nr23, diff_npv_c2nr23,#54
           diff_acc_lumi_c2n12, diff_ppv_lumi_c2n12, diff_npv_lumi_c2n12, diff_acc_lumi_c2n13, diff_ppv_lumi_c2n13, diff_npv_lumi_c2n13, diff_acc_lumi_c2n23, diff_ppv_lumi_c2n23, diff_npv_lumi_c2n23, #63
           diff_acc_lumi_c2nr12, diff_ppv_lumi_c2nr12, diff_npv_lumi_c2nr12,diff_acc_lumi_c2nr13, diff_ppv_lumi_c2nr13, diff_npv_lumi_c2nr13,           diff_acc_lumi_c2nr23, diff_ppv_lumi_c2nr23, diff_npv_lumi_c2nr23,
           diff_acc_c2n_c2nr12, diff_ppv_c2n_c2nr12, diff_npv_c2n_c2nr12,diff_acc_c2n_c2nr13, diff_ppv_c2n_c2nr13, diff_npv_c2n_c2nr13,
           diff_acc_c2n_c2nr23, diff_ppv_c2n_c2nr23, diff_npv_c2n_c2nr23))
}

set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi, statistic = f_comp_stats_2cp, R = 2000)

##Add results to dataframe LUMI ----
results_2cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[2], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[3], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  
  auc2 = NA,
  auc_ci_lower2 = NA,
  auc_ci_upper2 = NA,
  accuracy2 = round(boot_results_twocutpoints$t0[4], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[5], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[6], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,6], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,6], c(0.025, 0.975))[2],3),
  
  auc3 = NA,
  auc_ci_lower3 = NA,
  auc_ci_upper3 = NA,
  accuracy3 = round(boot_results_twocutpoints$t0[7], 3),
  acc_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[1],3),
  acc_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[2],3),
  PPV3 = round(boot_results_twocutpoints$t0[8], 3),
  ppv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  ppv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  NPV3 = round(boot_results_twocutpoints$t0[9], 3),
  npv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  
  diff_acc12 = round(boot_results_twocutpoints$t0[10], 3),
  diffacc_cilow12 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[1],3),
  diffacc_ciup12 = round(quantile(boot_results_twocutpoints$t[,10], c(0.025, 0.975))[2],3),
  diff_ppv12 = round(boot_results_twocutpoints$t0[11], 3),
  diffppv_cilow12 = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[1],3),
  diffppv_ciup12 = round(quantile(boot_results_twocutpoints$t[,11], c(0.025, 0.975))[2],3),
  diff_npv12 = round(boot_results_twocutpoints$t0[12], 3),
  diffnpv_cilow12 = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[1],3),
  diffnpv_ciup12 = round(quantile(boot_results_twocutpoints$t[,12], c(0.025, 0.975))[2],3),
  
  diff_acc13 = round(boot_results_twocutpoints$t0[13], 3),
  diffacc_cilow13 = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[1],3),
  diffacc_ciup13 = round(quantile(boot_results_twocutpoints$t[,13], c(0.025, 0.975))[2],3),
  diff_ppv13 = round(boot_results_twocutpoints$t0[14], 3),
  diffppv_cilow13 = round(quantile(boot_results_twocutpoints$t[,14], c(0.025, 0.975))[1],3),
  diffppv_ciup13 = round(quantile(boot_results_twocutpoints$t[,14], c(0.025, 0.975))[2],3),
  diff_npv13 = round(boot_results_twocutpoints$t0[15], 3),
  diffnpv_cilow13 = round(quantile(boot_results_twocutpoints$t[,15], c(0.025, 0.975))[1],3),
  diffnpv_ciup13 = round(quantile(boot_results_twocutpoints$t[,15], c(0.025, 0.975))[2],3),
  
  diff_acc23 = round(boot_results_twocutpoints$t0[16], 3),
  diffacc_cilow23 = round(quantile(boot_results_twocutpoints$t[,16], c(0.025, 0.975))[1],3),
  diffacc_ciup23 = round(quantile(boot_results_twocutpoints$t[,16], c(0.025, 0.975))[2],3),
  diff_ppv23 = round(boot_results_twocutpoints$t0[17], 3),
  diffppv_cilow23 = round(quantile(boot_results_twocutpoints$t[,17], c(0.025, 0.975))[1],3),
  diffppv_ciup23 = round(quantile(boot_results_twocutpoints$t[,17], c(0.025, 0.975))[2],3),
  diff_npv23 = round(boot_results_twocutpoints$t0[18], 3),
  diffnpv_cilow23 = round(quantile(boot_results_twocutpoints$t[,18], c(0.025, 0.975))[1],3),
  diffnpv_ciup23 = round(quantile(boot_results_twocutpoints$t[,18], c(0.025, 0.975))[2],3),
  
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high1= round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[2],3),
  
  intermediate_n2 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow2 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[1],3),
  intermediate_cihigh2 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[2],3),
  intermediate_n_percentage2= round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low2= round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high2= round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[2],3),
  
  intermediate_n3 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow3 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[1],3),
  intermediate_cihigh3 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n_percentage3 = round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low3 = round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high3 = round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[2],3),
  
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoint")


##Add results C2N----
results_2cp_c2n <- data.frame(
  method = "C2N",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[19], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,19], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,19], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[20], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,20], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,20], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[21], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,21], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,21], c(0.025, 0.975))[2],3),
  
  auc2 = NA,
  auc_ci_lower2 = NA,
  auc_ci_upper2 = NA,
  accuracy2 = round(boot_results_twocutpoints$t0[22], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,22], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,22], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[23], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,23], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,23], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[24], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,24], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,24], c(0.025, 0.975))[2],3),
  
  auc3 = NA,
  auc_ci_lower3 = NA,
  auc_ci_upper3 = NA,
  accuracy3 = round(boot_results_twocutpoints$t0[25], 3),
  acc_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,25], c(0.025, 0.975))[1],3),
  acc_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,25], c(0.025, 0.975))[2],3),
  PPV3 = round(boot_results_twocutpoints$t0[26], 3),
  ppv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,26], c(0.025, 0.975))[1],3),
  ppv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,26], c(0.025, 0.975))[2],3),
  NPV3 = round(boot_results_twocutpoints$t0[27], 3),
  npv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,27], c(0.025, 0.975))[1],3),
  npv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,27], c(0.025, 0.975))[2],3),
  
  diff_acc12 = round(boot_results_twocutpoints$t0[28], 3),
  diffacc_cilow12 = round(quantile(boot_results_twocutpoints$t[,28], c(0.025, 0.975))[1],3),
  diffacc_ciup12 = round(quantile(boot_results_twocutpoints$t[,28], c(0.025, 0.975))[2],3),
  diff_ppv12 = round(boot_results_twocutpoints$t0[29], 3),
  diffppv_cilow12 = round(quantile(boot_results_twocutpoints$t[,29], c(0.025, 0.975))[1],3),
  diffppv_ciup12 = round(quantile(boot_results_twocutpoints$t[,29], c(0.025, 0.975))[2],3),
  diff_npv12 = round(boot_results_twocutpoints$t0[30], 3),
  diffnpv_cilow12 = round(quantile(boot_results_twocutpoints$t[,30], c(0.025, 0.975))[1],3),
  diffnpv_ciup12 = round(quantile(boot_results_twocutpoints$t[,30], c(0.025, 0.975))[2],3),
  
  diff_acc13 = round(boot_results_twocutpoints$t0[31], 3),
  diffacc_cilow13 = round(quantile(boot_results_twocutpoints$t[,31], c(0.025, 0.975))[1],3),
  diffacc_ciup13 = round(quantile(boot_results_twocutpoints$t[,31], c(0.025, 0.975))[2],3),
  diff_ppv13 = round(boot_results_twocutpoints$t0[32], 3),
  diffppv_cilow13 = round(quantile(boot_results_twocutpoints$t[,32], c(0.025, 0.975))[1],3),
  diffppv_ciup13 = round(quantile(boot_results_twocutpoints$t[,32], c(0.025, 0.975))[2],3),
  diff_npv13 = round(boot_results_twocutpoints$t0[33], 3),
  diffnpv_cilow13 = round(quantile(boot_results_twocutpoints$t[,33], c(0.025, 0.975))[1],3),
  diffnpv_ciup13 = round(quantile(boot_results_twocutpoints$t[,33], c(0.025, 0.975))[2],3),
  
  diff_acc23 = round(boot_results_twocutpoints$t0[34], 3),
  diffacc_cilow23 = round(quantile(boot_results_twocutpoints$t[,34], c(0.025, 0.975))[1],3),
  diffacc_ciup23 = round(quantile(boot_results_twocutpoints$t[,34], c(0.025, 0.975))[2],3),
  diff_ppv23 = round(boot_results_twocutpoints$t0[35], 3),
  diffppv_cilow23 = round(quantile(boot_results_twocutpoints$t[,35], c(0.025, 0.975))[1],3),
  diffppv_ciup23 = round(quantile(boot_results_twocutpoints$t[,35], c(0.025, 0.975))[2],3),
  diff_npv23 = round(boot_results_twocutpoints$t0[36], 3),
  diffnpv_cilow23 = round(quantile(boot_results_twocutpoints$t[,36], c(0.025, 0.975))[1],3),
  diffnpv_ciup23 = round(quantile(boot_results_twocutpoints$t[,36], c(0.025, 0.975))[2],3),
  
  intermediate_n1 = round(boot_results_greyzone$t0[14],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,14], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,14], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[13],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,13], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high1= round(quantile(boot_results_greyzone$t[,13], c(0.025, 0.975))[2],3),
  
  intermediate_n2 = round(boot_results_greyzone$t0[16],3),
  intermediate_cilow2 = round(quantile(boot_results_greyzone$t[,16], c(0.025, 0.975))[1],3),
  intermediate_cihigh2 = round(quantile(boot_results_greyzone$t[,16], c(0.025, 0.975))[2],3),
  intermediate_n_percentage2= round(boot_results_greyzone$t0[15],3),
  intermediate_n_percentage_low2= round(quantile(boot_results_greyzone$t[,15], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high2= round(quantile(boot_results_greyzone$t[,15], c(0.025, 0.975))[2],3),
  
  intermediate_n3 = round(boot_results_greyzone$t0[18],3),
  intermediate_cilow3 = round(quantile(boot_results_greyzone$t[,18], c(0.025, 0.975))[1],3),
  intermediate_cihigh3 = round(quantile(boot_results_greyzone$t[,18], c(0.025, 0.975))[2],3),
  intermediate_n_percentage3 = round(boot_results_greyzone$t0[17],3),
  intermediate_n_percentage_low3 = round(quantile(boot_results_greyzone$t[,17], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high3 = round(quantile(boot_results_greyzone$t[,17], c(0.025, 0.975))[2],3),
  
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoint")

##Add results %C2N----
results_2cp_c2nratio <- data.frame(
  method = "C2N ratio",
  auc1 = NA,
  auc_ci_lower1 = round(ci.auc(roc_curve1_c2nr)[1],3),
  auc_ci_upper1 = round(ci.auc(roc_curve1_c2nr)[3],3),
  accuracy1 = round(boot_results_twocutpoints$t0[37], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,37], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,37], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[38], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,38], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,38], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[39], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,39], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,39], c(0.025, 0.975))[2],3),
  
  auc2 = round(ci.auc(roc_curve2_c2nr)[2],3),
  auc_ci_lower2 = round(ci.auc(roc_curve2_c2nr)[1],3),
  auc_ci_upper2 = round(ci.auc(roc_curve2_c2nr)[3],3),
  accuracy2 = round(boot_results_twocutpoints$t0[40], 3),
  acc_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,40], c(0.025, 0.975))[1],3),
  acc_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,40], c(0.025, 0.975))[2],3),
  PPV2 = round(boot_results_twocutpoints$t0[41], 3),
  ppv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,41], c(0.025, 0.975))[1],3),
  ppv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,41], c(0.025, 0.975))[2],3),
  NPV2 = round(boot_results_twocutpoints$t0[42], 3),
  npv_ci_lower2 = round(quantile(boot_results_twocutpoints$t[,42], c(0.025, 0.975))[1],3),
  npv_ci_upper2 = round(quantile(boot_results_twocutpoints$t[,42], c(0.025, 0.975))[2],3),
  
  auc3 = round(ci.auc(roc_curve3_c2nr)[2],3),
  auc_ci_lower3 = round(ci.auc(roc_curve3_c2nr)[1],3),
  auc_ci_upper3 = round(ci.auc(roc_curve3_c2nr)[3],3),
  accuracy3 = round(boot_results_twocutpoints$t0[43], 3),
  acc_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,43], c(0.025, 0.975))[1],3),
  acc_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,43], c(0.025, 0.975))[2],3),
  PPV3 = round(boot_results_twocutpoints$t0[44], 3),
  ppv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,44], c(0.025, 0.975))[1],3),
  ppv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,44], c(0.025, 0.975))[2],3),
  NPV3 = round(boot_results_twocutpoints$t0[45], 3),
  npv_ci_lower3 = round(quantile(boot_results_twocutpoints$t[,45], c(0.025, 0.975))[1],3),
  npv_ci_upper3 = round(quantile(boot_results_twocutpoints$t[,45], c(0.025, 0.975))[2],3),
  
  diff_acc12 = round(boot_results_twocutpoints$t0[46], 3),
  diffacc_cilow12 = round(quantile(boot_results_twocutpoints$t[,46], c(0.025, 0.975))[1],3),
  diffacc_ciup12 = round(quantile(boot_results_twocutpoints$t[,46], c(0.025, 0.975))[2],3),
  diff_ppv12 = round(boot_results_twocutpoints$t0[47], 3),
  diffppv_cilow12 = round(quantile(boot_results_twocutpoints$t[,47], c(0.025, 0.975))[1],3),
  diffppv_ciup12 = round(quantile(boot_results_twocutpoints$t[,47], c(0.025, 0.975))[2],3),
  diff_npv12 = round(boot_results_twocutpoints$t0[48], 3),
  diffnpv_cilow12 = round(quantile(boot_results_twocutpoints$t[,48], c(0.025, 0.975))[1],3),
  diffnpv_ciup12 = round(quantile(boot_results_twocutpoints$t[,48], c(0.025, 0.975))[2],3),
  
  diff_acc13 = round(boot_results_twocutpoints$t0[49], 3),
  diffacc_cilow13 = round(quantile(boot_results_twocutpoints$t[,49], c(0.025, 0.975))[1],3),
  diffacc_ciup13 = round(quantile(boot_results_twocutpoints$t[,49], c(0.025, 0.975))[2],3),
  diff_ppv13 = round(boot_results_twocutpoints$t0[50], 3),
  diffppv_cilow13 = round(quantile(boot_results_twocutpoints$t[,50], c(0.025, 0.975))[1],3),
  diffppv_ciup13 = round(quantile(boot_results_twocutpoints$t[,50], c(0.025, 0.975))[2],3),
  diff_npv13 = round(boot_results_twocutpoints$t0[51], 3),
  diffnpv_cilow13 = round(quantile(boot_results_twocutpoints$t[,51], c(0.025, 0.975))[1],3),
  diffnpv_ciup13 = round(quantile(boot_results_twocutpoints$t[,51], c(0.025, 0.975))[2],3),
  
  diff_acc23 = round(boot_results_twocutpoints$t0[52], 3),
  diffacc_cilow23 = round(quantile(boot_results_twocutpoints$t[,52], c(0.025, 0.975))[1],3),
  diffacc_ciup23 = round(quantile(boot_results_twocutpoints$t[,52], c(0.025, 0.975))[2],3),
  diff_ppv23 = round(boot_results_twocutpoints$t0[53], 3),
  diffppv_cilow23 = round(quantile(boot_results_twocutpoints$t[,53], c(0.025, 0.975))[1],3),
  diffppv_ciup23 = round(quantile(boot_results_twocutpoints$t[,53], c(0.025, 0.975))[2],3),
  diff_npv23 = round(boot_results_twocutpoints$t0[54], 3),
  diffnpv_cilow23 = round(quantile(boot_results_twocutpoints$t[,54], c(0.025, 0.975))[1],3),
  diffnpv_ciup23 = round(quantile(boot_results_twocutpoints$t[,54], c(0.025, 0.975))[2],3),
  
  intermediate_n1 = round(boot_results_greyzone$t0[26],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,26], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,26], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[25],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,25], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high1= round(quantile(boot_results_greyzone$t[,25], c(0.025, 0.975))[2],3),
  
  intermediate_n2 = round(boot_results_greyzone$t0[28],3),
  intermediate_cilow2 = round(quantile(boot_results_greyzone$t[,28], c(0.025, 0.975))[1],3),
  intermediate_cihigh2 = round(quantile(boot_results_greyzone$t[,28], c(0.025, 0.975))[2],3),
  intermediate_n_percentage2= round(boot_results_greyzone$t0[27],3),
  intermediate_n_percentage_low2= round(quantile(boot_results_greyzone$t[,27], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high2= round(quantile(boot_results_greyzone$t[,27], c(0.025, 0.975))[2],3),
  
  intermediate_n3 = round(boot_results_greyzone$t0[30],3),
  intermediate_cilow3 = round(quantile(boot_results_greyzone$t[,30], c(0.025, 0.975))[1],3),
  intermediate_cihigh3 = round(quantile(boot_results_greyzone$t[,30], c(0.025, 0.975))[2],3),
  intermediate_n_percentage3 = round(boot_results_greyzone$t0[29],3),
  intermediate_n_percentage_low3 = round(quantile(boot_results_greyzone$t[,29], c(0.025, 0.975))[2],3),
  intermediate_n_percentage_high3 = round(quantile(boot_results_greyzone$t[,29], c(0.025, 0.975))[2],3),
  
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoint")

###Add all together in a dataframe----

results_2cp <- bind_rows(results_2cp_lumi, results_2cp_c2n, results_2cp_c2nratio)
results_2cp <- results_2cp %>% rownames_to_column(var="Cutpoint")


##Pvalues 2cp
stat_indices <- list(
  "Accuracy pval Lumi12" = 10,"PPV pval Lumi12" =11,"NPV pval Lumi12" = 12,
  "Accuracy pval Lumi13" = 13,"PPV pval Lumi13" =14,"NPV pval Lumi13" = 15,
  "Accuracy pval Lumi23" = 16,"PPV pval Lumi23" =17,"NPV pval Lumi23" = 18,
  "Accuracy pval C2N12" = 28, "PPV pval C2N12" = 29,"NPV pval C2N12" = 30,
  "Accuracy pval C2N13" = 31, "PPV pval C2N13" = 32,"NPV pval C2N13" = 33,
  "Accuracy pval C2N23" = 34, "PPV pval C2N23" = 35,"NPV pval C2N23" = 36,
  "Accuracy pval %C2N12" = 46, "PPV pval %C2N12" = 47,"NPV pval %C2N12" = 48,
  "Accuracy pval %C2N13" = 49, "PPV pval %C2N13" = 50,"NPV pval %C2N13" = 51,
  "Accuracy pval %C2N23" = 52, "PPV pval %C2N23" = 53,"NPV pval %C2N23" = 54,

  "Accuracy pval Lumi vs. C2N12" = 55,"PPV pval Lumi vs. C2N12" = 56,"NPV pval Lumi vs. C2N12" = 57,
  "Accuracy pval Lumi vs. C2N13" = 58,"PPV pval Lumi vs. C2N13" = 59,"NPV pval Lumi vs. C2N13" = 60,
  "Accuracy pval Lumi vs. C2N23" = 61,"PPV pval Lumi vs. C2N23" = 62,"NPV pval Lumi vs. C2N23" = 63,

  "Accuracy pval Lumi vs. %C2N12" = 64,"PPV pval Lumi vs. %C2N12" = 65,"NPV pval Lumi vs. %C2N12" = 66,
  "Accuracy pval Lumi vs. %C2N13" = 67,"PPV pval Lumi vs. %C2N13" = 68,"NPV pval Lumi vs. %C2N13" = 69,
  "Accuracy pval Lumi vs. %C2N23" = 70,"PPV pval Lumi vs. %C2N23" = 71,"NPV pval Lumi vs. %C2N23" = 72,

  "Accuracy pval C2N vs. %C2N12" = 73,"PPV pval C2N vs. %C2N12" = 74, "NPV pval C2N  vs. %C2N12" = 75,
  "Accuracy pval C2N vs. %C2N13" = 76,"PPV pval C2N vs. %C2N13" = 77, "NPV pval C2N  vs. %C2N13" = 78,  
  "Accuracy pval C2N vs. %C2N23" = 79,"PPV pval C2N vs. %C2N23" = 80, "NPV pval C2N  vs. %C2N23" = 81)

pvals_age_2cp <- data.frame(
  Age = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi12", "PPV pval Lumi12", "NPV pval Lumi12",
  "Accuracy pval Lumi13", "PPV pval Lumi13", "NPV pval Lumi13",
  "Accuracy pval Lumi23", "PPV pval Lumi23", "NPV pval Lumi23",
  "Accuracy pval C2N12", "PPV pval C2N12", "NPV pval C2N12",
  "Accuracy pval C2N13", "PPV pval C2N13", "NPV pval C2N13",
  "Accuracy pval C2N23", "PPV pval C2N23", "NPV pval C2N23",
  "Accuracy pval %C2N12", "PPV pval %C2N12", "NPV pval %C2N12",
  "Accuracy pval %C2N13", "PPV pval %C2N13", "NPV pval %C2N13",
  "Accuracy pval %C2N23", "PPV pval %C2N23", "NPV pval %C2N23",
  "Accuracy pval Lumi vs. C2N12", "PPV pval Lumi vs. C2N12", "NPV pval Lumi vs. C2N12",
  "Accuracy pval Lumi vs. C2N13", "PPV pval Lumi vs. C2N13", "NPV pval Lumi vs. C2N13",
  "Accuracy pval Lumi vs. C2N23", "PPV pval Lumi vs. C2N23", "NPV pval Lumi vs. C2N23",
  "Accuracy pval Lumi vs. %C2N12", "PPV pval Lumi vs. %C2N12", "NPV pval Lumi vs. %C2N12",
  "Accuracy pval Lumi vs. %C2N13", "PPV pval Lumi vs. %C2N13", "NPV pval Lumi vs. %C2N13",
  "Accuracy pval Lumi vs. %C2N23", "PPV pval Lumi vs. %C2N23", "NPV pval Lumi vs. %C2N23",
  "Accuracy pval C2N vs. %C2N12", "PPV pval C2N vs. %C2N12", "NPV pval C2N vs. %C2N12",
  "Accuracy pval C2N vs. %C2N13", "PPV pval C2N vs. %C2N13", "NPV pval C2N vs. %C2N13",
  "Accuracy pval C2N vs. %C2N23", "PPV pval C2N vs. %C2N23", "NPV pval C2N vs. %C2N23"))

bootstrap_replicates <- boot_results_twocutpoints$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_twocutpoints$t0[index]
  results_underH0_diff <- bootstrap_replicates[, index] - mean(bootstrap_replicates[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_age_2cp[paste0(stat_name), "Age"] <- round(p_value, 3)
}


merged_comps_age <- rbind(results_1cp, results_2cp) %>% 
  mutate(Cohort = "Age") #merge 2 dataframes
merged_comps_age$Cutpoint <- c("1 Cutpoint","1 Cutpoint","1 Cutpoint","2 Cutpoint","2 Cutpoint","2 Cutpoint")
merged_comps_age$modeltype <- c("1", "1", "1", "2", "2", "2")

participants_g1 <- nrow(lumi.1)
participants_g1_csf0 <- sum(lumi.1$csf_status == 0)
participants_g1_csf1 <- sum(lumi.1$csf_status == 1)

participants_g2 <- nrow(lumi.2)
participants_g2_csf0 <- sum(lumi.2$csf_status == 0)
participants_g2_csf1 <- sum(lumi.2$csf_status == 1)

participants_g3 <- nrow(lumi.3)
participants_g3_csf0 <- sum(lumi.3$csf_status == 0)
participants_g3_csf1 <- sum(lumi.3$csf_status == 1)

merged_comps_age$G1 <- c(paste(participants_g1_csf0, "/", participants_g1_csf1), paste(participants_g1_csf0, "/", participants_g1_csf1))
merged_comps_age$G2 <- c(paste(participants_g2_csf0, "/", participants_g2_csf1), paste(participants_g2_csf0, "/", participants_g2_csf1))
merged_comps_age$G3 <- c(paste(participants_g3_csf0, "/", participants_g3_csf1), paste(participants_g3_csf0, "/", participants_g3_csf1))

openxlsx::write.xlsx(merged_comps_age,file="C2N_Age.xlsx", rowNames =T)


pvalues_age <- rbind(
  pvals_age_1cp,
  pvals_age_intermediate,
  pvals_age_2cp
)
pvalues_age <- pvalues_age %>% drop_na()
openxlsx::write.xlsx(pvalues_age,file="C2N_Age_Pvalues.xlsx", rowNames =T)

```

```{r forest plot Age 1cp, echo=F}
merged_comps <- read_excel("C2Npooled_1cp_age.xlsx")

plot_auc1 <- cbind(merged_comps[0:3, 3:5])
plot_auc1$group <- c("1", "1", "1")
colnames(plot_auc1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_auc2 <- cbind(merged_comps[0:3, 15:17])
plot_auc2$group <- c("2", "2", "2")
colnames(plot_auc2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_auc3 <- cbind(merged_comps[0:3, 27:29])
plot_auc3$group <- c("3", "3", "3")
colnames(plot_auc3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_auc <- rbind(plot_auc1, plot_auc2, plot_auc3)
plot_auc$Measure <- c("AUC", "AUC", "AUC","AUC", "AUC", "AUC","AUC", "AUC", "AUC")
plot_auc$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")

plot_acc1 <- cbind(merged_comps[0:3, 6:8])
plot_acc1$group <- c("1", "1", "1")
colnames(plot_acc1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc2 <- cbind(merged_comps[0:3, 18:20])
plot_acc2$group <- c("2", "2", "2")
colnames(plot_acc2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc3 <- cbind(merged_comps[0:3, 30:32])
plot_acc3$group <- c("3", "3", "3")
colnames(plot_acc3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_acc <- rbind(plot_acc1, plot_acc2, plot_acc3)
plot_acc$Measure <- c("Accuracy", "Accuracy", "Accuracy","Accuracy", "Accuracy", "Accuracy","Accuracy", "Accuracy", "Accuracy")
plot_acc$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")

plot_ppv1 <- cbind(merged_comps[0:3, 9:11])
plot_ppv1$group <- c("1", "1", "1")
colnames(plot_ppv1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv2 <- cbind(merged_comps[0:3, 21:23])
plot_ppv2$group <- c("2", "2", "2")
colnames(plot_ppv2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv3 <- cbind(merged_comps[0:3, 33:35])
plot_ppv3$group <- c("3", "3", "3")
colnames(plot_ppv3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_ppv <- rbind(plot_ppv1, plot_ppv2, plot_ppv3)
plot_ppv$Measure <- c("PPV", "PPV", "PPV","PPV", "PPV", "PPV","PPV", "PPV", "PPV")
plot_ppv$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")

plot_npv1 <- cbind(merged_comps[0:3, 12:14])
plot_npv1$group <- c("1", "1", "1")
colnames(plot_npv1) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv2 <- cbind(merged_comps[0:3, 24:26])
plot_npv2$group <- c("2", "2", "2")
colnames(plot_npv2) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv3 <- cbind(merged_comps[0:3, 36:38])
plot_npv3$group <- c("3", "3", "3")
colnames(plot_npv3) <- c("Measure1", "ci_low", "ci_high", "group")
plot_npv <- rbind(plot_npv1, plot_npv2, plot_npv3)
plot_npv$Measure <- c("NPV", "NPV", "NPV","NPV", "NPV", "NPV","NPV", "NPV", "NPV")
plot_npv$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")

plotdata <- rbind(plot_auc, plot_acc, plot_ppv, plot_npv)
plotdata <- rbind(plot_auc, plot_acc)

group_order <- c("AUC", "NPV", "PPV", "Accuracy")
group_order <- c("AUC", "Accuracy")

comorbd_order <- c("3","2", "1")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(70, 100, by = 10)

#Plot

plotdata <- rbind(plot_auc, plot_acc)
group_order <- c("AUC", "Accuracy")
comorbd_order <- c("3","2", "1")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(70, 100, by = 10)

ggplot(data=plotdata, aes(y = factor(Measure, levels=group_order), x = Measure1 * 100,fill=factor(group, levels=comorbd_order), shape=Assay, color=factor(group, levels=comorbd_order)))+
  geom_vline(xintercept = tick_positions, color = "grey80", linewidth = 0.5, alpha=0.5) +
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100, shape=factor(Assay, levels=desired_order)),
                width = 0.3, linewidth = 0.5, position = position_dodge(width = 0.85)) +
  geom_point(aes(shape=factor(Assay, levels=desired_order)), position = position_dodge(width = 0.85), size = 3, stroke = 0.5) +
  scale_x_continuous(limits=c(70,115),breaks = seq(70,115, by=10),expand =c(0,0))+
  labs(x = "Percentage", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), group=interaction(factor(group, levels=comorbd_order),(factor(Assay, levels=desired_order))), x=98),
            position = position_dodge(width = 0.85), hjust = -0.3, size = 3, color = "black") +
   scale_color_manual(values=c("#3C5488FF", "#E64B35FF", "#4DBBD5FF"), labels=c("80+", "73-80", ">73"))+
  scale_fill_manual(values=c("#3C5488FF","#E64B35FF", "#4DBBD5FF"), labels=c("80+", "73-80", ">73"))+
  scale_shape_manual(values = c("Lumipulse"=21, "C2N"=22,"C2N%"=24)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8), 
        legend.title = element_blank())

ggsave("Age_1cp_ed.pdf",device = "pdf",width = 140, dpi=500, height = 140, units = "mm")

```




#Comparisons C2N and Lumipulse across cognitive stages

```{r setup, include=FALSE, echo=F}
library(readxl)
library(tidyverse)
library(pROC)
library(boot)
library(cutpointr)
BFMC <- read_xlsx("BFMC_data.xlsx")
BFPC <- read_xlsx("BFPC_data.xlsx")
Got <- read_xlsx("Gothenburg_data_C2N.xlsx")
Bres <- read_xlsx("Brescia_data_C2N.xlsx")

lumi <- rbind(BFMC, Bres, Got, BFPC)

lumi$ptau217_spec90_lumi <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 
lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 

lumi <- lumi %>% drop_na(cognitive_status)
lumi <- lumi %>% drop_na(p_tau217_v2,p_tau217_ratio_v2)

lumi.df <- lumi
```

#SCD
```{r comp SCD, echo=F}
lumi <- lumi.df
lumi <- lumi %>% filter(cognitive_status == "1") 

##AUC differences with DeLong----
biomarkers <- c("pl_ptau217", "p_tau217_v2", "p_tau217_ratio_v2")

results_delong <- list()
index <- 1

for (i in seq_along(biomarkers)){
  for (j in seq_along(biomarkers)){ 
    if (i < j) {
      predictor1 <- biomarkers[i]
      predictor2 <- biomarkers[j]
      
      formula1 <- as.formula(paste("csf_status~",predictor1, collapse=""))
      formula2 <- as.formula(paste("csf_status~",predictor2, collapse=""))
      
      roc_curve1 <- pROC::roc(formula1, data=lumi, quiet=T)
      roc_curve2 <- pROC::roc(formula2, data=lumi,quiet=T)
      
      res <- roc.test(roc_curve1, roc_curve2, method = "delong")
      
      long <- data.frame(
        comp = paste(predictor1, predictor2, sep="_"),
        zstat = round(res$statistic,3), 
        pval = round(res$p.value,3),
        auc1 = round(roc_curve1$auc,3),
        auc2 = round(roc_curve2$auc,3),
        auc1_ci_low = round(ci.auc(roc_curve1)[1],3),
        auc1_ci_high =round(ci.auc(roc_curve1)[3],3),
        auc2_ci_low =round(ci.auc(roc_curve2)[1],3),
        auc2_ci_high = round(ci.auc(roc_curve2)[3],3))
      
      results_delong[[length(results_delong) + 1]] <- long
      index <- index + 1
    }
  }
}


results_delong <- do.call(rbind.data.frame, results_delong)
results_delong$padj <- round(p.adjust(results_delong$pval, method = "fdr"),3)
openxlsx::write.xlsx(results_delong,
                     file="SCD_C2Ncomp_DeLong.xlsx")


f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  #Create confusion matrix for Lumi
  v_tp=sum(d$csf_status==1 & d$ptau217_spec90_lumi==1)#change
  v_fp=sum(d$csf_status==0 & d$ptau217_spec90_lumi==1)
  v_tn=sum(d$csf_status==0 & d$ptau217_spec90_lumi==0)
  v_fn=sum(d$csf_status==1 & d$ptau217_spec90_lumi==0)
  acc_lumi=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  PPV_lumi=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  NPV_lumi=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)

  #Create confusion matrix for C2N
  v_tp_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==1) #change
  v_fp_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==1)
  v_tn_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==0)
  v_fn_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==0)
  acc_c=(v_tp_c+v_tn_c)/(v_tp_c+v_tn_c+v_fn_c+v_fp_c)
  PPV_c=ppv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  NPV_c=npv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  
  #Create confusion matrix for C2N Ratio
  cv_tp=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==1)
  cv_fp=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==1)
  cv_tn=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==0)
  cv_fn=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==0)
  acc_c2nr=(cv_tp+cv_tn)/(cv_tp+cv_tn+cv_fn+cv_fp)
  PPV_c2nr=ppv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  NPV_c2nr=npv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  
  
  acclumi_c2n <- acc_lumi - acc_c
  acclumi_c2nratio <- acc_lumi - acc_c2nr
  accc2n_c2nratio <- acc_c - acc_c2nr

  ppvlumi_c2n <- PPV_lumi - PPV_c
  ppvlumi_c2nratio <- PPV_lumi - PPV_c2nr
  ppvc2n_c2nratio <- PPV_c - PPV_c2nr
  
  npvlumi_c2n <- NPV_lumi - NPV_c
  npvlumi_c2nratio <- NPV_lumi - NPV_c2nr
  npvc2n_c2nratio <- NPV_c - NPV_c2nr
  return(c(acc_lumi, acc_c, acc_c2nr, PPV_lumi, PPV_c, PPV_c2nr, NPV_lumi, NPV_c, NPV_c2nr,#9
           acclumi_c2n, acclumi_c2nratio, accc2n_c2nratio, ppvlumi_c2n,ppvlumi_c2nratio, ppvc2n_c2nratio,#15
           npvlumi_c2n, npvlumi_c2nratio,npvc2n_c2nratio))
}

set.seed(12345)

boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 13,
  "NPV pval Lumi vs. C2N" = 16,
  "Accuracy pval Lumi vs. %C2N" = 11,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 17,
  "Accuracy pval C2N vs. %C2N" = 12,
  "PPV pval C2N vs. %C2N" = 15,
  "NPV pval C2N vs. %C2N" = 18)

pvals_1cp <- data.frame(
  SCD = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N vs. %C2N"))

bootstrap_replicates <- boot_results$t
for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results$t0[index]
  results_underH0_diff <- bootstrap_replicates[, index] - mean(bootstrap_replicates[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_1cp[paste0(stat_name), "SCD"] <- round(p_value, 3)
}

##Add results to dataframe, will be used for plotting ----
results_1cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = round(results_delong$auc1[1],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[1], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[1], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[7], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2n <- data.frame(
method = "C2N",
  auc1 = round(results_delong$auc1[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[2], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[5], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975), na.rm=T)[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[8], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = round(results_delong$auc2[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc2_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc2_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[6], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

merged_results_1cp <- rbind(results_1cp_lumi, results_1cp_c2n, results_1cp_c2nratio)

lumi$ptau217_spec90_lumi <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95_lumi <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95_lumi <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 
lumi$ptau217_spec95_c2n <- ifelse(lumi$p_tau217_v2 > 2.92, 1, 0)
lumi$ptau217_sens95_c2n <- ifelse(lumi$p_tau217_v2 > 1.59, 1, 0)

lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 
lumi$ptau217_spec95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 5.08, 1, 0)
lumi$ptau217_sens95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 3.55, 1, 0)

##Greyzone---

lumi <- lumi %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                      # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  
  d_lumi <- d #%>%
  # mutate(greyzone_lumi = case_when(
  #   ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
  #   ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
  #   TRUE ~ 2                     # Intermediate values
  # ))

  intermediate_n_lumi <- length(which(d_lumi$greyzone_lumi ==2))
  intermediate_npercent_lumi <- round((length(which(d_lumi$greyzone_lumi == 2)) / nrow(d_lumi)) * 100, 3)

  #C2N
   d_c2n <- d #%>%
  # mutate(greyzone_c2n = case_when(
  #   ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
  #   ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
  #   TRUE ~ 2                     # Intermediate values
  # ))

  intermediate_n_c2n <- length(which(d_c2n$greyzone_c2n ==2))
  intermediate_npercent_c2n <- round((length(which(d_c2n$greyzone_c2n == 2)) / nrow(d_c2n)) * 100, 3)
  
  #C2N ratio
  d_c2nr <- d #%>%
  # mutate(greyzone_c2nr = case_when(
  #   ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
  #   ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
  #   TRUE ~ 2                     # Intermediate values
  # ))

  intermediate_n_c2nr <- length(which(d_c2nr$greyzone_c2nr == 2))
  intermediate_npercent_c2nr <- round((length(which(d_c2nr$greyzone_c2nr == 2)) / nrow(d_c2nr)) * 100, 3)
  
  #DIFFERENCES BETWEEN ASSAYS
  ##lumi vs. C2N
  diff_n_lumi_c2n <- intermediate_n_lumi - intermediate_n_c2n
  diff_nperc_lumi_c2n <- intermediate_npercent_lumi - intermediate_npercent_c2n

  ##lumi vs. C2N%
  diff_n_lumi_c2nr <- intermediate_n_lumi - intermediate_n_c2nr
  diff_nperc_lumi_c2nr <- intermediate_npercent_lumi - intermediate_npercent_c2nr

  ##C2n vs. C2N%
  diff_n_c2n_c2nr <- intermediate_n_c2n - intermediate_n_c2nr
  diff_nperc_c2n_c2nr <- intermediate_npercent_c2n - intermediate_npercent_c2nr

  return(c(intermediate_npercent_lumi, intermediate_n_lumi,intermediate_npercent_c2n, intermediate_n_c2n, #% is 1,3,5
           intermediate_npercent_c2nr, intermediate_n_c2nr,
           diff_n_lumi_c2n,diff_nperc_lumi_c2n,diff_n_lumi_c2nr,diff_nperc_lumi_c2nr,diff_n_c2n_c2nr,diff_nperc_c2n_c2nr))
}

set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)

stat_indices <- list(
  "Intermediate N pval Lumi vs. C2N" = 7, "Intermediate N pval Lumi vs. C2N%" =9 , "Intermediate N pval C2N vs. C2N%" = 11, 
  "Intermediate Perc pval Lumi vs. C2N" =8 , "Intermediate Perc pval Lumi vs. C2N%" = 10, "Intermediate Perc pval C2N vs. C2N%" = 12)

pvals_intermediate <- data.frame(
  SCD = numeric(length(stat_indices)),
  row.names = c(
  "Intermediate N pval Lumi vs. C2N", "Intermediate N pval Lumi vs. C2N%", "Intermediate N pval C2N vs. C2N%", 
  "Intermediate Perc pval Lumi vs. C2N", "Intermediate Perc pval Lumi vs. C2N%", "Intermediate Perc pval C2N vs. C2N%"))

bootstrap_replicates_grey <- boot_results_greyzone$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_greyzone$t0[index]
  results_underH0_diff <- bootstrap_replicates_grey[, index] - mean(bootstrap_replicates_grey[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_intermediate[paste0(stat_name), "SCD"] <- round(p_value, 3)
}


#2CPs

f_comp_stats_2cp <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d_lumi <- d %>% filter(greyzone_lumi != 2)
  
  #LUMI
  #Create confusion matrix1
  v_tp=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==1)
  v_fp=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==1)
  v_tn=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==0)
  v_fn=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #C2N
  
  d_c2n  <- d %>% filter(greyzone_c2n != 2)
  
  #Create confusion matrix1
  c2nv_tp=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_fp=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_tn=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==0)
  c2nv_fn=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==0)
  
  #Sensitivity and specificity1
  c2nsens <- c2nv_tp / (c2nv_tp + c2nv_fn)
  c2nspec <- c2nv_tn / (c2nv_tn +c2nv_fp)
  
  #Accuracy1
  c2nacc=(c2nv_tp+c2nv_tn)/(c2nv_tp+c2nv_tn+c2nv_fn+c2nv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nPPV=ppv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  c2nNPV=npv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  #C2NR 
  d_c2nr <- d %>% filter(greyzone_c2nr != 2)
  
  #Create confusion matrix1
  c2nrv_tp=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_fp=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_tn=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==0)
  c2nrv_fn=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==0)
  
  #Sensitivity and specificity1
  c2nrsens <- c2nrv_tp / (c2nrv_tp + c2nrv_fn)
  c2nrspec <- c2nrv_tn / (c2nrv_tn + c2nrv_fp)
  
  #Accuracy1
  c2nracc=(c2nrv_tp+c2nrv_tn)/(c2nrv_tp+c2nrv_tn+c2nrv_fn+c2nrv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nrPPV=ppv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  c2nrNPV=npv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  ##Different comparisons
  
  ##lumi vs. C2N
  diff_acc_lumi_c2n <- acc - c2nacc
  diff_ppv_lumi_c2n <- PPV - c2nPPV
  diff_npv_lumi_c2n <- NPV - c2nNPV

  ##lumi vs. C2N%
  diff_acc_lumi_c2nr <- acc - c2nracc
  diff_ppv_lumi_c2nr <- PPV - c2nrPPV
  diff_npv_lumi_c2nr <- NPV - c2nrNPV
  
   ##C2n vs. C2N%
  diff_acc_c2n_c2nr <- c2nacc - c2nracc
  diff_ppv_c2n_c2nr <- c2nPPV - c2nrPPV
  diff_npv_c2n_c2nr <- c2nNPV - c2nrNPV
  
  
  return(c(acc, PPV, NPV,c2nacc, c2nPPV, c2nNPV,c2nracc, c2nrPPV, c2nrNPV,diff_acc_lumi_c2n, diff_ppv_lumi_c2n, diff_npv_lumi_c2n,diff_acc_lumi_c2nr, diff_ppv_lumi_c2nr, diff_npv_lumi_c2nr,
           diff_acc_c2n_c2nr, diff_ppv_c2n_c2nr, diff_npv_c2n_c2nr))
}

set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi, statistic = f_comp_stats_2cp, R = 2000)

results_2cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[2], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[3], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp C2N----
results_2cp_c2n <- data.frame(
  method = "C2N",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[4], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[5], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[6], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,6], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp %C2N----
results_2cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[7], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[8], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

merged_results_2cp <- rbind(results_2cp_lumi, results_2cp_c2n, results_2cp_c2nratio)

##Pvalues 2cp
stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 11,
  "NPV pval Lumi vs. C2N" = 12,
  "Accuracy pval Lumi vs. %C2N" = 13,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 15,
  "Accuracy pval C2N vs. %C2N" = 16,
  "PPV pval C2N vs. %C2N" = 17,
  "NPV pval C2N vs. %C2N" = 18)

pvals_2cp <- data.frame(
  SCD = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N vs. %C2N"))

bootstrap_replicates_2cp <- boot_results_twocutpoints$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_twocutpoints$t0[index]
  results_underH0_diff <- bootstrap_replicates_2cp[, index] - mean(bootstrap_replicates_2cp[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_2cp[paste0(stat_name), "SCD"] <- round(p_value, 3)
}

merged_comps_scd <- rbind(merged_results_1cp, merged_results_2cp)
merged_comps_scd$Cutpoints <- c("1 Cutpoint","1 Cutpoint","1 Cutpoint","2 Cutpoints","2 Cutpoints","2 Cutpoints")
openxlsx::write.xlsx(merged_comps_scd,file="C2Ncomp_SCD.xlsx", rowNames =T)

pvalues_scd <- rbind(
  pvals_1cp,
  pvals_intermediate,
  pvals_2cp
)
openxlsx::write.xlsx(pvalues_scd,file="C2Ncomp_SCD_pvals.xlsx", rowNames =T)

```

##Figure SCD
```{r SCD Fig 1cp, echo=F}
merged_comps_scd <- read_xlsx("C2Ncomp_SCD.xlsx")

plot_auc <- cbind(merged_comps_scd[0:3, 3:5])
colnames(plot_auc) <- c("Measure1", "ci_low", "ci_high")
plot_auc$Measure <- c("AUC", "AUC", "AUC")
plot_auc$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_auc$Cutpoint <- c("1", "1","1")

plot_acc <- cbind(merged_comps_scd[0:6, 6:8])
colnames(plot_acc) <- c("Measure1", "ci_low", "ci_high")
plot_acc$Measure <- c("Accuracy", "Accuracy", "Accuracy","Accuracy", "Accuracy", "Accuracy")
plot_acc$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_acc$Cutpoint <- c("1", "1","1", "2","2", "2")

plot_ppv <- cbind(merged_comps_scd[0:6, 9:11])
colnames(plot_ppv) <- c("Measure1", "ci_low", "ci_high")
plot_ppv$Measure <- c("PPV", "PPV", "PPV","PPV", "PPV", "PPV")
plot_ppv$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_ppv$Cutpoint <- c("1", "1","1", "2","2", "2")

plot_npv <- cbind(merged_comps_scd[0:6, 12:14])
colnames(plot_npv) <- c("Measure1", "ci_low", "ci_high")
plot_npv$Measure <- "NPV"
plot_npv$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_npv$Cutpoint <- c("1", "1","1", "2","2", "2")

plotdata <- rbind(plot_auc, plot_acc, plot_ppv, plot_npv)
plotdata <- rbind(plot_acc, plot_ppv, plot_npv)
plotdata <- plotdata %>% filter(Cutpoint == "1")

group_order <- c("NPV", "PPV", "Accuracy")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(10, 100, by = 10)

plotdata$Cutpoint <- as.factor(as.character(plotdata$Cutpoint))

ggplot(data=plotdata, aes(y = factor(Measure, levels=group_order), x = Measure1 * 100, shape=factor(Assay, levels=desired_order))) +
  geom_vline(xintercept = tick_positions, color = "grey80", linewidth = 0.5, alpha=0.5) +
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.2, linewidth = 0.5, position = position_dodge(width = 0.8),color="#4DBBD5FF", fill="#4DBBD5FF") +
  geom_point(position = position_dodge(width = 0.8), size = 4, stroke = 0.5, color="#4DBBD5FF", fill="#4DBBD5FF") +
  scale_x_continuous(limits=c(30,124),breaks = seq(30,124, by=10),expand =c(0,0))+
  labs(x = "Percentage", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), group=factor(Assay,levels=desired_order), x=94), 
            position = position_dodge(width = 0.8), hjust = -0.3, size = 3, color = "black") +
  scale_shape_manual(values = c("Lumipulse"=21, "C2N"=22,"C2N%"=24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),  # Decrease legend text size
        legend.title = element_text(size = 8))
ggsave("C2Ncomps_SCD_1cp.pdf",device = "pdf",width = 90, dpi=500, height = 60, units = "mm")
```

```{r SCD Fig 2cp, echo=F}

merged_comps_scd <- read_xlsx("C2Ncomp_SCD.xlsx")
merged_comps_scd<- merged_comps_scd[,2:21]

plot_acc <- cbind(merged_comps_scd[4:6, 5:7])
colnames(plot_acc) <- c("Measure1", "ci_low", "ci_high")
plot_acc$Measure <- c("Accuracy", "Accuracy", "Accuracy")
plot_acc$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_ppv <- cbind(merged_comps_scd[4:6, 8:10])
colnames(plot_ppv) <- c("Measure1", "ci_low", "ci_high")
plot_ppv$Measure <- c("PPV", "PPV", "PPV")
plot_ppv$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_npv <- cbind(merged_comps_scd[4:6, 11:13])
colnames(plot_npv) <- c("Measure1", "ci_low", "ci_high")
plot_npv$Measure <- c("NPV", "NPV", "NPV")
plot_npv$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_grey_scd <- cbind(merged_comps_scd[4:6, 17:19])
colnames(plot_grey_scd) <- c("Measure1", "ci_low", "ci_high")
plot_grey_scd$Measure <- c("SCD")

plotdata <- rbind(plot_acc, plot_ppv, plot_npv)

group_order <- c("NPV", "PPV", "Accuracy")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(10, 100, by = 10)

ggplot(data=plotdata, aes(y = factor(Measure, levels=group_order), x = Measure1 * 100, shape=factor(Assay, levels=desired_order))) +
  geom_vline(xintercept = tick_positions, color = "grey80", linewidth = 0.5, alpha=0.5) +
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.2, linewidth = 0.5, position = position_dodge(width = 0.8),color="#E64B35FF", fill="#E64B35FF") +
  geom_point(position = position_dodge(width = 0.8), size = 4, stroke = 0.5, color="#E64B35FF", fill="#E64B35FF") +
  scale_x_continuous(limits=c(30,124),breaks = seq(30,124, by=10),expand =c(0,0))+
  labs(x = "Percentage", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), group=factor(Assay,levels=desired_order), x=94), 
            position = position_dodge(width = 0.8), hjust = -0.3, size = 3, color = "black") +
  scale_shape_manual(values = c("Lumipulse"=21, "C2N"=22,"C2N%"=24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),  # Decrease legend text size
        legend.title = element_text(size = 8))
ggsave("C2Ncomps_SCD_2cp.pdf",device = "pdf",width = 90, dpi=500, height = 60, units = "mm")
```

#MCI
```{r comp MCI, echo=F}
lumi <- lumi.df
lumi <- lumi %>% filter(cognitive_status == "2")

##AUC differences with DeLong----
biomarkers <- c("pl_ptau217", "p_tau217_v2", "p_tau217_ratio_v2")

results_delong <- list()
index <- 1

for (i in seq_along(biomarkers)){
  for (j in seq_along(biomarkers)){ 
    if (i < j) {
      predictor1 <- biomarkers[i]
      predictor2 <- biomarkers[j]
      
      formula1 <- as.formula(paste("csf_status~",predictor1, collapse=""))
      formula2 <- as.formula(paste("csf_status~",predictor2, collapse=""))
      
      roc_curve1 <- pROC::roc(formula1, data=lumi, quiet=T)
      roc_curve2 <- pROC::roc(formula2, data=lumi,quiet=T)
      
      res <- roc.test(roc_curve1, roc_curve2, method = "delong")
      
      long <- data.frame(
        comp = paste(predictor1, predictor2, sep="_"),
        zstat = round(res$statistic,3), 
        pval = round(res$p.value,3),
        auc1 = round(roc_curve1$auc,3),
        auc2 = round(roc_curve2$auc,3),
        auc1_ci_low = round(ci.auc(roc_curve1)[1],3),
        auc1_ci_high =round(ci.auc(roc_curve1)[3],3),
        auc2_ci_low =round(ci.auc(roc_curve2)[1],3),
        auc2_ci_high = round(ci.auc(roc_curve2)[3],3))
      
      results_delong[[length(results_delong) + 1]] <- long
      index <- index + 1
    }
  }
}


results_delong <- do.call(rbind.data.frame, results_delong)
results_delong$padj <- round(p.adjust(results_delong$pval, method = "fdr"),3)
openxlsx::write.xlsx(results_delong,
                     file="MCI_C2Ncomp_DeLong.xlsx")


f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  #Create confusion matrix for Lumi
  v_tp=sum(d$csf_status==1 & d$ptau217_spec90_lumi==1)#change
  v_fp=sum(d$csf_status==0 & d$ptau217_spec90_lumi==1)
  v_tn=sum(d$csf_status==0 & d$ptau217_spec90_lumi==0)
  v_fn=sum(d$csf_status==1 & d$ptau217_spec90_lumi==0)
  acc_lumi=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  PPV_lumi=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  NPV_lumi=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)

  #Create confusion matrix for C2N
  v_tp_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==1) #change
  v_fp_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==1)
  v_tn_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==0)
  v_fn_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==0)
  acc_c=(v_tp_c+v_tn_c)/(v_tp_c+v_tn_c+v_fn_c+v_fp_c)
  PPV_c=ppv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  NPV_c=npv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  
  #Create confusion matrix for C2N Ratio
  cv_tp=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==1)
  cv_fp=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==1)
  cv_tn=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==0)
  cv_fn=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==0)
  acc_c2nr=(cv_tp+cv_tn)/(cv_tp+cv_tn+cv_fn+cv_fp)
  PPV_c2nr=ppv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  NPV_c2nr=npv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  
  
  acclumi_c2n <- acc_lumi - acc_c
  acclumi_c2nratio <- acc_lumi - acc_c2nr
  accc2n_c2nratio <- acc_c - acc_c2nr

  ppvlumi_c2n <- PPV_lumi - PPV_c
  ppvlumi_c2nratio <- PPV_lumi - PPV_c2nr
  ppvc2n_c2nratio <- PPV_c - PPV_c2nr
  
  npvlumi_c2n <- NPV_lumi - NPV_c
  npvlumi_c2nratio <- NPV_lumi - NPV_c2nr
  npvc2n_c2nratio <- NPV_c - NPV_c2nr
  return(c(acc_lumi, acc_c, acc_c2nr, PPV_lumi, PPV_c, PPV_c2nr, NPV_lumi, NPV_c, NPV_c2nr,#9
           acclumi_c2n, acclumi_c2nratio, accc2n_c2nratio, ppvlumi_c2n,ppvlumi_c2nratio, ppvc2n_c2nratio,#15
           npvlumi_c2n, npvlumi_c2nratio,npvc2n_c2nratio))
}

set.seed(12345)

boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 13,
  "NPV pval Lumi vs. C2N" = 16,
  "Accuracy pval Lumi vs. %C2N" = 11,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 17,
  "Accuracy pval C2N vs. %C2N" = 12,
  "PPV pval C2N vs. %C2N" = 15,
  "NPV pval C2N vs. %C2N" = 18)

pvals_1cp <- data.frame(
  MCI = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N vs. %C2N"))

bootstrap_replicates <- boot_results$t
for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results$t0[index]
  results_underH0_diff <- bootstrap_replicates[, index] - mean(bootstrap_replicates[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_1cp[paste0(stat_name), "MCI"] <- round(p_value, 3)
}

##Add results to dataframe, will be used for plotting ----
results_1cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = round(results_delong$auc1[1],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[1], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[1], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[7], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2n <- data.frame(
method = "C2N",
  auc1 = round(results_delong$auc1[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[2], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[5], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[8], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = round(results_delong$auc2[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc2_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc2_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[6], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

merged_results_1cp <- rbind(results_1cp_lumi, results_1cp_c2n, results_1cp_c2nratio)

lumi$ptau217_spec90_lumi <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95_lumi <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95_lumi <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 
lumi$ptau217_spec95_c2n <- ifelse(lumi$p_tau217_v2 > 2.92, 1, 0)
lumi$ptau217_sens95_c2n <- ifelse(lumi$p_tau217_v2 > 1.59, 1, 0)

lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 
lumi$ptau217_spec95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 5.08, 1, 0)
lumi$ptau217_sens95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 3.55, 1, 0)

##Greyzone---

lumi <- lumi %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                      # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  
  d_lumi <- d %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_lumi <- length(which(d_lumi$greyzone_lumi ==2))
  intermediate_npercent_lumi <- round((length(which(d_lumi$greyzone_lumi == 2)) / nrow(d_lumi)) * 100, 3)

  #C2N
  d_c2n <- d %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_c2n <- length(which(d_c2n$greyzone_c2n ==2))
  intermediate_npercent_c2n <- round((length(which(d_c2n$greyzone_c2n == 2)) / nrow(d_c2n)) * 100, 3)
  
  #C2N ratio
  d_c2nr <- d %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_c2nr <- length(which(d_c2nr$greyzone_c2nr == 2))
  intermediate_npercent_c2nr <- round((length(which(d_c2nr$greyzone_c2nr == 2)) / nrow(d_c2nr)) * 100, 3)
  
  #DIFFERENCES BETWEEN ASSAYS
  ##lumi vs. C2N
  diff_n_lumi_c2n <- intermediate_n_lumi - intermediate_n_c2n
  diff_nperc_lumi_c2n <- intermediate_npercent_lumi - intermediate_npercent_c2n

  ##lumi vs. C2N%
  diff_n_lumi_c2nr <- intermediate_n_lumi - intermediate_n_c2nr
  diff_nperc_lumi_c2nr <- intermediate_npercent_lumi - intermediate_npercent_c2nr

  ##C2n vs. C2N%
  diff_n_c2n_c2nr <- intermediate_n_c2n - intermediate_n_c2nr
  diff_nperc_c2n_c2nr <- intermediate_npercent_c2n - intermediate_npercent_c2nr

  return(c(intermediate_npercent_lumi, intermediate_n_lumi,intermediate_npercent_c2n, intermediate_n_c2n,
           intermediate_npercent_c2nr, intermediate_n_c2nr,
           diff_n_lumi_c2n,diff_nperc_lumi_c2n,diff_n_lumi_c2nr,diff_nperc_lumi_c2nr,diff_n_c2n_c2nr,diff_nperc_c2n_c2nr))
}

set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)

stat_indices <- list(
  "Intermediate N pval Lumi vs. C2N" = 7, "Intermediate N pval Lumi vs. C2N%" =9 , "Intermediate N pval C2N vs. C2N%" = 11, 
  "Intermediate Perc pval Lumi vs. C2N" =8 , "Intermediate Perc pval Lumi vs. C2N%" = 10, "Intermediate Perc pval C2N vs. C2N%" = 12)

pvals_intermediate <- data.frame(
  MCI = numeric(length(stat_indices)),
  row.names = c(
  "Intermediate N pval Lumi vs. C2N", "Intermediate N pval Lumi vs. C2N%", "Intermediate N pval C2N vs. C2N%", 
  "Intermediate Perc pval Lumi vs. C2N", "Intermediate Perc pval Lumi vs. C2N%", "Intermediate Perc pval C2N vs. C2N%"))

bootstrap_replicates_grey <- boot_results_greyzone$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_greyzone$t0[index]
  results_underH0_diff <- bootstrap_replicates_grey[, index] - mean(bootstrap_replicates_grey[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_intermediate[paste0(stat_name), "MCI"] <- round(p_value, 3)
}


#2CPs

f_comp_stats_2cp <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d_lumi <- d %>% filter(greyzone_lumi != 2)
  
  #LUMI
  #Create confusion matrix1
  v_tp=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==1)
  v_fp=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==1)
  v_tn=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==0)
  v_fn=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #C2N
  
  d_c2n  <- d %>% filter(greyzone_c2n != 2)
  
  
  #Create confusion matrix1
  c2nv_tp=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_fp=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_tn=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==0)
  c2nv_fn=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==0)
  
  #Sensitivity and specificity1
  c2nsens <- c2nv_tp / (c2nv_tp + c2nv_fn)
  c2nspec <- c2nv_tn / (c2nv_tn +c2nv_fp)
  
  #Accuracy1
  c2nacc=(c2nv_tp+c2nv_tn)/(c2nv_tp+c2nv_tn+c2nv_fn+c2nv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nPPV=ppv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  c2nNPV=npv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  #C2NR 
  d_c2nr <- d %>% filter(greyzone_c2nr != 2)
  
  #Create confusion matrix1
  c2nrv_tp=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_fp=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_tn=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==0)
  c2nrv_fn=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==0)
  
  #Sensitivity and specificity1
  c2nrsens <- c2nrv_tp / (c2nrv_tp + c2nrv_fn)
  c2nrspec <- c2nrv_tn / (c2nrv_tn + c2nrv_fp)
  
  #Accuracy1
  c2nracc=(c2nrv_tp+c2nrv_tn)/(c2nrv_tp+c2nrv_tn+c2nrv_fn+c2nrv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nrPPV=ppv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  c2nrNPV=npv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  ##Different comparisons
  
  ##lumi vs. C2N
  diff_acc_lumi_c2n <- acc - c2nacc
  diff_ppv_lumi_c2n <- PPV - c2nPPV
  diff_npv_lumi_c2n <- NPV - c2nNPV

  ##lumi vs. C2N%
  diff_acc_lumi_c2nr <- acc - c2nracc
  diff_ppv_lumi_c2nr <- PPV - c2nrPPV
  diff_npv_lumi_c2nr <- NPV - c2nrNPV
  
   ##C2n vs. C2N%
  diff_acc_c2n_c2nr <- c2nacc - c2nracc
  diff_ppv_c2n_c2nr <- c2nPPV - c2nrPPV
  diff_npv_c2n_c2nr <- c2nNPV - c2nrNPV
  
  
  return(c(acc, PPV, NPV,c2nacc, c2nPPV, c2nNPV,c2nracc, c2nrPPV, c2nrNPV,diff_acc_lumi_c2n, diff_ppv_lumi_c2n, diff_npv_lumi_c2n,diff_acc_lumi_c2nr, diff_ppv_lumi_c2nr, diff_npv_lumi_c2nr,
           diff_acc_c2n_c2nr, diff_ppv_c2n_c2nr, diff_npv_c2n_c2nr))
}

set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi, statistic = f_comp_stats_2cp, R = 2000)

results_2cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[2], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[3], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp C2N----
results_2cp_c2n <- data.frame(
  method = "C2N",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp %C2N----
results_2cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[7], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[8], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

merged_results_2cp <- rbind(results_2cp_lumi, results_2cp_c2n, results_2cp_c2nratio)

##Pvalues 2cp
stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 11,
  "NPV pval Lumi vs. C2N" = 12,
  "Accuracy pval Lumi vs. %C2N" = 13,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 15,
  "Accuracy pval C2N vs. %C2N" = 16,
  "PPV pval C2N vs. %C2N" = 17,
  "NPV pval C2N vs. %C2N" = 18)

pvals_2cp <- data.frame(
  MCI = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N vs. %C2N"))

bootstrap_replicates_2cp <- boot_results_twocutpoints$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_twocutpoints$t0[index]
  results_underH0_diff <- bootstrap_replicates_2cp[, index] - mean(bootstrap_replicates_2cp[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_2cp[paste0(stat_name), "MCI"] <- round(p_value, 3)
}



merged_comps_mci <- rbind(merged_results_1cp, merged_results_2cp)
merged_comps_mci$Cutpoints <- c("1 Cutpoint","1 Cutpoint","1 Cutpoint","2 Cutpoints","2 Cutpoints","2 Cutpoints")
openxlsx::write.xlsx(merged_comps_mci,file="C2Ncomp_MCI.xlsx", rowNames =T)

pvalues_mci <- rbind(
  pvals_1cp,
  pvals_intermediate,
  pvals_2cp
)
openxlsx::write.xlsx(pvalues_mci,file="C2Ncomp_MCI_pvals.xlsx", rowNames =T)

```

##Figure MCI
```{r MCI Fig 1cp, echo=F}
merged_comps_scd <- read_xlsx("C2Ncomp_MCI.xlsx")

plot_auc <- cbind(merged_comps_scd[0:3, 3:5])
colnames(plot_auc) <- c("Measure1", "ci_low", "ci_high")
plot_auc$Measure <- c("AUC", "AUC", "AUC")
plot_auc$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_auc$Cutpoint <- c("1", "1","1")

plot_acc <- cbind(merged_comps_scd[0:6, 6:8])
colnames(plot_acc) <- c("Measure1", "ci_low", "ci_high")
plot_acc$Measure <- c("Accuracy", "Accuracy", "Accuracy","Accuracy", "Accuracy", "Accuracy")
plot_acc$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_acc$Cutpoint <- c("1", "1","1", "2","2", "2")

plot_ppv <- cbind(merged_comps_scd[0:6, 9:11])
colnames(plot_ppv) <- c("Measure1", "ci_low", "ci_high")
plot_ppv$Measure <- c("PPV", "PPV", "PPV","PPV", "PPV", "PPV")
plot_ppv$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_ppv$Cutpoint <- c("1", "1","1", "2","2", "2")

plot_npv <- cbind(merged_comps_scd[0:6, 12:14])
colnames(plot_npv) <- c("Measure1", "ci_low", "ci_high")
plot_npv$Measure <- "NPV"
plot_npv$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_npv$Cutpoint <- c("1", "1","1", "2","2", "2")

plotdata <- rbind(plot_auc, plot_acc, plot_ppv, plot_npv)
plotdata <- rbind(plot_acc, plot_ppv, plot_npv)
plotdata <- plotdata %>% filter(Cutpoint == "1")

group_order <- c("NPV", "PPV", "Accuracy")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(10, 100, by = 10)

plotdata$Cutpoint <- as.factor(as.character(plotdata$Cutpoint))

ggplot(data=plotdata, aes(y = factor(Measure, levels=group_order), x = Measure1 * 100, shape=factor(Assay, levels=desired_order))) +
  geom_vline(xintercept = tick_positions, color = "grey80", linewidth = 0.5, alpha=0.5) +
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.2, linewidth = 0.5, position = position_dodge(width = 0.8),color="#4DBBD5FF", fill="#4DBBD5FF") +
  geom_point(position = position_dodge(width = 0.8), size = 4, stroke = 0.5, color="#4DBBD5FF", fill="#4DBBD5FF") +
  scale_x_continuous(limits=c(70,124),breaks = seq(70,124, by=10),expand =c(0,0))+
  labs(x = "Percentage", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), group=factor(Assay,levels=desired_order), x=94), 
            position = position_dodge(width = 0.8), hjust = -0.3, size = 3, color = "black") +
  scale_shape_manual(values = c("Lumipulse"=21, "C2N"=22,"C2N%"=24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8), 
        legend.title = element_text(size = 8))

ggsave("C2Ncomps_MCI_1cp.pdf",device = "pdf",width = 90, dpi=500, height = 60, units = "mm")

```

```{r MCI Fig 2cp, echo=F}
merged_comps_scd <- read_xlsx("C2Ncomp_MCI.xlsx")
merged_comps_scd<- merged_comps_scd[,2:21]

plot_acc <- cbind(merged_comps_scd[4:6, 5:7])
colnames(plot_acc) <- c("Measure1", "ci_low", "ci_high")
plot_acc$Measure <- c("Accuracy", "Accuracy", "Accuracy")
plot_acc$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_ppv <- cbind(merged_comps_scd[4:6, 8:10])
colnames(plot_ppv) <- c("Measure1", "ci_low", "ci_high")
plot_ppv$Measure <- c("PPV", "PPV", "PPV")
plot_ppv$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_npv <- cbind(merged_comps_scd[4:6, 11:13])
colnames(plot_npv) <- c("Measure1", "ci_low", "ci_high")
plot_npv$Measure <- c("NPV", "NPV", "NPV")
plot_npv$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_grey_scd <- cbind(merged_comps_scd[4:6, 17:19])
colnames(plot_grey_scd) <- c("Measure1", "ci_low", "ci_high")
plot_grey_scd$Measure <- c("SCD")

plotdata <- rbind(plot_acc, plot_ppv, plot_npv)

group_order <- c("NPV", "PPV", "Accuracy")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(10, 100, by = 10)

ggplot(data=plotdata, aes(y = factor(Measure, levels=group_order), x = Measure1 * 100, shape=factor(Assay, levels=desired_order))) +
  geom_vline(xintercept = tick_positions, color = "grey80", linewidth = 0.5, alpha=0.5) +
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.2, linewidth = 0.5, position = position_dodge(width = 0.8),color="#E64B35FF", fill="#E64B35FF") +
  geom_point(position = position_dodge(width = 0.8), size = 4, stroke = 0.5, color="#E64B35FF", fill="#E64B35FF") +
  scale_x_continuous(limits=c(70,124),breaks = seq(70,124, by=10),expand =c(0,0))+
  labs(x = "Percentage", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), group=factor(Assay,levels=desired_order), x=94), 
            position = position_dodge(width = 0.8), hjust = -0.3, size = 3, color = "black") +
  scale_shape_manual(values = c("Lumipulse"=21, "C2N"=22,"C2N%"=24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),  # Decrease legend text size
        legend.title = element_text(size = 8))
ggsave("C2Ncomps_MCI_2cp.pdf",device = "pdf",width = 90, dpi=500, height = 60, units = "mm")
```


#Dementia
```{r comp Dem, echo=F}
lumi <- lumi.df
lumi <- lumi %>% filter(cognitive_status == "3")

##AUC differences with DeLong----
biomarkers <- c("pl_ptau217", "p_tau217_v2", "p_tau217_ratio_v2")

results_delong <- list()
index <- 1

for (i in seq_along(biomarkers)){
  for (j in seq_along(biomarkers)){ 
    if (i < j) {
      predictor1 <- biomarkers[i]
      predictor2 <- biomarkers[j]
      
      formula1 <- as.formula(paste("csf_status~",predictor1, collapse=""))
      formula2 <- as.formula(paste("csf_status~",predictor2, collapse=""))
      
      roc_curve1 <- pROC::roc(formula1, data=lumi, quiet=T)
      roc_curve2 <- pROC::roc(formula2, data=lumi,quiet=T)
      
      res <- roc.test(roc_curve1, roc_curve2, method = "delong")
      
      long <- data.frame(
        comp = paste(predictor1, predictor2, sep="_"),
        zstat = round(res$statistic,3), 
        pval = round(res$p.value,3),
        auc1 = round(roc_curve1$auc,3),
        auc2 = round(roc_curve2$auc,3),
        auc1_ci_low = round(ci.auc(roc_curve1)[1],3),
        auc1_ci_high =round(ci.auc(roc_curve1)[3],3),
        auc2_ci_low =round(ci.auc(roc_curve2)[1],3),
        auc2_ci_high = round(ci.auc(roc_curve2)[3],3))
      
      results_delong[[length(results_delong) + 1]] <- long
      index <- index + 1
    }
  }
}


results_delong <- do.call(rbind.data.frame, results_delong)
results_delong$padj <- round(p.adjust(results_delong$pval, method = "fdr"),3)
openxlsx::write.xlsx(results_delong,
                     file="Dem_C2Ncomp_DeLong.xlsx")


f_comp_stats <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  #Create confusion matrix for Lumi
  v_tp=sum(d$csf_status==1 & d$ptau217_spec90_lumi==1)#change
  v_fp=sum(d$csf_status==0 & d$ptau217_spec90_lumi==1)
  v_tn=sum(d$csf_status==0 & d$ptau217_spec90_lumi==0)
  v_fn=sum(d$csf_status==1 & d$ptau217_spec90_lumi==0)
  acc_lumi=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  PPV_lumi=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  NPV_lumi=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)

  #Create confusion matrix for C2N
  v_tp_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==1) #change
  v_fp_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==1)
  v_tn_c=sum(d$csf_status==0 & d$ptau217_spec90_c2n==0)
  v_fn_c=sum(d$csf_status==1 & d$ptau217_spec90_c2n==0)
  acc_c=(v_tp_c+v_tn_c)/(v_tp_c+v_tn_c+v_fn_c+v_fp_c)
  PPV_c=ppv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  NPV_c=npv(tp = v_tp_c,fp = v_fp_c,
               tn = v_tn_c,fn = v_fn_c)
  
  #Create confusion matrix for C2N Ratio
  cv_tp=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==1)
  cv_fp=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==1)
  cv_tn=sum(d$csf_status==0 & d$ptau217_spec90_c2nr==0)
  cv_fn=sum(d$csf_status==1 & d$ptau217_spec90_c2nr==0)
  acc_c2nr=(cv_tp+cv_tn)/(cv_tp+cv_tn+cv_fn+cv_fp)
  PPV_c2nr=ppv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  NPV_c2nr=npv(tp = cv_tp,fp = cv_fp,
               tn = cv_tn,fn = cv_fn)
  
  
  acclumi_c2n <- acc_lumi - acc_c
  acclumi_c2nratio <- acc_lumi - acc_c2nr
  accc2n_c2nratio <- acc_c - acc_c2nr

  ppvlumi_c2n <- PPV_lumi - PPV_c
  ppvlumi_c2nratio <- PPV_lumi - PPV_c2nr
  ppvc2n_c2nratio <- PPV_c - PPV_c2nr
  
  npvlumi_c2n <- NPV_lumi - NPV_c
  npvlumi_c2nratio <- NPV_lumi - NPV_c2nr
  npvc2n_c2nratio <- NPV_c - NPV_c2nr
  return(c(acc_lumi, acc_c, acc_c2nr, PPV_lumi, PPV_c, PPV_c2nr, NPV_lumi, NPV_c, NPV_c2nr,#9
           acclumi_c2n, acclumi_c2nratio, accc2n_c2nratio, ppvlumi_c2n,ppvlumi_c2nratio, ppvc2n_c2nratio,#15
           npvlumi_c2n, npvlumi_c2nratio,npvc2n_c2nratio))
}

set.seed(12345)

boot_results <- boot(data = lumi, statistic = f_comp_stats, R = 2000)

stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 13,
  "NPV pval Lumi vs. C2N" = 16,
  "Accuracy pval Lumi vs. %C2N" = 11,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 17,
  "Accuracy pval C2N vs. %C2N" = 12,
  "PPV pval C2N vs. %C2N" = 15,
  "NPV pval C2N vs. %C2N" = 18)

pvals_1cp <- data.frame(
  Dem = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N vs. %C2N"))

bootstrap_replicates <- boot_results$t
for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results$t0[index]
  results_underH0_diff <- bootstrap_replicates[, index] - mean(bootstrap_replicates[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_1cp[paste0(stat_name), "Dem"] <- round(p_value, 3)
}

##Add results to dataframe, will be used for plotting ----
results_1cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = round(results_delong$auc1[1],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[1], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[1], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[7], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,7], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2n <- data.frame(
method = "C2N",
  auc1 = round(results_delong$auc1[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc1_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc1_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[2], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,2], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[5], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,5], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[8], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,8], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

results_1cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = round(results_delong$auc2[3],3),
  auc_ci_lower1 = round(quantile(results_delong$auc2_ci_low[3], c(0.025, 0.975))[1],3),
  auc_ci_upper1 = round(quantile(results_delong$auc2_ci_high[3], c(0.025, 0.975))[2],3),
  accuracy1 = round(boot_results$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results$t0[6], 3),
  ppv_ci_lower1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results$t[,6], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = NA,
  intermediate_cilow1 = NA,
  intermediate_cihigh1 = NA,
  intermediate_n_percentage1= NA,
  intermediate_n_percentage_low1= NA,
  intermediate_n_percentage_high1=  NA,
  stringsAsFactors = FALSE,
  row.names = "1 Cutpoint")

merged_results_1cp <- rbind(results_1cp_lumi, results_1cp_c2n, results_1cp_c2nratio)

lumi$ptau217_spec90_lumi <- ifelse(lumi$pl_ptau217 > 0.27, 1, 0) 
lumi$ptau217_spec95_lumi <- ifelse(lumi$pl_ptau217 > 0.34, 1, 0)
lumi$ptau217_sens95_lumi <- ifelse(lumi$pl_ptau217 > 0.22, 1, 0)

lumi$ptau217_spec90_c2n <- ifelse(lumi$p_tau217_v2 > 2.27, 1, 0) 
lumi$ptau217_spec95_c2n <- ifelse(lumi$p_tau217_v2 > 2.92, 1, 0)
lumi$ptau217_sens95_c2n <- ifelse(lumi$p_tau217_v2 > 1.59, 1, 0)

lumi$ptau217_spec90_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 4.27, 1, 0) 
lumi$ptau217_spec95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 5.08, 1, 0)
lumi$ptau217_sens95_c2nr <- ifelse(lumi$p_tau217_ratio_v2 > 3.55, 1, 0)

##Greyzone---

lumi <- lumi %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                      # Intermediate values
  ))

lumi <- lumi %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

f_greyzone <- function(data, indices, roc_curve){
  d <- data[indices, ]
  
  d_lumi <- d %>%
  mutate(greyzone_lumi = case_when(
    ptau217_sens95_lumi == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_lumi == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_lumi <- length(which(d_lumi$greyzone_lumi ==2))
  intermediate_npercent_lumi <- round((length(which(d_lumi$greyzone_lumi == 2)) / nrow(d_lumi)) * 100, 3)

  #C2N
  d_c2n <- d %>%
  mutate(greyzone_c2n = case_when(
    ptau217_sens95_c2n == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2n == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_c2n <- length(which(d_c2n$greyzone_c2n ==2))
  intermediate_npercent_c2n <- round((length(which(d_c2n$greyzone_c2n == 2)) / nrow(d_c2n)) * 100, 3)
  
  #C2N ratio
  d_c2nr <- d %>%
  mutate(greyzone_c2nr = case_when(
    ptau217_sens95_c2nr == 0 ~ 1,  # sens95 equals 0
    ptau217_spec95_c2nr == 1 ~ 3,  # spec95 equals 1
    TRUE ~ 2                     # Intermediate values
  ))

  intermediate_n_c2nr <- length(which(d_c2nr$greyzone_c2nr == 2))
  intermediate_npercent_c2nr <- round((length(which(d_c2nr$greyzone_c2nr == 2)) / nrow(d_c2nr)) * 100, 3)
  
  #DIFFERENCES BETWEEN ASSAYS
  ##lumi vs. C2N
  diff_n_lumi_c2n <- intermediate_n_lumi - intermediate_n_c2n
  diff_nperc_lumi_c2n <- intermediate_npercent_lumi - intermediate_npercent_c2n

  ##lumi vs. C2N%
  diff_n_lumi_c2nr <- intermediate_n_lumi - intermediate_n_c2nr
  diff_nperc_lumi_c2nr <- intermediate_npercent_lumi - intermediate_npercent_c2nr

  ##C2n vs. C2N%
  diff_n_c2n_c2nr <- intermediate_n_c2n - intermediate_n_c2nr
  diff_nperc_c2n_c2nr <- intermediate_npercent_c2n - intermediate_npercent_c2nr

  return(c(intermediate_npercent_lumi, intermediate_n_lumi,intermediate_npercent_c2n, intermediate_n_c2n,
           intermediate_npercent_c2nr, intermediate_n_c2nr,
           diff_n_lumi_c2n,diff_nperc_lumi_c2n,diff_n_lumi_c2nr,diff_nperc_lumi_c2nr,diff_n_c2n_c2nr,diff_nperc_c2n_c2nr))
}

set.seed(12345)
boot_results_greyzone <- boot(data = lumi, statistic = f_greyzone, R = 2000)

stat_indices <- list(
  "Intermediate N pval Lumi vs. C2N" = 7, "Intermediate N pval Lumi vs. C2N%" =9 , "Intermediate N pval C2N vs. C2N%" = 11, 
  "Intermediate Perc pval Lumi vs. C2N" =8 , "Intermediate Perc pval Lumi vs. C2N%" = 10, "Intermediate Perc pval C2N vs. C2N%" = 12)

pvals_intermediate <- data.frame(
  Dem = numeric(length(stat_indices)),
  row.names = c(
  "Intermediate N pval Lumi vs. C2N", "Intermediate N pval Lumi vs. C2N%", "Intermediate N pval C2N vs. C2N%", 
  "Intermediate Perc pval Lumi vs. C2N", "Intermediate Perc pval Lumi vs. C2N%", "Intermediate Perc pval C2N vs. C2N%"))

bootstrap_replicates_grey <- boot_results_greyzone$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_greyzone$t0[index]
  results_underH0_diff <- bootstrap_replicates_grey[, index] - mean(bootstrap_replicates_grey[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_intermediate[paste0(stat_name), "Dem"] <- round(p_value, 3)
}


#2CPs

f_comp_stats_2cp <- function(data, indices) {
  d <- as.data.frame(data[indices,])
  
  d_lumi <- d %>% filter(greyzone_lumi != 2)
  
  #LUMI
  #Create confusion matrix1
  v_tp=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==1)
  v_fp=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==1)
  v_tn=sum(d_lumi$csf_status==0 & d_lumi$ptau217_spec90_lumi==0)
  v_fn=sum(d_lumi$csf_status==1 & d_lumi$ptau217_spec90_lumi==0)
  
  #Sensitivity and specificity1
  sens <- v_tp / (v_tp + v_fn)
  spec <- v_tn / (v_tn + v_fp)
  
  #Accuracy1
  acc=(v_tp+v_tn)/(v_tp+v_tn+v_fn+v_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  PPV=ppv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  NPV=npv(tp = v_tp,fp = v_fp,
          tn = v_tn,fn = v_fn)
  
  #C2N
  
  d_c2n  <- d %>% filter(greyzone_c2n != 2)
  
  
  #Create confusion matrix1
  c2nv_tp=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_fp=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==1)
  c2nv_tn=sum(d_c2n$csf_status==0 & d_c2n$ptau217_spec90_c2n==0)
  c2nv_fn=sum(d_c2n$csf_status==1 & d_c2n$ptau217_spec90_c2n==0)
  
  #Sensitivity and specificity1
  c2nsens <- c2nv_tp / (c2nv_tp + c2nv_fn)
  c2nspec <- c2nv_tn / (c2nv_tn +c2nv_fp)
  
  #Accuracy1
  c2nacc=(c2nv_tp+c2nv_tn)/(c2nv_tp+c2nv_tn+c2nv_fn+c2nv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nPPV=ppv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  c2nNPV=npv(tp = c2nv_tp,fp = c2nv_fp,
          tn = c2nv_tn,fn = c2nv_fn)
  
  #C2NR 
  d_c2nr <- d %>% filter(greyzone_c2nr != 2)
  
  #Create confusion matrix1
  c2nrv_tp=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_fp=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==1)
  c2nrv_tn=sum(d_c2nr$csf_status==0 & d_c2nr$ptau217_spec90_c2nr==0)
  c2nrv_fn=sum(d_c2nr$csf_status==1 & d_c2nr$ptau217_spec90_c2nr==0)
  
  #Sensitivity and specificity1
  c2nrsens <- c2nrv_tp / (c2nrv_tp + c2nrv_fn)
  c2nrspec <- c2nrv_tn / (c2nrv_tn + c2nrv_fp)
  
  #Accuracy1
  c2nracc=(c2nrv_tp+c2nrv_tn)/(c2nrv_tp+c2nrv_tn+c2nrv_fn+c2nrv_fp)
  
  #Calculate PPV and NPV (cutpointr)1
  c2nrPPV=ppv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  c2nrNPV=npv(tp = c2nrv_tp,fp = c2nrv_fp,
          tn = c2nrv_tn,fn = c2nrv_fn)
  
  ##Different comparisons
  
  ##lumi vs. C2N
  diff_acc_lumi_c2n <- acc - c2nacc
  diff_ppv_lumi_c2n <- PPV - c2nPPV
  diff_npv_lumi_c2n <- NPV - c2nNPV

  ##lumi vs. C2N%
  diff_acc_lumi_c2nr <- acc - c2nracc
  diff_ppv_lumi_c2nr <- PPV - c2nrPPV
  diff_npv_lumi_c2nr <- NPV - c2nrNPV
  
   ##C2n vs. C2N%
  diff_acc_c2n_c2nr <- c2nacc - c2nracc
  diff_ppv_c2n_c2nr <- c2nPPV - c2nrPPV
  diff_npv_c2n_c2nr <- c2nNPV - c2nrNPV
  
  
  return(c(acc, PPV, NPV,c2nacc, c2nPPV, c2nNPV,c2nracc, c2nrPPV, c2nrNPV,diff_acc_lumi_c2n, diff_ppv_lumi_c2n, diff_npv_lumi_c2n,diff_acc_lumi_c2nr, diff_ppv_lumi_c2nr, diff_npv_lumi_c2nr,
           diff_acc_c2n_c2nr, diff_ppv_c2n_c2nr, diff_npv_c2n_c2nr))
}

set.seed(12345)
boot_results_twocutpoints <- boot(data = lumi, statistic = f_comp_stats_2cp, R = 2000)

results_2cp_lumi <- data.frame(
  method = "Lumipulse",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[1], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,1], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[2], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,2], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[3], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[2],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,2], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[1],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,1], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp C2N----
results_2cp_c2n <- data.frame(
  method = "C2N",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[3], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,3], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[4], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,4], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[5], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,5], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[4],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,4], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[3],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,3], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

###Add results 2cp %C2N----
results_2cp_c2nratio <- data.frame(
  method = "C2N%",
  auc1 = NA,
  auc_ci_lower1 = NA,
  auc_ci_upper1 = NA,
  accuracy1 = round(boot_results_twocutpoints$t0[7], 3),
  acc_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[1],3),
  acc_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,7], c(0.025, 0.975))[2],3),
  PPV1 = round(boot_results_twocutpoints$t0[8], 3),
  ppv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[1],3),
  ppv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,8], c(0.025, 0.975))[2],3),
  NPV1 = round(boot_results_twocutpoints$t0[9], 3),
  npv_ci_lower1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[1],3),
  npv_ci_upper1 = round(quantile(boot_results_twocutpoints$t[,9], c(0.025, 0.975))[2],3),
  intermediate_n1 = round(boot_results_greyzone$t0[6],3),
  intermediate_cilow1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[1],3),
  intermediate_cihigh1 = round(quantile(boot_results_greyzone$t[,6], c(0.025, 0.975))[2],3),
  intermediate_n_percentage1= round(boot_results_greyzone$t0[5],3),
  intermediate_n_percentage_low1= round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[1],3),
  intermediate_n_percentage_high1=  round(quantile(boot_results_greyzone$t[,5], c(0.025, 0.975))[2],3),
  stringsAsFactors = FALSE,
  row.names = "2 Cutpoints")

merged_results_2cp <- rbind(results_2cp_lumi, results_2cp_c2n, results_2cp_c2nratio)

##Pvalues 2cp
stat_indices <- list(
  "Accuracy pval Lumi vs. C2N" = 10,
  "PPV pval Lumi vs. C2N" = 11,
  "NPV pval Lumi vs. C2N" = 12,
  "Accuracy pval Lumi vs. %C2N" = 13,
  "PPV pval Lumi vs. %C2N" = 14,
  "NPV pval Lumi vs. %C2N" = 15,
  "Accuracy pval C2N vs. %C2N" = 16,
  "PPV pval C2N vs. %C2N" = 17,
  "NPV pval C2N vs. %C2N" = 18)

pvals_2cp <- data.frame(
  Dem = numeric(length(stat_indices)),
  row.names = c("Accuracy pval Lumi vs. C2N", "PPV pval Lumi vs. C2N", "NPV pval Lumi vs. C2N",
                "Accuracy pval Lumi vs. %C2N", "PPV pval Lumi vs. %C2N", "NPV pval Lumi vs. %C2N",
                "Accuracy pval C2N vs. %C2N", "PPV pval C2N vs. %C2N", "NPV pval C2N vs. %C2N"))

bootstrap_replicates_2cp <- boot_results_twocutpoints$t

for (stat_name in names(stat_indices)) {
  index <- stat_indices[[stat_name]]
  boot_diff <- boot_results_twocutpoints$t0[index]
  results_underH0_diff <- bootstrap_replicates_2cp[, index] - mean(bootstrap_replicates_2cp[, index])
  p_value <- mean(abs(results_underH0_diff) >= abs(boot_diff))
  pvals_2cp[paste0(stat_name), "Dem"] <- round(p_value, 3)
}

merged_comps_dem <- rbind(merged_results_1cp, merged_results_2cp)
merged_comps_dem$Cutpoints <- c("1 Cutpoint","1 Cutpoint","1 Cutpoint","2 Cutpoints","2 Cutpoints","2 Cutpoints")
openxlsx::write.xlsx(merged_comps_dem,file="C2Ncomp_Dem.xlsx", rowNames =T)

pvalues_dem <- rbind(
  pvals_1cp,
  pvals_intermediate,
  pvals_2cp
)
openxlsx::write.xlsx(pvalues_dem,file="C2Ncomp_Dem_pvals.xlsx", rowNames =T)
```

###Figure Dem
```{r Dem Fig 1cp, echo=F}
merged_comps_scd <- read_xlsx("C2Ncomp_Dem.xlsx")

plot_auc <- cbind(merged_comps_scd[0:3, 3:5])
colnames(plot_auc) <- c("Measure1", "ci_low", "ci_high")
plot_auc$Measure <- c("AUC", "AUC", "AUC")
plot_auc$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_auc$Cutpoint <- c("1", "1","1")

plot_acc <- cbind(merged_comps_scd[0:6, 6:8])
colnames(plot_acc) <- c("Measure1", "ci_low", "ci_high")
plot_acc$Measure <- c("Accuracy", "Accuracy", "Accuracy","Accuracy", "Accuracy", "Accuracy")
plot_acc$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_acc$Cutpoint <- c("1", "1","1", "2","2", "2")

plot_ppv <- cbind(merged_comps_scd[0:6, 9:11])
colnames(plot_ppv) <- c("Measure1", "ci_low", "ci_high")
plot_ppv$Measure <- c("PPV", "PPV", "PPV","PPV", "PPV", "PPV")
plot_ppv$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_ppv$Cutpoint <- c("1", "1","1", "2","2", "2")

plot_npv <- cbind(merged_comps_scd[0:6, 12:14])
colnames(plot_npv) <- c("Measure1", "ci_low", "ci_high")
plot_npv$Measure <- "NPV"
plot_npv$Assay <- c("Lumipulse", "C2N", "C2N%","Lumipulse", "C2N", "C2N%")
plot_npv$Cutpoint <- c("1", "1","1", "2","2", "2")

plotdata <- rbind(plot_auc, plot_acc, plot_ppv, plot_npv)
plotdata <- rbind(plot_acc, plot_ppv, plot_npv)
plotdata <- plotdata %>% filter(Cutpoint == "1")

group_order <- c("NPV", "PPV", "Accuracy")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(10, 100, by = 10)
plotdata$Cutpoint <- as.factor(as.character(plotdata$Cutpoint))

ggplot(data=plotdata, aes(y = factor(Measure, levels=group_order), x = Measure1 * 100, shape=factor(Assay, levels=desired_order))) +
  geom_vline(xintercept = tick_positions, color = "grey80", linewidth = 0.5, alpha=0.5) +
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.2, linewidth = 0.5, position = position_dodge(width = 0.8),color="#4DBBD5FF", fill="#4DBBD5FF") +
  geom_point(position = position_dodge(width = 0.8), size = 4, stroke = 0.5, color="#4DBBD5FF", fill="#4DBBD5FF") +
  scale_x_continuous(limits=c(70,124),breaks = seq(70,124, by=10),expand =c(0,0))+
  labs(x = "Percentage", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), group=factor(Assay,levels=desired_order), x=94), 
            position = position_dodge(width = 0.8), hjust = -0.3, size = 3, color = "black") +
  scale_shape_manual(values = c("Lumipulse"=21, "C2N"=22,"C2N%"=24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),  # Decrease legend text size
        legend.title = element_text(size = 8))
ggsave("C2Ncomps__Dem_1cp.pdf",device = "pdf",width = 90, dpi=500, height = 60, units = "mm")
```

```{r Dem Fig 2cp, echo=F, eval=F}
merged_comps_scd <- read_xlsx("C2Ncomp_Dem.xlsx")
merged_comps_scd<- merged_comps_scd[,2:21]

plot_acc <- cbind(merged_comps_scd[4:6, 5:7])
colnames(plot_acc) <- c("Measure1", "ci_low", "ci_high")
plot_acc$Measure <- c("Accuracy", "Accuracy", "Accuracy")
plot_acc$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_ppv <- cbind(merged_comps_scd[4:6, 8:10])
colnames(plot_ppv) <- c("Measure1", "ci_low", "ci_high")
plot_ppv$Measure <- c("PPV", "PPV", "PPV")
plot_ppv$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_npv <- cbind(merged_comps_scd[4:6, 11:13])
colnames(plot_npv) <- c("Measure1", "ci_low", "ci_high")
plot_npv$Measure <- c("NPV", "NPV", "NPV")
plot_npv$Assay <- c("Lumipulse", "C2N", "C2N%")

plot_grey_scd <- cbind(merged_comps_scd[4:6, 17:19])
colnames(plot_grey_scd) <- c("Measure1", "ci_low", "ci_high")
plot_grey_scd$Measure <- c("SCD")

plotdata <- rbind(plot_acc, plot_ppv, plot_npv)

group_order <- c("NPV", "PPV", "Accuracy")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(10, 100, by = 10)

ggplot(data=plotdata, aes(y = factor(Measure, levels=group_order), x = Measure1 * 100, shape=factor(Assay, levels=desired_order))) +
  geom_vline(xintercept = tick_positions, color = "grey80", linewidth = 0.5, alpha=0.5) +
  geom_errorbar(aes(xmin = ci_low * 100, xmax = ci_high * 100),
                width = 0.2, linewidth = 0.5, position = position_dodge(width = 0.8),color="#E64B35FF", fill="#E64B35FF") +
  geom_point(position = position_dodge(width = 0.8), size = 4, stroke = 0.5, color="#E64B35FF", fill="#E64B35FF") +
  scale_x_continuous(limits=c(70,124),breaks = seq(70,124, by=10),expand =c(0,0))+
  labs(x = "Percentage", y = "") +
  geom_text(aes(label = sprintf("%.f (%.f-%.f)", Measure1 * 100, ci_low * 100, ci_high * 100), group=factor(Assay,levels=desired_order), x=94), 
            position = position_dodge(width = 0.8), hjust = -0.3, size = 3, color = "black") +
  scale_shape_manual(values = c("Lumipulse"=21, "C2N"=22,"C2N%"=24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),  
        legend.title = element_text(size = 8))
ggsave("C2Ncomps__Dem_2cp.pdf",device = "pdf",width = 90, dpi=500, height = 60, units = "mm")

```

##AUC plot
```{r AUC all, echo=F}
merged_comps_scd <- read_xlsx("C2Ncomp_SCD.xlsx")
plot_auc_scd <- cbind(merged_comps_scd[0:3, 3:5])
colnames(plot_auc_scd) <- c("Measure1", "ci_low", "ci_high")
plot_auc_scd$Measure <- c("AUC", "AUC", "AUC")
plot_auc_scd$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_auc_scd$Cutpoint <- c("1", "1","1")
plot_auc_scd$Cog <- c("SCD", "SCD", "SCD")


merged_comps_mci <- read_xlsx("C2Ncomp_MCI.xlsx")
plot_auc_mci <- cbind(merged_comps_mci[0:3, 3:5])
colnames(plot_auc_mci) <- c("Measure1", "ci_low", "ci_high")
plot_auc_mci$Measure <- c("AUC", "AUC", "AUC")
plot_auc_mci$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_auc_mci$Cutpoint <- c("1", "1","1")
plot_auc_mci$Cog <- c("MCI", "MCI", "MCI")


merged_comps_dem <- read_xlsx("C2Ncomp_Dem.xlsx")
plot_auc_dem <- cbind(merged_comps_dem[0:3, 3:5])
colnames(plot_auc_dem) <- c("Measure1", "ci_low", "ci_high")
plot_auc_dem$Measure <- c("AUC", "AUC", "AUC")
plot_auc_dem$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_auc_dem$Cutpoint <- c("1", "1","1")
plot_auc_dem$Cog <- c("Dementia", "Dementia", "Dementia")

plot_auc <- rbind(plot_auc_scd, plot_auc_mci, plot_auc_dem)

group_order <- c("Dementia", "MCI", "SCD")
desired_order <- c("C2N%", "C2N", "Lumipulse")
tick_positions <- seq(0.10, 1, by = 0.05)
plot_auc$Cog <- as.factor(as.character(plot_auc$Cog))
plot_auc$Assay <- as.factor(as.character(plot_auc$Assay))

ggplot(data=plot_auc, aes(y = factor(Cog, levels=group_order), x = Measure1, shape=factor(Assay, levels=desired_order))) +
  geom_vline(xintercept = tick_positions, color = "grey80", linewidth = 0.5, alpha=0.5) +
  geom_errorbar(aes(xmin = ci_low, xmax = ci_high),
                width = 0.2, linewidth = 0.5, position = position_dodge(width = 0.8),color="#3C5488FF", fill="#3C5488FF") +
  geom_point(position = position_dodge(width = 0.8), size = 4, stroke = 0.5, color="#3C5488FF", fill="#3C5488FF") +
  scale_x_continuous(limits=c(0.8,1.1),breaks = seq(0.8,1.1, by=0.05),expand =c(0,0))+
  labs(x = "Percentage", y = "") +
  geom_text(aes(label = sprintf("%.2f (%.2f-%.2f)", Measure1, ci_low , ci_high), group=factor(Assay,levels=desired_order), x=1),position = position_dodge(width = 0.8), hjust = -0.3, size = 3, color = "black") +
  scale_shape_manual(values = c("Lumipulse"=21, "C2N"=22,"C2N%"=24), guide="none") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(face = "bold"),
        legend.text = element_text(size = 8),  # Decrease legend text size
        legend.title = element_text(size = 8))
ggsave("C2Ncomps_AUC.pdf",device = "pdf",width = 90, dpi=500, height = 60, units = "mm")

```

###Intermediate figure
```{r Intermediate all, echo=F}
merged_comps_scd <- read_xlsx("C2Ncomp_SCD.xlsx")
plot_scd <- cbind(merged_comps_scd[4:6, 18:20])
colnames(plot_scd) <- c("Measure1", "ci_low", "ci_high")
plot_scd$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_scd$Cog <- c("SCD", "SCD", "SCD")

merged_comps_mci <- read_xlsx("~C2Ncomp_MCI.xlsx")
plot_mci <- cbind(merged_comps_mci[4:6, 18:20])
colnames(plot_mci) <- c("Measure1", "ci_low", "ci_high")
plot_mci$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_mci$Cog <- c("MCI", "MCI", "MCI")

merged_comps_dem <- read_xlsx("C2Ncomp_Dem.xlsx")
plot_dem <- cbind(merged_comps_dem[4:6, 18:20])
colnames(plot_dem) <- c("Measure1", "ci_low", "ci_high")
plot_dem$Assay <- c("Lumipulse", "C2N", "C2N%")
plot_dem$Cog <- c("Dementia", "Dementia", "Dementia")

plot_grey <- rbind(plot_scd, plot_mci, plot_dem)

group_order <- c("SCD", "MCI", "Dementia")
desired_order <- c("Lumipulse", "C2N", "C2N%")
plot_grey$Cog <- as.factor(as.character(plot_grey$Cog))
plot_grey$Assay <- as.factor(as.character(plot_grey$Assay))
library(ggpattern)

ggplot(data = plot_grey, aes(x = factor(Cog, levels = group_order),  y = Measure1, pattern = factor(Assay, levels = desired_order))) +
  geom_bar_pattern(stat = "identity",position = position_dodge(width = 0.7), fill = "#3c5488ff", color="black",
                   width = 0.7, pattern_fill = "white",
                   pattern_color = "white", pattern_density = 0.45,
                   size = 0.4) +
  geom_errorbar(aes(ymax = ci_high, ymin = ci_low),position = position_dodge(width = 0.7), 
                width = 0.2, size = 0.5, color = "black") +
  geom_text(aes(label = sprintf("%.f", Measure1)), position = position_dodge(width = 0.7), 
            vjust = -4, size = 4) +
  scale_y_continuous(limits = c(0, 25), breaks = seq(0, 25, by = 5),  expand = c(0, 0)) +
  scale_pattern_manual(values = c("stripe", "none", "circle"), 
                       labels = c("p-tau217 Lumipulse", "p-tau217 C2N", "%p-tau217 C2N"), guide="none") +
  labs(title = element_blank(), 
       x = "", 
       y = "Intermediate values (%)") +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1, face = "bold"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(face = "bold", size = 10),
    panel.border = element_rect(linewidth = 0.5, fill = NA, color = NA),
    legend.title = element_blank()
  )

ggsave("Int_2cp.pdf",device = "pdf",width = 70, dpi=500, height = 70, units = "mm")
```
